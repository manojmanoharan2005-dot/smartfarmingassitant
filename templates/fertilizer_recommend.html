{% extends "base.html" %}

{% block title %}Fertilizer Recommendation - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/crop.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/fertilizer.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
	<!-- Sidebar -->
	<div class="sidebar">
		<div class="sidebar-header">
			<div class="logo">
				<span class="logo-icon">ğŸŒ¾</span>
				<span class="logo-text">Farming Assistant</span>
			</div>
			<p class="subtitle">Smart Agriculture Platform</p>
		</div>
		<div class="welcome-section">
			<p class="welcome-label">Welcome back,</p>
			<h3 class="welcome-name">{{ user_name or "Farmer" }}! ğŸ‘‹</h3>
		</div>
		<nav class="sidebar-nav">
			<a href="{{ url_for('dashboard.dashboard') }}" class="nav-item">
				<span class="nav-icon">ğŸ“Š</span>
				<span class="nav-text">Dashboard</span>
			</a>
			<a href="{{ url_for('crop.crop_suggestion') }}" class="nav-item">
				<span class="nav-icon">ğŸŒ±</span>
				<span class="nav-text">Crop Suggestion</span>
			</a>
			<a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-item active">
				<span class="nav-icon">ğŸ§ª</span>
				<span class="nav-text">Fertilizer Advice</span>
			</a>
			<a href="{{ url_for('market.market_watch') }}" class="nav-item">
				<span class="nav-icon">ğŸ“ˆ</span>
				<span class="nav-text">Market Watch</span>
			</a>
		</nav>
	</div>

	<!-- Green Header Section -->
	<div class="dashboard-header">        
		<div class="header-content">
			<div class="header-left">
				<h1>AI-Powered Fertilizer Recommendation</h1>
				<p>Get tailored fertilizer suggestions based on crop and soil test results</p>
			</div>
			<div class="header-right">
				<span class="header-date">ğŸ“… {{ current_date or "Today" }}</span>
				<button class="logout-button" onclick="window.location.href='{{ url_for('auth.logout') }}'">Logout</button>
			</div>
		</div>
	</div>

	<!-- Main Content Area -->
	<div class="main-content">
		<!-- Content Panel -->
		<div class="content-panel">
			<!-- Fertilizer Form Card -->
			<div class="fertilizer-form-card">
				<div class="form-header fertilizer-header">
					<div class="icon-wrapper">
						<span class="filter-icon">ğŸ§ª</span>
					</div>
					<div class="form-title">
						<h2>Smart Fertilizer Recommendation System</h2>
						<p>Enter soil results and crop info to get fertilizer suggestions</p>
					</div>
				</div>

				<form method="POST" class="crop-form">
					<div class="form-sections">
						<!-- Soil Test Results Section -->
						<div class="form-section">
							<h3 class="section-title">
								<span class="section-icon">ğŸ§ª</span>
								Soil Nutrients (kg/ha)
							</h3>
							<div class="input-grid">
								<div class="input-group">
									<label for="nitrogen">Nitrogen (N):</label>
									<input id="nitrogen" name="nitrogen" type="number" step="0.01" required value="{{ input_data.nitrogen if input_data else '' }}" placeholder="70">
									<small>Range: 0-140 kg/ha (Avg: 70)</small>
								</div>
								<div class="input-group">
									<label for="phosphorous">Phosphorus (P):</label>
									<input id="phosphorous" name="phosphorous" type="number" step="0.01" required value="{{ input_data.phosphorous if input_data else '' }}" placeholder="80">
									<small>Range: 5-145 kg/ha (Avg: 80)</small>
								</div>
								<div class="input-group">
									<label for="potassium">Potassium (K):</label>
									<input id="potassium" name="potassium" type="number" step="0.01" required value="{{ input_data.potassium if input_data else '' }}" placeholder="100">
									<small>Range: 5-205 kg/ha (Avg: 100)</small>
								</div>
							</div>
						</div>

						<!-- Soil Properties Section -->
						<div class="form-section">
							<h3 class="section-title">
								<span class="section-icon">ğŸŒ±</span>
								Soil Properties
							</h3>
							<div class="input-grid">
								<div class="input-group">
									<label for="ph">pH Level:</label>
									<input id="ph" name="ph" type="number" step="0.1" min="0" max="14" required value="{{ input_data.ph if input_data else '6.5' }}" placeholder="6.5">
									<small>Range: 3.5-9.9 (Avg: 6.5)</small>
								</div>
								<div class="input-group">
									<label for="carbon">Carbon Content (%):</label>
									<input id="carbon" name="carbon" type="number" step="0.1" required value="{{ input_data.carbon if input_data else '1.5' }}" placeholder="1.5">
									<small>Range: 0.5-5.0% (Avg: 1.5%)</small>
								</div>
								<div class="input-group">
									<label for="soil">Soil Type:</label>
									<select id="soil" name="soil" required>
										<option value="">Choose soil type</option>
										{% if available_soils %}
											{% for soil in available_soils %}
											<option value="{{ soil }}" {% if input_data and input_data.soil==soil %}selected{% endif %}>{{ soil }}</option>
											{% endfor %}
										{% else %}
											<option value="Loamy Soil">Loamy Soil</option>
											<option value="Peaty Soil">Peaty Soil</option>
											<option value="Acidic Soil">Acidic Soil</option>
											<option value="Alkaline Soil">Alkaline Soil</option>
											<option value="Neutral Soil">Neutral Soil</option>
										{% endif %}
									</select>
									<small>Select your soil type</small>
								</div>
							</div>
						</div>

						<!-- Crop & Environment Section -->
						<div class="form-section">
							<h3 class="section-title">
								<span class="section-icon">ğŸŒ¾</span>
								Crop & Environmental Conditions
							</h3>
							<div class="input-grid">
								<div class="input-group">
									<label for="crop_type">Crop Type:</label>
									<select id="crop_type" name="crop_type" required>
										<option value="">Choose a crop</option>
										{% if available_crops %}
											{% for crop in available_crops %}
											<option value="{{ crop }}" {% if input_data and input_data.crop_type==crop %}selected{% endif %}>{{ crop|title }}</option>
											{% endfor %}
										{% else %}
											<optgroup label="Cereals">
												<option value="rice">Rice</option>
												<option value="wheat">Wheat</option>
												<option value="maize">Maize / Corn</option>
												<option value="barley">Barley</option>
												<option value="sorghum">Sorghum</option>
												<option value="millet">Millet</option>
											</optgroup>
											<optgroup label="Pulses & Legumes">
												<option value="chickpea">Chickpea</option>
												<option value="lentil">Lentil</option>
												<option value="kidney_beans">Kidney Beans</option>
												<option value="black_gram">Black Gram</option>
												<option value="mung_bean">Mung Bean</option>
												<option value="pigeon_peas">Pigeon Peas</option>
												<option value="soybean">Soybean</option>
											</optgroup>
											<optgroup label="Cash Crops">
												<option value="cotton">Cotton</option>
												<option value="jute">Jute</option>
												<option value="sugarcane">Sugarcane</option>
												<option value="tobacco">Tobacco</option>
												<option value="coffee">Coffee</option>
												<option value="tea">Tea</option>
											</optgroup>
											<optgroup label="Vegetables">
												<option value="potato">Potato</option>
												<option value="tomato">Tomato</option>
												<option value="onion">Onion</option>
												<option value="cabbage">Cabbage</option>
												<option value="cauliflower">Cauliflower</option>
												<option value="carrot">Carrot</option>
												<option value="brinjal">Brinjal / Eggplant</option>
												<option value="okra">Okra / Lady Finger</option>
												<option value="pepper">Pepper</option>
												<option value="cucumber">Cucumber</option>
											</optgroup>
											<optgroup label="Fruits">
												<option value="banana">Banana</option>
												<option value="mango">Mango</option>
												<option value="apple">Apple</option>
												<option value="orange">Orange</option>
												<option value="grapes">Grapes</option>
												<option value="pomegranate">Pomegranate</option>
												<option value="papaya">Papaya</option>
												<option value="watermelon">Watermelon</option>
											</optgroup>
											<optgroup label="Spices">
												<option value="turmeric">Turmeric</option>
												<option value="ginger">Ginger</option>
												<option value="garlic">Garlic</option>
												<option value="chili">Chili</option>
												<option value="coriander">Coriander</option>
											</optgroup>
										{% endif %}
									</select>
									<small>Select crop to grow</small>
								</div>
								<div class="input-group">
									<label for="temperature">Temperature:</label>
									<input id="temperature" name="temperature" type="number" step="0.01" required value="{{ input_data.temperature if input_data else '' }}" placeholder="25.5">
									<small>Range: 8-44Â°C (Avg: 26Â°C)</small>
								</div>
								<div class="input-group">
									<label for="moisture">Moisture:</label>
									<input id="moisture" name="moisture" type="number" step="0.01" min="0" max="1" required value="{{ input_data.moisture if input_data else '' }}" placeholder="0.7">
									<small>Range: 0-1 (Avg: 0.7)</small>
								</div>
								<div class="input-group">
									<label for="rainfall">Rainfall (mm):</label>
									<input id="rainfall" name="rainfall" type="number" step="0.1" required value="{{ input_data.rainfall if input_data else '200' }}" placeholder="200">
									<small>Range: 20-300mm (Avg: 100mm)</small>
								</div>
							</div>
						</div>
					</div>

					<div class="form-actions">
						<button type="submit" class="submit-btn">ğŸ”® Get AI Fertilizer Recommendations</button>
					</div>
				</form>
			</div>

			<!-- Conditional results -->
			{% if recommendations %}
			<div class="crop-results-section">
				<div class="results-header">
					<div class="header-icon">ğŸ§¾</div>
					<div class="header-content">
						<h2>Recommended Fertilizers</h2>
						<p>Suggestions for <strong>{{ input_data.crop_type|capitalize }}</strong> (soil moisture: {{ input_data.soil_moisture }}%)</p>
					</div>
				</div>

				<div class="crop-cards-grid">
					{% for fert in recommendations %}
					<div class="fertilizer-card {{ 'high-priority' if fert.priority == 'High' else 'medium-priority' if fert.priority == 'Medium' else 'low-priority' }}">
						<div class="crop-header">
							<h3>{{ fert.name }}</h3>
							<span class="priority-badge {{ fert.priority.lower() }}">{{ fert.priority }}</span>
						</div>
						<div class="crop-details">
							<div class="detail-item"><span class="icon">âš–ï¸</span><span class="label">Dosage</span><span class="value">{{ fert.dosage }}</span></div>
							<div class="detail-item"><span class="icon">ğŸ“ˆ</span><span class="label">Effectiveness</span><span class="value">{{ "%.0f"|format(fert.confidence_percentage) }}%</span></div>
							<div class="detail-item"><span class="icon">ğŸ“</span><span class="label">Use</span><span class="value">{{ fert.usage }}</span></div>
							<div class="detail-item"><span class="icon">ğŸ’¡</span><span class="label">Notes</span><span class="value">{{ fert.note }}</span></div>
						</div>
						<div class="card-actions">
							<form method="POST" action="{{ url_for('fertilizer.save_fertilizer') }}" style="display:inline;">
								<input type="hidden" name="fertilizer_name" value="{{ fert.name }}">
								<input type="hidden" name="crop_type" value="{{ input_data.crop_type }}">
								<input type="hidden" name="priority" value="{{ fert.priority }}">
								<input type="hidden" name="dosage" value="{{ fert.dosage }}">
								<input type="hidden" name="usage" value="{{ fert.usage }}">
								<input type="hidden" name="note" value="{{ fert.note }}">
								<input type="hidden" name="confidence" value="{{ fert.confidence_percentage }}">
								<button type="submit" class="btn-start">ğŸ’¾ Save</button>
							</form>
							<button class="btn-outline" onclick="viewFertilizerDetails('{{ fert.name }}')">ğŸ“„ Details</button>
						</div>
					</div>
					{% endfor %}
				</div>

				<div class="recommendation-summary">
					<div class="summary-card">
						<h3>ğŸ“Š Summary</h3>
						<div class="summary-stats">
							<div class="stat"><span class="stat-value">{{ recommendations|length }}</span><span class="stat-label">Fertilizers</span></div>
							<div class="stat"><span class="stat-value">{{ recommendations[0].name }}</span><span class="stat-label">Top Recommendation</span></div>
							<div class="stat"><span class="stat-value">{{ "%.0f"|format(recommendations[0].confidence_percentage) }}%</span><span class="stat-label">Confidence</span></div>
						</div>
					</div>
				</div>
			</div>
			{% endif %}
			<!-- end conditional -->
		</div>
	</div>
</div>

<script>
// Average autofill values
const averageValues = {
	nitrogen: 70,
	phosphorous: 80,
	potassium: 100,
	ph: 6.5,
	carbon: 1.5,
	temperature: 25,
	moisture: 0.7,
	rainfall: 200
};

function autofillAllFields() {
	Object.keys(averageValues).forEach(k => {
		const el = document.getElementById(k);
		if (el) el.value = averageValues[k];
	});
	highlightFields(Object.keys(averageValues));
	showNotification('âœ¨ Autofilled average values');
}

function clearAllFields() {
	['nitrogen','phosphorous','potassium','ph','carbon','temperature','moisture','rainfall'].forEach(id => {
		const el = document.getElementById(id);
		if (el) el.value = '';
	});
	showNotification('ğŸ—‘ï¸ Cleared input fields');
}

function highlightFields(fieldNames) {
	fieldNames.forEach(fieldName => {
		const field = document.getElementById(fieldName);
		if (field) {
			field.style.borderColor = '#7c4dff';
			field.style.backgroundColor = '#fbf6ff';
			setTimeout(() => {
				field.style.borderColor = '';
				field.style.backgroundColor = '';
			}, 1800);
		}
	});
}

function showNotification(message) {
	const notification = document.createElement('div');
	notification.className = 'autofill-notification';
	notification.textContent = message;
	notification.style.cssText = 'position:fixed;top:18px;right:18px;background:#7c4dff;color:#fff;padding:10px 14px;border-radius:8px;z-index:2000';
	document.body.appendChild(notification);
	setTimeout(()=>notification.remove(),2800);
}

function viewFertilizerDetails(name) {
	alert('Details for ' + name + '. Follow local extension guidance for application.');
}
</script>
{% endblock %}
