{% extends "base.html" %}

{% block title %}Dashboard - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/api/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Premium Notification Modal Styling */
    #notificationModal .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        animation: modalFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(20px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .notif-header {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        padding: 24px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .notif-title {
        color: white;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .notif-item {
        padding: 20px;
        border-radius: 16px;
        background: white;
        border: 1px solid #f1f5f9;
        transition: all 0.3s ease;
        margin-bottom: 12px;
        display: flex;
        gap: 18px;
        position: relative;
        overflow: hidden;
    }

    .notif-item:hover {
        transform: translateX(8px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
        border-color: #3b82f6;
    }

    .notif-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #3b82f6;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .notif-item:hover::before {
        opacity: 1;
    }

    .notif-icon-box {
        width: 52px;
        height: 52px;
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        transition: transform 0.3s ease;
    }

    .notif-item:hover .notif-icon-box {
        transform: rotate(-10deg) scale(1.1);
    }

    .notif-content-title {
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
        font-size: 15px;
    }

    .notif-content-msg {
        font-size: 14px;
        color: #64748b;
        line-height: 1.5;
    }

    .notif-time {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .notif-action-bar {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .notif-btn-primary {
        padding: 8px 20px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .notif-btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }

    .notif-btn-secondary {
        padding: 8px 20px;
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .notif-btn-secondary:hover {
        background: #e2e8f0;
    }

    /* Download Modal Styling */
    .download-option-card {
        padding: 16px;
        border-radius: 16px;
        background: white;
        border: 1px solid #f1f5f9;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        margin-bottom: 12px;
    }

    .download-option-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.05);
        border-color: #10b981;
    }

    .download-icon-box {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .download-main-info {
        flex: 1;
    }

    .download-main-title {
        font-weight: 700;
        color: #1e293b;
        font-size: 15px;
        margin-bottom: 2px;
    }

    .download-main-desc {
        font-size: 12px;
        color: #64748b;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üåæ</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Tools</div>
                <a href="#" class="nav-link" onclick="openCalculatorModal(); return false;">
                    <i class="fas fa-calculator"></i>
                    <span>Expense Calculator</span>
                </a>
                <a href="#" class="nav-link" onclick="openWeatherModal(); return false;">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Weather Forecast</span>
                </a>
                <a href="#" class="nav-link" onclick="openGovtSchemesModal(); return false;">
                    <i class="fas fa-landmark"></i>
                    <span>Govt. Schemes</span>
                </a>
                <a href="#" class="nav-link" onclick="openEquipmentModal(); return false;">
                    <i class="fas fa-truck-pickup"></i>
                    <span>Equipment Sharing</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-info" onclick="openProfileModal()" style="cursor: pointer;">
                <div class="user-avatar">{{ user_name[0] if user_name else 'U' }}</div>
                <div class="user-details">
                    <h4>{{ user_name }}</h4>
                    <span>Farmer</span>
                </div>
                <i class="fas fa-chevron-right" style="margin-left: auto; opacity: 0.5; font-size: 12px;"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Hero Header -->
        <div class="hero-header">
            <div class="hero-content">
                <div class="welcome-text">
                    <i class="fas fa-sun"></i> Good {{ 'Morning' if current_hour < 12 else ('Afternoon' if current_hour
                        < 17 else 'Evening' ) }}! </div>
                        <h1 class="hero-title">Welcome to Smart Farming</h1>
                        <p class="hero-subtitle">Your personalized agricultural assistant. Monitor crops, get
                            recommendations, and maximize your yields.</p>
                </div>
                <div class="hero-date">
                    <div class="day">{{ current_day }}</div>
                    <div class="month-year">{{ current_month }} {{ current_year }}</div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.total_recommendations }}</h4>
                        <span>Recommendations</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon blue">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.active_crops }}</h4>
                        <span>Active Crops</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon purple">
                        <i class="fas fa-flask"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.fertilizers_saved }}</h4>
                        <span>Fertilizers Saved</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon orange">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.crops_suggested }}</h4>
                        <span>Crops Suggested</span>
                    </div>
                </div>
                <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                    <!-- Download Report Button -->
                    <button class="download-report-btn" onclick="openDownloadModal()" title="Download Reports"
                        style="width: 44px; height: 44px; font-size: 18px; background: rgba(16, 185, 129, 0.15); color: #10b981; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
                        <i class="fas fa-file-download"></i>
                    </button>

                    <!-- Notification Button -->
                    <button class="notification-toggle-btn" onclick="toggleNotificationPanel()"
                        style="width: 44px; height: 44px; font-size: 18px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease;">
                        <i class="fas fa-bell"></i>
                        {% if notifications %}
                        <span
                            style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid #1a1c1e; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);">{{
                            notifications|length }}</span>
                        {% endif %}
                    </button>

                    <button class="chatbot-toggle" onclick="openChatbotModal()"
                        style="width: 44px; height: 44px; font-size: 18px;">
                        <i class="fas fa-robot"></i>
                    </button>
                    <a href="{{ url_for('auth.logout') }}"
                        style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 12px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <div class="dashboard-grid">
                    <!-- Left Column - Live Commodity Feed for User's District -->
                    <div class="left-column">
                        <div class="card card-dark">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-line"></i> Live Commodity Feed
                                </div>
                                <span class="card-badge">Live</span>
                            </div>
                            <div class="card-body">
                                {% if user and user.district %}
                                <div
                                    style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-map-marker-alt"></i> {{ user.district }}, {{ user.state }}
                                </div>
                                {% endif %}
                                <div class="commodity-list">
                                    {% if price_predictions %}
                                    {% for pred in price_predictions[:5] %}
                                    <div class="commodity-item">
                                        <div class="commodity-info">
                                            <div class="commodity-icon"
                                                style="background: linear-gradient(135deg, {% if pred.commodity == 'Potato' %}#f59e0b{% elif pred.commodity == 'Tomato' %}#ef4444{% elif pred.commodity == 'Onion' %}#a855f7{% elif pred.commodity == 'Carrot' %}#f97316{% elif pred.commodity == 'Cabbage' %}#22c55e{% else %}#3b82f6{% endif %}, {% if pred.commodity == 'Potato' %}#d97706{% elif pred.commodity == 'Tomato' %}#dc2626{% elif pred.commodity == 'Onion' %}#9333ea{% elif pred.commodity == 'Carrot' %}#ea580c{% elif pred.commodity == 'Cabbage' %}#16a34a{% else %}#2563eb{% endif %});">
                                                {% if pred.commodity == 'Potato' %}ü•î
                                                {% elif pred.commodity == 'Tomato' %}üçÖ
                                                {% elif pred.commodity == 'Onion' %}üßÖ
                                                {% elif pred.commodity == 'Carrot' %}ü•ï
                                                {% elif pred.commodity == 'Cabbage' %}ü•¨
                                                {% elif pred.commodity == 'Banana' %}üçå
                                                {% elif pred.commodity == 'Mango' %}ü•≠
                                                {% else %}üåæ{% endif %}
                                            </div>
                                            <div>
                                                <div class="commodity-name">{{ pred.commodity }}</div>
                                                <div class="commodity-location">{{ pred.market or user.district }}</div>
                                                <a href="javascript:void(0)" class="trend-link"
                                                    onclick="viewTrend('{{ pred.commodity }}')">
                                                    <i class="fas fa-chart-line"></i> View Trend
                                                </a>
                                            </div>
                                        </div>
                                        <div class="commodity-price">
                                            <div class="price-value">‚Çπ{{ pred.current_price_kg }}/kg</div>
                                            <div
                                                class="price-change {{ 'up' if pred.trend == 'increase' else 'down' if pred.trend == 'decrease' else '' }}">
                                                {% if pred.trend == 'increase' %}
                                                <i class="fas fa-arrow-up"></i> {{ pred.change_percent }}%
                                                {% elif pred.trend == 'decrease' %}
                                                <i class="fas fa-arrow-down"></i> {{ pred.change_percent }}%
                                                {% else %}
                                                <span style="color: rgba(255,255,255,0.5);">‚Üî {{ pred.change_percent
                                                    }}%</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% elif market_prices %}
                                    {% for price in market_prices[:5] %}
                                    <div class="commodity-item">
                                        <div class="commodity-info">
                                            <div class="commodity-icon">
                                                {% if price.commodity in ['Tomato'] %}üçÖ
                                                {% elif price.commodity in ['Potato'] %}ü•î
                                                {% elif price.commodity in ['Onion'] %}üßÖ
                                                {% elif price.commodity in ['Carrot'] %}ü•ï
                                                {% elif price.commodity in ['Cabbage'] %}ü•¨
                                                {% elif price.commodity in ['Apple', 'Banana', 'Mango', 'Orange'] %}üçé
                                                {% else %}üåæ{% endif %}
                                            </div>
                                            <div>
                                                <div class="commodity-name">{{ price.commodity }}</div>
                                                <div class="commodity-location">{{ price.district }}</div>
                                                <a href="javascript:void(0)" class="trend-link"
                                                    onclick="viewTrend('{{ price.commodity }}')">
                                                    <i class="fas fa-chart-line"></i> View Trend
                                                </a>
                                            </div>
                                        </div>
                                        <div class="commodity-price">
                                            <div class="price-value">‚Çπ{{ price.price }}/kg</div>
                                            <div class="price-change {{ 'up' if price.change > 0 else 'down' }}">
                                                <i class="fas fa-arrow-{{ 'up' if price.change > 0 else 'down' }}"></i>
                                                {{ price.change }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
                                        <i class="fas fa-chart-bar"
                                            style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                                        <p style="margin: 0;">No market data available for your district yet.</p>
                                        <p style="margin: 4px 0 0 0; font-size: 12px;">Update your profile with your
                                            district to see live prices.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <a href="{{ url_for('market.market_watch') }}" class="view-all-link">
                                View All Prices <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>


                    </div>

                    <!-- Middle Column -->
                    <div class="middle-column">
                        <!-- Market Price Trend Analysis -->
                        <div class="card card-dark" id="trend-card">
                            <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                                <div class="card-title">
                                    <i class="fas fa-chart-line"></i> Market Price Trend
                                </div>
                                <div class="commodity-selector" style="flex: 1; min-width: 150px;">
                                    <select id="commodity-select"
                                        style="width: 100%; padding: 4px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 11px; outline: none; cursor: pointer;"
                                        onchange="if(this.value) { loadPriceTrend(this.value); }">
                                        <option value="" disabled selected>Select Crop...</option>
                                    </select>
                                </div>
                                <div class="trend-periods" style="display: flex; gap: 8px;">
                                    <button
                                        onclick="loadPriceTrend(document.getElementById('trend-commodity-name').textContent, 7)"
                                        class="period-btn active" id="btn-7d">7D</button>
                                    <button
                                        onclick="loadPriceTrend(document.getElementById('trend-commodity-name').textContent, 30)"
                                        class="period-btn" id="btn-30d">30D</button>
                                </div>
                            </div>
                            <div class="card-body" style="padding: 15px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div>
                                        <h3 id="trend-commodity-name" style="margin: 0; font-size: 18px; color: white;">
                                            Tomato</h3>
                                        <div id="trend-location-info"
                                            style="font-size: 11px; color: rgba(255,255,255,0.5);">Price analysis in {{
                                            user.district }}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div
                                            style="display: flex; align-items: center; gap: 6px; justify-content: flex-end;">
                                            <i id="trend-direction-icon" class="fas fa-arrow-trend-up"
                                                style="color: #10b981;"></i>
                                            <span id="trend-direction"
                                                style="font-weight: 700; font-size: 14px; color: white;">Rising</span>
                                        </div>
                                        <div id="trend-change"
                                            style="font-size: 12px; color: #10b981; font-weight: 600;">+8.5%</div>
                                    </div>
                                </div>

                                <div style="height: 180px; width: 100%; position: relative;">
                                    <canvas id="priceTrendChart"></canvas>
                                </div>

                                <div
                                    style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                    <div
                                        style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        Farmer Recommendation</div>
                                    <div id="trend-recommendation" style="font-size: 13px; color: white;">
                                        <span style="color: #ef4444; font-weight: 700;">Wait</span> - Price is
                                        increasing, consider selling after 3 days.
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Field Insights -->

                        <!-- Active Crop Management -->
                        <div class="card mt-2">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-tasks"></i> Active Crop Management
                                </div>
                            </div>
                            <div class="card-body">
                                {% if growing_activities %}
                                {% for activity in growing_activities[:3] %}
                                <div class="crop-card">
                                    <div class="crop-progress-ring">
                                        <svg width="70" height="70">
                                            <circle class="progress-bg" cx="35" cy="35" r="30" />
                                            <circle class="progress-bar" cx="35" cy="35" r="30" stroke-dasharray="188.5"
                                                stroke-dashoffset="{{ 188.5 - (188.5 * activity.progress / 100) }}" />
                                        </svg>
                                        <div class="crop-progress-text">{{ activity.progress }}%</div>
                                    </div>
                                    <div class="crop-details">
                                        <div class="crop-name">{{ activity.crop }}</div>
                                        <div class="crop-stage">{{ activity.current_stage }}</div>
                                        <div class="crop-meta">
                                            <span><i class="fas fa-calendar"></i> Started: {{ activity.started
                                                }}</span>
                                            <span><i class="fas fa-clock"></i> Day {{ activity.current_day }}</span>
                                        </div>
                                    </div>
                                    <div class="crop-actions">
                                        <button class="crop-action-btn view-btn" title="View Details"
                                            onclick="openCropViewModal('{{ activity.id }}', '{{ activity.crop }}', '{{ activity.current_stage }}', {{ activity.progress }}, {{ activity.current_day }}, '{{ activity.started }}', '{{ activity.notes|default('') }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="crop-action-btn edit-btn" title="Edit Crop"
                                            onclick="openCropEditModal('{{ activity.id }}', '{{ activity.crop }}', '{{ activity.current_stage }}', '{{ activity.notes|default('') }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="crop-action-btn delete-btn" title="Delete"
                                            onclick="deleteCropActivity('{{ activity.id }}')"><i
                                                class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">üå±</div>
                                    <h4>No Active Crops</h4>
                                    <p>Start growing by getting a crop recommendation</p>
                                    <a href="{{ url_for('crop.crop_suggestion') }}" class="empty-state-btn">
                                        <i class="fas fa-plus"></i> Get Crop Suggestion
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <!-- Weather Card - User's Registered District -->
                        <div class="card card-blue weather-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-cloud-sun"></i> Live Weather
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-sync-alt" onclick="refreshWeather()"
                                        style="cursor: pointer; font-size: 14px; opacity: 0.7;"
                                        title="Refresh Weather"></i>
                                    <span class="card-badge" style="background: #10b981;">Live</span>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if weather_data and weather_data.current %}
                                <div class="weather-main">
                                    <div class="weather-icon-large">{{ weather_data.current.icon }}</div>
                                    <div>
                                        <div class="weather-temp" id="weather-temp">{{
                                            weather_data.current.temperature
                                            }}¬∞C</div>
                                        <div class="weather-desc" id="weather-desc">{{
                                            weather_data.current.condition }}
                                        </div>
                                        <div class="weather-location">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span id="weather-location">{{ weather_data.current.location }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üíß</div>
                                        <div class="weather-detail-value" id="weather-humidity">{{
                                            weather_data.current.humidity }}%</div>
                                        <div class="weather-detail-label">Humidity</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üí®</div>
                                        <div class="weather-detail-value" id="weather-wind">{{
                                            weather_data.current.wind_speed }} km/h</div>
                                        <div class="weather-detail-label">Wind</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üëÅÔ∏è</div>
                                        <div class="weather-detail-value" id="weather-visibility">{% if
                                            weather_data.current and weather_data.current.visibility
                                            %}{{ weather_data.current.visibility }}{% else %}10{% endif %} km</div>
                                        <div class="weather-detail-label">Visibility</div>
                                    </div>
                                </div>
                                {% if weather_data.alerts %}
                                <div
                                    style="margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 12px;">
                                    {% for alert in weather_data.alerts[:2] %}
                                    <div
                                        style="display: flex; align-items: center; gap: 10px; padding: 8px; background: {% if alert.type == 'warning' %}rgba(239, 68, 68, 0.1){% else %}rgba(16, 185, 129, 0.1){% endif %}; border-radius: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">{{ alert.icon }}</span>
                                        <div>
                                            <div
                                                style="font-size: 12px; font-weight: 600; color: {% if alert.type == 'warning' %}#ef4444{% else %}#10b981{% endif %};">
                                                {{ alert.title }}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">{{
                                                alert.message[:60] }}...</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% else %}
                                <div class="weather-main">
                                    <div class="weather-icon-large">‚òÄÔ∏è</div>
                                    <div>
                                        <div class="weather-temp" id="weather-temp">28¬∞C</div>
                                        <div class="weather-desc" id="weather-desc">Loading...</div>
                                        <div class="weather-location">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span id="weather-location">{{ user.district }}, {{ user.state }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üíß</div>
                                        <div class="weather-detail-value" id="weather-humidity">--%</div>
                                        <div class="weather-detail-label">Humidity</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üí®</div>
                                        <div class="weather-detail-value" id="weather-wind">-- km/h</div>
                                        <div class="weather-detail-label">Wind</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üåßÔ∏è</div>
                                        <div class="weather-detail-value" id="weather-rain">--%</div>
                                        <div class="weather-detail-label">Rain</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Saved Fertilizer Recommendations -->
                        {% if fertilizer_recommendations %}
                        <div class="card card-dark mt-2">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-flask"></i> Saved Fertilizer Recommendations
                                </div>
                                <span class="card-badge">{{ fertilizer_recommendations|length }} Saved</span>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    {% for rec in fertilizer_recommendations[:3] %}
                                    <div
                                        style="background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; padding: 14px; border: 1px solid rgba(255,255,255,0.1);">
                                        <!-- Header Row -->
                                        <div
                                            style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                            <div
                                                style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                                                üß™
                                            </div>
                                            <div style="flex: 1; min-width: 0;">
                                                <div
                                                    style="font-size: 14px; font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    {{ rec.fertilizer }}</div>
                                                <div style="font-size: 11px; color: #94a3b8;">
                                                    <i class="fas fa-seedling"
                                                        style="color: #10b981; margin-right: 3px;"></i>{{ rec.crop
                                                    }} ¬∑
                                                    <i class="fas fa-calendar" style="margin: 0 3px;"></i>{{
                                                    rec.date }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div style="display: flex; gap: 6px;">
                                            <button
                                                onclick="openFertilizerViewModal('{{ rec.id }}', '{{ rec.fertilizer }}', '{{ rec.crop }}', '{{ rec.date }}', '{{ rec.soil_type|default('') }}', '{{ rec.nitrogen|default('') }}', '{{ rec.phosphorus|default('') }}', '{{ rec.potassium|default('') }}')"
                                                style="flex: 1; padding: 8px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                            <button onclick="deleteFertilizer('{{ rec.id }}')"
                                                style="padding: 8px 12px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444; font-size: 12px; cursor: pointer;"
                                                title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i>
        </button>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-avatar">ü§ñ</div>
                <div class="chatbot-title">
                    <h4>Farm Assistant</h4>
                    <span>Always here to help</span>
                </div>
                <button class="chatbot-close" onclick="toggleChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chatMessages">
                <div class="chat-message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        Hello! I'm your Smart Farming Assistant. How can I help you today? You can ask me about
                        crops,
                        fertilizers, weather, or any farming-related questions.
                    </div>
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Type your message..."
                    onkeypress="handleChatKeypress(event)">
                <button onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Equipment Sharing Modal -->
    <div class="modal-overlay" id="equipmentModal" style="display: none;">
        <div class="card" style="width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-truck-pickup"></i> Equipment Sharing
                    Platform</div>
                <button onclick="closeEquipmentModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; color: var(--text-primary);" id="equipmentModalTitle">Rent Farm
                            Machinery
                        </h3>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;"
                            id="equipmentModalSubtitle">Connect with local farmers to share equipment and reduce
                            costs.
                        </p>
                    </div>
                    <button class="empty-state-btn" style="margin: 0; padding: 10px 20px;"
                        onclick="toggleEquipmentForm()" id="toggleEquipFormBtn">
                        <i class="fas fa-plus"></i> List Your Equipment
                    </button>
                </div>

                <!-- Listing Form (Hidden by default) -->
                <div id="equipmentListingForm"
                    style="display: none; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                    <form id="addEquipmentForm" onsubmit="event.preventDefault(); submitEquipmentListing();">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Equipment
                                    Name</label>
                                <input type="text" id="equipName" required placeholder="e.g. John Deere Tractor"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Equipment
                                    Type</label>
                                <select id="equipType" required
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="Tractor">Tractor</option>
                                    <option value="Sprayer">Sprayer</option>
                                    <option value="Harvester">Harvester</option>
                                    <option value="Plough">Plough</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Rental
                                    Rate (‚Çπ)</label>
                                <input type="number" id="equipRate" required placeholder="e.g. 500"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Rate
                                    Unit</label>
                                <select id="equipRateUnit"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="hr">Per Hour</option>
                                    <option value="day">Per Day</option>
                                    <option value="acre">Per Acre</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Description</label>
                            <textarea id="equipDesc" rows="2" placeholder="Describe the condition and specifications..."
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn-cancel" onclick="toggleEquipmentForm()"
                                style="padding: 10px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">Cancel</button>
                            <button type="submit"
                                style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">List
                                Equipment</button>
                        </div>
                    </form>
                </div>

                <div id="equipmentListContainer" class="equipment-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;">
                    <!-- Content will be loaded dynamically -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 15px; color: var(--text-secondary);">Loading equipment listings...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer"
                style="padding: 20px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">
                <button onclick="closeEquipmentModal()"
                    style="padding: 10px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Weather Modal -->
    <div class="modal-overlay" id="weatherModal" style="display: none;">
        <div class="card" style="width: 550px; max-width: 90vw;">
            <div class="card-header" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-cloud-sun"></i> Weather Forecast
                </div>
                <button onclick="closeWeatherModal()"
                    style="background: none; border: none; font-size: 20px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 20px;">
                <!-- Search Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" id="citySearchInput" placeholder="Enter city name (e.g., Mumbai, Delhi)"
                            style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                            onkeypress="if(event.key==='Enter') searchWeatherByCity()">
                        <button onclick="searchWeatherByCity()"
                            style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                        <span style="color: var(--text-secondary); font-size: 12px;">OR</span>
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    </div>
                    <button onclick="fetchWeatherByLocation()"
                        style="width: 100%; margin-top: 12px; padding: 12px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-location-arrow"></i> Use My Current Location
                    </button>
                </div>
                <!-- Weather Content -->
                <div id="weatherModalContent">
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-cloud-sun" style="font-size: 48px; color: #3b82f6; margin-bottom: 16px;"></i>
                        <p>Search for a city or use your current location to see weather</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal-overlay" id="notificationModal" style="display: none;">
        <div class="card" style="width: 580px; max-width: 95vw; max-height: 85vh; overflow-y: auto; border: none;">
            <div class="notif-header">
                <div class="notif-title">
                    <i class="fas fa-bell" style="color: #3b82f6;"></i>
                    Notifications
                    <span
                        style="font-size: 14px; font-weight: 500; background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 4px 12px; border-radius: 20px; margin-left: 8px;">{{
                        notifications|length if notifications else 0 }} New</span>
                </div>
                <button onclick="closeNotificationModal()"
                    style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">√ó</button>
            </div>
            <div class="card-body" style="padding: 25px; background: #f8fafc;">
                {% if notifications %}
                <div style="display: flex; flex-direction: column;">
                    {% for notification in notifications %}
                    <div class="notif-item">
                        <div class="notif-icon-box">
                            {% if notification.type == 'task' %}‚ö°
                            {% elif notification.type == 'harvest' %}üéØ
                            {% elif notification.type == 'equipment' or notification.type == 'rental_request' %}üöú
                            {% else %}üì¢{% endif %}
                        </div>
                        <div style="flex: 1;">
                            <div class="notif-content-title">{{ notification.title or notification.crop }}</div>
                            <div class="notif-content-msg">{{ notification.message }}</div>
                            <div class="notif-time"><i class="far fa-clock"></i> {{ notification.time_ago }}</div>

                            {% if notification.data and (notification.data.get('is_actionable') or
                            notification.data.get('action_type') == 'rental') %}
                            <div class="notif-action-bar">
                                <button
                                    onclick="handleRentalAction('accept', '{{ notification.data.equipment_id }}', '{{ notification.id }}', '{{ notification.data.requester_id }}')"
                                    class="notif-btn-primary">
                                    <i class="fas fa-check"></i> Accept Request
                                </button>
                                <button
                                    onclick="handleRentalAction('reject', '{{ notification.data.equipment_id }}', '{{ notification.id }}', '{{ notification.data.requester_id }}')"
                                    class="notif-btn-secondary">
                                    <i class="fas fa-times"></i> Dismiss
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; padding: 60px 20px;">
                    <div
                        style="width: 100px; height: 100px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);">
                        <i class="fas fa-bell-slash" style="font-size: 40px; color: #cbd5e1;"></i>
                    </div>
                    <h3 style="color: #1e293b; margin-bottom: 8px;">All caught up!</h3>
                    <p style="color: #64748b; font-size: 15px;">You don't have any new notifications right now.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Download Center Modal -->
    <div class="modal-overlay" id="downloadModal" style="display: none;">
        <div class="card"
            style="width: 500px; max-width: 95vw; border: none; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <div class="card-header"
                style="background: linear-gradient(135deg, #065f46 0%, #10b981 100%); padding: 24px; border: none;">
                <div class="card-title" style="color: white; font-size: 20px; font-weight: 700;">
                    <i class="fas fa-cloud-download-alt" style="margin-right: 10px;"></i> Download Center
                </div>
                <button onclick="closeDownloadModal()"
                    style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body" style="padding: 24px; background: #f8fafc;">
                <p style="font-size: 14px; color: #64748b; margin-bottom: 20px; font-weight: 500;">Generate and download
                    professional PDF reports for your farm.</p>

                <div class="download-option-card" onclick="generateReport(this, 'Market Report')">
                    <div class="download-icon-box" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="download-main-info">
                        <div class="download-main-title">District Market Report</div>
                        <div class="download-main-desc">Current commodity prices for {{ user.district }}</div>
                        <div id="last-gen-market-report" style="font-size: 10px; margin-top: 4px; color: #94a3b8;">Not
                            yet generated</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
                </div>

                <div class="download-option-card" onclick="generateReport(this, 'Crop Plan PDF')">
                    <div class="download-icon-box" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="download-main-info">
                        <div class="download-main-title">Growing Activities</div>
                        <div class="download-main-desc">Status and schedule for your active crops</div>
                        <div id="last-gen-crop-plan-pdf" style="font-size: 10px; margin-top: 4px; color: #94a3b8;">Not
                            yet generated</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
                </div>


                <div class="download-option-card" onclick="generateReport(this, 'Profit Summary')">
                    <div class="download-icon-box" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="download-main-info">
                        <div class="download-main-title">Expense Summary</div>
                        <div class="download-main-desc">Financial breakdown from calculator</div>
                        <div id="last-gen-profit-summary" style="font-size: 10px; margin-top: 4px; color: #94a3b8;">Not
                            yet generated</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
                </div>

                <div class="download-option-card" onclick="generateReport(this, 'Weather Report')">
                    <div class="download-icon-box" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                    <div class="download-main-info">
                        <div class="download-main-title">7-Day Weather Forecast</div>
                        <div class="download-main-desc">Meteorological trends for your area</div>
                        <div id="last-gen-weather-report" style="font-size: 10px; margin-top: 4px; color: #94a3b8;">Not
                            yet generated</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #cbd5e1;"></i>
                </div>
            </div>
            <div style="padding: 16px 24px; background: white; border-top: 1px solid #f1f5f9; text-align: center;">
                <span
                    style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Powered
                    by Smart Farming Assistant AI</span>
            </div>
        </div>
    </div>

    <!-- Advanced Expense Calculator Modal -->
    <div class="modal-overlay" id="calculatorModal" style="display: none;">
        <div class="card" style="width: 1200px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #52b788, #2d6a4f); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-calculator"></i> üí∞ Advanced Farming
                    Expense Calculator</div>
                <button onclick="closeCalculatorModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Calculate and track all your farming
                    expenses for better financial planning with profit analysis</p>

                <!-- Season and Crop Type Selection -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üå±
                            Select Crop Type</label>
                        <select id="cropType"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                            onchange="loadBenchmarkData()">
                            <option value="">Select Crop</option>
                            <optgroup label="Cereals">
                                <option value="rice">Rice</option>
                                <option value="wheat">Wheat</option>
                                <option value="maize">Maize (Corn)</option>
                            </optgroup>
                            <optgroup label="Pulses & Legumes">
                                <option value="blackgram">Black Gram</option>
                                <option value="chickpea">Chickpea</option>
                                <option value="kidneybeans">Kidney Beans</option>
                                <option value="lentil">Lentil</option>
                                <option value="mothbeans">Moth Beans</option>
                                <option value="mungbean">Mung Bean</option>
                                <option value="pigeonpeas">Pigeon Peas</option>
                                <option value="greenpeas">Green Peas</option>
                                <option value="beans">Beans</option>
                                <option value="pulses">Other Pulses</option>
                            </optgroup>
                            <optgroup label="Vegetables">
                                <option value="potato">Potato</option>
                                <option value="tomato">Tomato</option>
                                <option value="onion">Onion</option>
                                <option value="carrot">Carrot</option>
                                <option value="cabbage">Cabbage</option>
                                <option value="cauliflower">Cauliflower</option>
                                <option value="spinach">Spinach</option>
                                <option value="brinjal">Brinjal (Eggplant)</option>
                                <option value="okra">Lady's Finger (Okra)</option>
                                <option value="beetroot">Beetroot</option>
                                <option value="radish">Radish</option>
                                <option value="capsicum">Capsicum</option>
                                <option value="pumpkin">Pumpkin</option>
                                <option value="bottlegourd">Bottle Gourd</option>
                                <option value="bittergourd">Bitter Gourd</option>
                                <option value="ridgegourd">Ridge Gourd</option>
                                <option value="mushroom">Mushroom</option>
                                <option value="vegetables">Other Vegetables</option>
                            </optgroup>
                            <optgroup label="Fruits">
                                <option value="apple">Apple</option>
                                <option value="banana">Banana</option>
                                <option value="mango">Mango</option>
                                <option value="orange">Orange</option>
                                <option value="grapes">Grapes</option>
                                <option value="papaya">Papaya</option>
                                <option value="pineapple">Pineapple</option>
                                <option value="guava">Guava</option>
                                <option value="watermelon">Watermelon</option>
                                <option value="muskmelon">Muskmelon</option>
                                <option value="pomegranate">Pomegranate</option>
                                <option value="strawberry">Strawberry</option>
                                <option value="cherry">Cherry</option>
                                <option value="kiwi">Kiwi</option>
                                <option value="lemon">Lemon</option>
                                <option value="pear">Pear</option>
                                <option value="peach">Peach</option>
                                <option value="plum">Plum</option>
                                <option value="custardapple">Custard Apple</option>
                            </optgroup>
                            <optgroup label="Cash Crops & Others">
                                <option value="cotton">Cotton</option>
                                <option value="sugarcane">Sugarcane</option>
                                <option value="jute">Jute</option>
                                <option value="coffee">Coffee</option>
                                <option value="coconut">Coconut</option>
                                <option value="oilseeds">Oilseeds</option>
                            </optgroup>
                        </select>
                    </div>
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üóìÔ∏è
                            Select Season</label>
                        <select id="seasonType"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                            <option value="kharif">Kharif (Monsoon)</option>
                            <option value="rabi">Rabi (Winter)</option>
                            <option value="zaid">Zaid (Summer)</option>
                        </select>
                    </div>
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üìÖ
                            Entry Date</label>
                        <input type="date" id="entryDate"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
                    <!-- Input Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">‚úèÔ∏è Add Expenses</h3>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üåæ Seeds & Planting Material</h4>
                            <input type="number" id="seedCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="seedBenchmark" style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üß™ Fertilizers & Manure</h4>
                            <input type="number" id="fertilizerCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="fertilizerBenchmark"
                                style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üêõ Pesticides & Insecticides</h4>
                            <input type="number" id="pesticideCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="pesticideBenchmark"
                                style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üíß Irrigation & Water</h4>
                            <input type="number" id="irrigationCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üë®‚Äçüåæ Labor Cost</h4>
                            <input type="number" id="laborCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üöú Machinery & Equipment</h4>
                            <input type="number" id="machineryCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div style="background: var(--body-bg); padding: 12px; border-radius: 10px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üì¶ Other Expenses</h4>
                            <input type="number" id="otherCost" placeholder="Transport, Storage, etc."
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>
                    </div>

                    <!-- Summary Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">üìÑ Expense Summary</h3>

                        <div
                            style="background: linear-gradient(135deg, #52b788, #2d6a4f); padding: 20px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 16px;">Total Expenses</h3>
                            <h1 style="margin: 0; font-size: 36px; color: white;" id="totalExpense">‚Çπ0</h1>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0;">üìä Expense Breakdown</h4>
                            <canvas id="expenseChart" style="max-height: 200px;"></canvas>
                            <div id="expenseBreakdown" style="margin-top: 12px; font-size: 13px;">
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Seeds:</span><strong id="seedDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Fertilizers:</span><strong id="fertilizerDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Pesticides:</span><strong id="pesticideDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Irrigation:</span><strong id="irrigationDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Labor:</span><strong id="laborDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Machinery:</span><strong id="machineryDisplay">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                                    <span>Other:</span><strong id="otherDisplay">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                        <div
                            style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: #856404;">üí° Cost per Acre</h4>
                            <input type="number" id="landArea" placeholder="Land area (acres)" step="0.1"
                                style="width: 100%; padding: 10px; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 8px;"
                                oninput="calculateTotal()">
                            <h3 style="margin: 0; color: #856404;" id="costPerAcre">‚Çπ0 per acre</h3>
                            <small id="benchmarkComparison" style="color: #856404;"></small>
                        </div>
                    </div>

                    <!-- Revenue & Profit Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">üíµ Revenue & Profit</h3>

                        <div
                            style="background: #d1f2eb; border-left: 4px solid #52b788; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: #0f5132;">üì¶ Expected Production</h4>
                            <input type="number" id="expectedYield" placeholder="Yield (quintals)"
                                style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px; margin-bottom: 8px;"
                                oninput="calculateTotal()">
                            <input type="number" id="marketPrice" placeholder="Price (‚Çπ/quintal)"
                                style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #06d6a0, #118ab2); padding: 16px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 14px;">Total Revenue</h3>
                            <h2 style="margin: 0; font-size: 28px; color: white;" id="totalRevenue">‚Çπ0</h2>
                        </div>

                        <div id="profitCard"
                            style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 16px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 14px;">Net Profit</h3>
                            <h2 style="margin: 0; font-size: 28px; color: white;" id="netProfit">‚Çπ0</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.9;" id="profitMargin">Profit
                                Margin: 0%</p>
                        </div>

                        <div
                            style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 8px 0; color: #2e7d32;">üéØ Break-even Analysis</h4>
                            <p style="margin: 4px 0; color: #2e7d32; font-size: 12px;">Min selling price:</p>
                            <h4 style="margin: 4px 0; color: #2e7d32;" id="minPrice">‚Çπ0 per quintal</h4>
                            <p style="margin: 8px 0 4px 0; color: #2e7d32; font-size: 12px;">Break-even quantity:
                            </p>
                            <h4 style="margin: 4px 0; color: #2e7d32;" id="breakEvenQty">0 quintals</h4>
                        </div>

                        <div
                            style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: #e65100;">üè¶ Loan Calculator</h4>
                            <input type="number" id="loanAmount" placeholder="Loan amount (‚Çπ)"
                                style="width: 100%; padding: 8px; border: 1px solid #ff9800; border-radius: 6px; margin-bottom: 8px; font-size: 13px;"
                                oninput="calculateLoan()">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <input type="number" id="interestRate" placeholder="Rate %" value="7"
                                    style="padding: 8px; border: 1px solid #ff9800; border-radius: 6px; font-size: 13px;"
                                    oninput="calculateLoan()">
                                <input type="number" id="loanPeriod" placeholder="Months" value="12"
                                    style="padding: 8px; border: 1px solid #ff9800; border-radius: 6px; font-size: 13px;"
                                    oninput="calculateLoan()">
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;"><span>Monthly
                                        EMI:</span><strong id="monthlyEMI" style="color: #e65100;">‚Çπ0</strong></div>
                                <div style="display: flex; justify-content: space-between;"><span>Total
                                        Interest:</span><strong id="totalInterest" style="color: #e65100;">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; border-top: 1px solid #ffe0b2; padding-top: 6px; margin-top: 6px;">
                                    <span>Total Amount:</span><strong id="totalAmount"
                                        style="color: #e65100;">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button onclick="saveExpenseEntry()"
                                style="padding: 12px; background: #52b788; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ
                                Save</button>
                            <button onclick="exportToPDF()"
                                style="padding: 12px; background: #0284c7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üìÑ
                                PDF</button>
                        </div>
                        <button onclick="resetCalculator()"
                            style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 8px;">üîÑ
                            Reset</button>
                    </div>
                </div>

                <!-- Tips Section -->
                <div
                    style="margin-top: 24px; background: #e7f5ff; border-left: 4px solid #0284c7; padding: 16px; border-radius: 8px;">
                    <h4 style="color: #0c4a6e; margin: 0 0 12px 0;">üí° Money Saving Tips</h4>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #0c4a6e; font-size: 13px;">
                        <li><strong>Buy in Bulk:</strong> Purchase seeds and fertilizers with other farmers to get
                            discounts</li>
                        <li><strong>Government Subsidies:</strong> Check schemes for subsidy on seeds, fertilizers,
                            equipment</li>
                        <li><strong>Drip Irrigation:</strong> Saves 40-60% water cost compared to flood irrigation
                        </li>
                        <li><strong>Organic Manure:</strong> Make your own compost to reduce fertilizer cost</li>
                        <li><strong>Soil Testing:</strong> Prevents over-fertilization, saves 20-30% fertilizer cost
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Govt Schemes Modal -->
    <div class="modal-overlay" id="govtSchemesModal" style="display: none;">
        <div class="card" style="width: 1000px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #059669, #047857); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-landmark"></i> üèõÔ∏è Government Schemes
                    for
                    Farmers</div>
                <button onclick="closeGovtSchemesModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 24px; text-align: center;">Explore government
                    schemes designed to support farmers across India</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                    <!-- Central Government Schemes -->
                    <div>
                        <h3
                            style="color: var(--accent-green); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üáÆüá≥</span> Central Government Schemes
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #10b981;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM-KISAN (Pradhan Mantri
                                Kisan
                                Samman Nidhi)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Income
                                support
                                of ‚Çπ6,000/year in three equal installments to all farmer families</p>
                            <a href="https://pmkisan.gov.in/" target="_blank"
                                style="color: #10b981; font-weight: 600; text-decoration: none; font-size: 13px;">Visit
                                Official Website ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #3b82f6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Credit Card (KCC)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Provides
                                credit to farmers for agriculture and allied activities at concessional rates</p>
                            <a href="https://www.nabard.org/content1.aspx?id=523&catid=8&mid=523" target="_blank"
                                style="color: #3b82f6; font-weight: 600; text-decoration: none; font-size: 13px;">Learn
                                More ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #f97316;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM Fasal Bima Yojana</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Crop
                                insurance
                                scheme providing financial support to farmers in case of crop failure</p>
                            <a href="https://pmfby.gov.in/" target="_blank"
                                style="color: #f97316; font-weight: 600; text-decoration: none; font-size: 13px;">Apply
                                Now ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #8b5cf6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Soil Health Card Scheme</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Provides
                                soil
                                health cards to farmers with information on nutrient status of their soil</p>
                            <a href="https://soilhealth.dac.gov.in/" target="_blank"
                                style="color: #8b5cf6; font-weight: 600; text-decoration: none; font-size: 13px;">Get
                                Soil Card ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #06b6d4;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM Krishi Sinchayee Yojana
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Aims to
                                enhance water use efficiency through Micro Irrigation and watershed development</p>
                            <a href="https://pmksy.gov.in/" target="_blank"
                                style="color: #06b6d4; font-weight: 600; text-decoration: none; font-size: 13px;">Know
                                More ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #84cc16;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Paramparagat Krishi Vikas
                                Yojana
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Promotes
                                organic farming through cluster approach and PGS certification</p>
                            <a href="https://pgsindia-ncof.gov.in/" target="_blank"
                                style="color: #84cc16; font-weight: 600; text-decoration: none; font-size: 13px;">Register
                                ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #ec4899;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">National Agriculture Market
                                (e-NAM)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Online
                                trading
                                platform for agricultural commodities in India</p>
                            <a href="https://www.enam.gov.in/" target="_blank"
                                style="color: #ec4899; font-weight: 600; text-decoration: none; font-size: 13px;">Trade
                                Online ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; border-left: 4px solid #14b8a6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Call Centre</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">24x7
                                toll-free
                                helpline (1800-180-1551) for farmers' queries</p>
                            <a href="https://mkisan.gov.in/Home/KCC" target="_blank"
                                style="color: #14b8a6; font-weight: 600; text-decoration: none; font-size: 13px;">Contact
                                Support ‚Üí</a>
                        </div>
                    </div>

                    <!-- State Schemes & Resources -->
                    <div>
                        <h3
                            style="color: var(--accent-purple); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìç</span> State Government Schemes
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #a855f7;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Check Your State Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Each state
                                offers additional schemes. Visit your state agriculture department website</p>
                            <a href="https://agricoop.gov.in/en" target="_blank"
                                style="color: #a855f7; font-weight: 600; text-decoration: none; font-size: 13px;">State
                                Agriculture Portals ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #f59e0b;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Karnataka Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Raitha
                                Bandhu,
                                Krishi Bhagya, and other state-specific programs</p>
                            <a href="https://raitamitra.karnataka.gov.in/" target="_blank"
                                style="color: #f59e0b; font-weight: 600; text-decoration: none; font-size: 13px;">Karnataka
                                Portal ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #ef4444;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Maharashtra Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Mahatma
                                Jyotiba Phule Shetkari Karjmukti Yojana and others</p>
                            <a href="https://krishi.maharashtra.gov.in/" target="_blank"
                                style="color: #ef4444; font-weight: 600; text-decoration: none; font-size: 13px;">Maharashtra
                                Portal ‚Üí</a>
                        </div>

                        <h3
                            style="color: #0284c7; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìö</span> Additional Resources
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #0284c7;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Ministry of Agriculture
                                Portal
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Complete
                                information about all agricultural schemes and subsidies</p>
                            <a href="https://agricoop.gov.in/" target="_blank"
                                style="color: #0284c7; font-weight: 600; text-decoration: none; font-size: 13px;">Visit
                                Portal ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #22c55e;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Rath Mobile App</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Helps
                                farmers
                                find transport for their agricultural produce</p>
                            <a href="https://kisanrath.nic.in/" target="_blank"
                                style="color: #22c55e; font-weight: 600; text-decoration: none; font-size: 13px;">Download
                                App ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #6366f1;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Direct Benefit Transfer (DBT)
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Track your
                                subsidy and benefit transfers</p>
                            <a href="https://dbtbharat.gov.in/" target="_blank"
                                style="color: #6366f1; font-weight: 600; text-decoration: none; font-size: 13px;">Check
                                Status ‚Üí</a>
                        </div>

                        <!-- Helpline Info -->
                        <div
                            style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 20px; border-radius: 12px; margin-top: 16px;">
                            <h4
                                style="margin: 0 0 12px 0; color: #92400e; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-phone-alt"></i> Farmer Helplines
                            </h4>
                            <div style="display: grid; gap: 8px; font-size: 14px; color: #78350f;">
                                <div><strong>Kisan Call Centre:</strong> 1800-180-1551 (Toll Free)</div>
                                <div><strong>PM-KISAN Helpline:</strong> 155261 / 011-24300606</div>
                                <div><strong>Crop Insurance:</strong> 1800-209-5959</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; text-align: center; padding: 30px;">
                <button onclick="closeProfileModal()"
                    style="position: absolute; right: 16px; top: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
                <div
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; font-weight: 700; border: 4px solid white; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    {{ user_name[0] if user_name else 'U' }}
                </div>
                <h2 style="margin: 0; font-size: 24px;">{{ user_name or 'Farmer' }}</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">üåæ Smart Farmer</p>
            </div>
            <div class="card-body" style="padding: 24px;">
                <div style="display: grid; gap: 16px;">
                    <!-- Email -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Email</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.email if user
                                else
                                'Not set' }}</div>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Phone</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.phone if user
                                and
                                user.phone else 'Not set' }}</div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Location</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.district if user
                                and
                                user.district else 'Not set' }}{% if user and user.state %}, {{ user.state }}{%
                                endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Member Since -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Member Since</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{
                                user.created_at.strftime('%B %d, %Y') if user and user.created_at and
                                user.created_at.strftime else 'December 2025' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div
                    style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; border: 1px solid #bbf7d0;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #166534; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar"></i> Your Farming Activity
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;">{{ stats.crops_suggested
                                if
                                stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Crops Suggested</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">{{
                                stats.fertilizers_saved
                                if stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Fertilizer Plans</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">{{ stats.active_crops if
                                stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Active Crops</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button onclick="closeProfileModal()"
                        style="flex: 1; padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="window.location.href='{{ url_for('auth.logout') }}'"
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop View Modal -->
    <div class="modal-overlay" id="cropViewModal" style="display: none;">
        <div class="card" style="width: 600px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; position: relative;">
                <button onclick="closeCropViewModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üå±</div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px;" id="viewCropName">Crop Name</h2>
                        <p style="margin: 6px 0 0 0; opacity: 0.9; font-size: 14px;" id="viewCropStage">Current
                            Stage
                        </p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <!-- Progress Section -->
                <div
                    style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 16px; margin-bottom: 20px;">
                    <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
                        <svg width="120" height="120" style="transform: rotate(-90deg);">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#e2e8f0" stroke-width="10" />
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="10"
                                stroke-dasharray="314.16" id="viewProgressCircle" stroke-linecap="round" />
                        </svg>
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="viewProgressText">0%
                            </div>
                            <div style="font-size: 11px; color: #64748b;">Complete</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div
                        style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                            Current Day</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                            id="viewCurrentDay">0</div>
                    </div>
                    <div
                        style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                            Started On</div>
                        <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                            id="viewStartDate">-</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tasks" style="color: #10b981;"></i> Growth Timeline
                    </h4>
                    <div id="viewTimeline" style="position: relative; padding-left: 24px;">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>

                <!-- Notes Section -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sticky-note" style="color: #f59e0b;"></i> Notes
                    </h4>
                    <div id="viewNotes"
                        style="padding: 16px; background: #fffbeb; border-radius: 12px; border: 1px solid #fde68a; font-size: 14px; color: #92400e; min-height: 60px;">
                        No notes added yet.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <button id="editCropBtn"
                        style="padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button id="fullViewCropBtn"
                        style="padding: 12px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Full View
                    </button>
                    <button onclick="closeCropViewModal()"
                        style="padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Edit Modal -->
    <div class="modal-overlay" id="cropEditModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 24px; position: relative;">
                <button onclick="closeCropEditModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ‚úèÔ∏è</div>
                    <div>
                        <h2 style="margin: 0; font-size: 20px;">Edit Crop Activity</h2>
                        <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 13px;" id="editCropTitle">Update your
                            crop
                            details</p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <form id="editCropForm">
                    <input type="hidden" id="editCropId" name="cropId">

                    <!-- Crop Name (Read-only) -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-seedling" style="color: #10b981; margin-right: 6px;"></i> Crop Name
                        </label>
                        <input type="text" id="editCropName" readonly
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: #f8fafc; color: #64748b;">
                    </div>

                    <!-- Current Stage -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-layer-group" style="color: #3b82f6; margin-right: 6px;"></i> Update
                            Stage
                        </label>
                        <select id="editCropStage" name="stage"
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer;">
                            <option value="Seed Sowing">üå± Seed Sowing</option>
                            <option value="Germination">üåø Germination</option>
                            <option value="Seedling">üåæ Seedling</option>
                            <option value="Vegetative Growth">üå≥ Vegetative Growth</option>
                            <option value="Flowering">üå∏ Flowering</option>
                            <option value="Fruit Development">üçé Fruit Development</option>
                            <option value="Maturity">‚úÖ Maturity</option>
                            <option value="Harvest Ready">üéâ Harvest Ready</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-sticky-note" style="color: #f59e0b; margin-right: 6px;"></i> Notes &
                            Observations
                        </label>
                        <textarea id="editCropNotes" name="notes" rows="4"
                            placeholder="Add notes about your crop's progress, observations, or reminders..."
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <!-- Task Checklist -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                            <i class="fas fa-check-square" style="color: #8b5cf6; margin-right: 6px;"></i> Quick
                            Tasks
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_watering"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üíß Watering completed today</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_fertilizer"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üß™ Fertilizer applied</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_pest"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üêõ Pest check done</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_weeding"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üåø Weeding completed</span>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px;">
                        <button type="button" onclick="closeCropEditModal()"
                            style="flex: 1; padding: 14px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit"
                            style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Fertilizer View Modal -->
    <div class="modal-overlay" id="fertilizerViewModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 24px; position: relative;">
                <button onclick="closeFertilizerViewModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üß™</div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px;" id="viewFertilizerName">Fertilizer Name</h2>
                        <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 14px;"><i class="fas fa-seedling"></i>
                            For: <span id="viewFertilizerCrop">Crop</span></p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <!-- Fertilizer Details -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: #8b5cf6;"></i> Fertilizer Details
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div
                            style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Soil Type</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                                id="viewFertilizerSoil">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Saved On</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                                id="viewFertilizerDate">-</div>
                        </div>
                    </div>
                </div>

                <!-- NPK Values -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar" style="color: #10b981;"></i> Soil NPK Values
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">
                                Nitrogen (N)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #15803d; margin-top: 4px;"
                                id="viewFertilizerN">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #92400e; text-transform: uppercase; font-weight: 600;">
                                Phosphorus (P)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #b45309; margin-top: 4px;"
                                id="viewFertilizerP">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #5b21b6; text-transform: uppercase; font-weight: 600;">
                                Potassium (K)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #7c3aed; margin-top: 4px;"
                                id="viewFertilizerK">-</div>
                        </div>
                    </div>
                </div>

                <!-- Application Tips -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Application Tips
                    </h4>
                    <div
                        style="padding: 16px; background: #fffbeb; border-radius: 12px; border: 1px solid #fde68a; font-size: 13px; color: #92400e;">
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Apply fertilizer in early morning or late evening</li>
                            <li>Water the soil before and after application</li>
                            <li>Keep away from plant stem to avoid burning</li>
                            <li>Follow recommended dosage for best results</li>
                        </ul>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-bottom: 16px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shopping-cart" style="color: #f59e0b;"></i> Buy From
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <button id="buyAmazonBtn" onclick="openAmazonLink()"
                            style="padding: 12px; background: linear-gradient(135deg, #ff9900, #e68a00); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 12px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg"
                                style="height: 18px; width: auto; filter: brightness(0) invert(1);" alt="Amazon">
                            Amazon
                        </button>
                        <button id="buyIndiamartBtn" onclick="openIndiamartLink()"
                            style="padding: 12px; background: linear-gradient(135deg, #0066cc, #004d99); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 12px;">
                            <span style="font-size: 20px;">üè≠</span>
                            IndiaMart
                        </button>
                        <a href="https://www.google.com/maps/search/fertilizer+shop+near+me" target="_blank"
                            style="padding: 12px; background: linear-gradient(135deg, #34a853, #2d8f47); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; text-decoration: none; font-size: 12px;">
                            <span style="font-size: 20px;">üìç</span>
                            Nearby Stores
                        </a>
                    </div>
                </div>

                <button onclick="closeFertilizerViewModal()"
                    style="width: 100%; padding: 14px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .left-column,
        .right-column {
            display: flex;
            flex-direction: column;
        }

        .middle-column {
            display: flex;
            flex-direction: column;
        }

        /* Delete Button Styles */
        .crop-action-btn.delete-btn {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .crop-action-btn.delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .crop-action-btn.view-btn {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .crop-action-btn.view-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .crop-action-btn.edit-btn {
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .crop-action-btn.edit-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .fertilizer-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-btn-small {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .delete-btn-small:hover {
            background: #ef4444;
            color: white;
        }
    </style>

    <script>
        // Crop View/Edit Modal Variables
        let currentViewCropId = '';
        let currentViewCropName = '';
        let currentViewCropStage = '';
        let currentViewCropNotes = '';

        // Crop View Modal Functions
        function openCropViewModal(id, cropName, stage, progress, currentDay, startDate, notes) {
            currentViewCropId = id;
            currentViewCropName = cropName;
            currentViewCropStage = stage;
            currentViewCropNotes = notes || '';

            document.getElementById('viewCropName').textContent = cropName;
            document.getElementById('viewCropStage').textContent = stage;
            document.getElementById('viewProgressText').textContent = progress + '%';
            document.getElementById('viewCurrentDay').textContent = currentDay;
            document.getElementById('viewStartDate').textContent = startDate;
            document.getElementById('viewNotes').textContent = notes || 'No notes added yet.';

            // Update progress circle
            const circumference = 314.16;
            const offset = circumference - (circumference * progress / 100);
            document.getElementById('viewProgressCircle').style.strokeDashoffset = offset;

            // Generate timeline
            generateTimeline(stage, progress);

            document.getElementById('cropViewModal').style.display = 'flex';

            // Setup Edit button click handler
            const editBtn = document.getElementById('editCropBtn');
            if (editBtn) {
                editBtn.onclick = function () {
                    closeCropViewModal();
                    setTimeout(() => {
                        openCropEditModal(currentViewCropId, currentViewCropName, currentViewCropStage, currentViewCropNotes);
                    }, 100);
                };
            }

            // Setup Full View button click handler
            const fullViewBtn = document.getElementById('fullViewCropBtn');
            if (fullViewBtn) {
                fullViewBtn.onclick = function () {
                    window.location.href = '/growing/view/' + id;
                };
            }
        }

        function closeCropViewModal() {
            document.getElementById('cropViewModal').style.display = 'none';
        }

        function generateTimeline(currentStage, progress) {
            const stages = [
                { name: 'Seed Sowing', icon: 'üå±', days: '1-7' },
                { name: 'Germination', icon: 'üåø', days: '7-14' },
                { name: 'Seedling', icon: 'üåæ', days: '14-30' },
                { name: 'Vegetative Growth', icon: 'üå≥', days: '30-60' },
                { name: 'Flowering', icon: 'üå∏', days: '60-75' },
                { name: 'Fruit Development', icon: 'üçé', days: '75-90' },
                { name: 'Maturity', icon: '‚úÖ', days: '90-110' },
                { name: 'Harvest Ready', icon: 'üéâ', days: '110+' }
            ];

            const currentIndex = stages.findIndex(s => s.name === currentStage);
            const timeline = document.getElementById('viewTimeline');
            timeline.innerHTML = '';

            stages.forEach((stage, index) => {
                const isCompleted = index < currentIndex;
                const isCurrent = index === currentIndex;
                const isPending = index > currentIndex;

                const item = document.createElement('div');
                item.style.cssText = 'display: flex; gap: 12px; margin-bottom: 16px; position: relative;';

                // Vertical line
                if (index < stages.length - 1) {
                    item.innerHTML += `<div style="position: absolute; left: 11px; top: 28px; bottom: -16px; width: 2px; background: ${isCompleted ? '#10b981' : '#e2e8f0'};"></div>`;
                }

                // Icon circle
                const iconBg = isCompleted ? '#10b981' : (isCurrent ? '#3b82f6' : '#e2e8f0');
                const iconColor = isCompleted || isCurrent ? 'white' : '#94a3b8';

                item.innerHTML += `
            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${iconBg}; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; z-index: 1;">
                ${isCompleted ? '‚úì' : stage.icon}
            </div>
            <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 600; color: ${isCurrent ? '#3b82f6' : (isCompleted ? '#10b981' : '#64748b')};">
                    ${stage.name} ${isCurrent ? '(Current)' : ''}
                </div>
                <div style="font-size: 11px; color: #94a3b8;">Days ${stage.days}</div>
            </div>
        `;

                timeline.appendChild(item);
            });
        }

        // Crop Edit Modal Functions
        function openCropEditModal(id, cropName, stage, notes) {
            document.getElementById('editCropId').value = id;
            document.getElementById('editCropName').value = cropName;
            document.getElementById('editCropStage').value = stage;
            document.getElementById('editCropNotes').value = notes || '';
            document.getElementById('editCropTitle').textContent = 'Editing: ' + cropName;

            document.getElementById('cropEditModal').style.display = 'flex';
        }

        function closeCropEditModal() {
            document.getElementById('cropEditModal').style.display = 'none';
        }

        // Fertilizer View Modal Functions
        let currentFertilizerName = '';

        function openFertilizerViewModal(id, fertilizerName, crop, date, soilType, nitrogen, phosphorus, potassium) {
            currentFertilizerName = fertilizerName || 'fertilizer';

            document.getElementById('viewFertilizerName').textContent = fertilizerName || 'Fertilizer';
            document.getElementById('viewFertilizerCrop').textContent = crop || '-';
            document.getElementById('viewFertilizerSoil').textContent = soilType || 'Not specified';
            document.getElementById('viewFertilizerDate').textContent = date || '-';
            document.getElementById('viewFertilizerN').textContent = nitrogen || '-';
            document.getElementById('viewFertilizerP').textContent = phosphorus || '-';
            document.getElementById('viewFertilizerK').textContent = potassium || '-';

            document.getElementById('fertilizerViewModal').style.display = 'flex';
        }

        function openAmazonLink() {
            const url = 'https://www.amazon.in/s?k=' + encodeURIComponent(currentFertilizerName + ' fertilizer');
            window.open(url, '_blank');
        }

        function openIndiamartLink() {
            const url = 'https://www.indiamart.com/search.mp?ss=' + encodeURIComponent(currentFertilizerName + ' fertilizer');
            window.open(url, '_blank');
        }

        function closeFertilizerViewModal() {
            document.getElementById('fertilizerViewModal').style.display = 'none';
        }

        // Buy Dropdown Toggle
        function toggleBuyDropdown(button) {
            const container = button.parentElement;
            const dropdown = container.querySelector('.buy-dropdown');

            // Close all other dropdowns first
            document.querySelectorAll('.buy-dropdown').forEach(d => {
                if (d !== dropdown) d.style.display = 'none';
            });

            // Toggle this dropdown
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.buy-dropdown-container')) {
                document.querySelectorAll('.buy-dropdown').forEach(d => d.style.display = 'none');
            }
        });
        // Handle Edit Form Submit
        document.addEventListener('DOMContentLoaded', function () {
            const editForm = document.getElementById('editCropForm');
            if (editForm) {
                editForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    console.log('Form submitted');

                    const cropId = document.getElementById('editCropId').value;
                    const formData = {
                        stage: document.getElementById('editCropStage').value,
                        notes: document.getElementById('editCropNotes').value,
                        tasks: {
                            watering: document.querySelector('input[name="task_watering"]').checked,
                            fertilizer: document.querySelector('input[name="task_fertilizer"]').checked,
                            pest: document.querySelector('input[name="task_pest"]').checked,
                            weeding: document.querySelector('input[name="task_weeding"]').checked
                        }
                    };

                    console.log('Sending data to /growing/update/' + cropId, formData);

                    fetch('/growing/update/' + cropId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => {
                            console.log('Response status:', response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log('Response data:', data);
                            if (data.success) {
                                closeCropEditModal();
                                location.reload();
                            } else {
                                alert('Failed to update: ' + (data.message || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to update crop activity');
                        });
                });
            }
        });

        // Delete Functions
        function deleteCropActivity(activityId) {
            if (confirm('Are you sure you want to delete this crop activity?')) {
                fetch('/growing/delete/' + activityId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to delete: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete activity');
                    });
            }
        }

        function deleteFertilizer(fertilizerId) {
            if (confirm('Are you sure you want to delete this fertilizer recommendation?')) {
                fetch('/fertilizer/delete/' + fertilizerId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to delete: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete recommendation');
                    });
            }
        }

        // Chatbot Functions
        function toggleChatbot() {
            const window = document.getElementById('chatbotWindow');
            window.classList.toggle('active');
        }

        function openChatbotModal() {
            document.getElementById('chatbotWindow').classList.add('active');
        }

        // Function to fetch and render price trend chart
        let priceTrendChart = null;

        function loadPriceTrend(commodity, days = 7) {
            if (!commodity) return;

            // Update active button state
            document.getElementById('btn-7d').classList.toggle('active', days === 7);
            document.getElementById('btn-30d').classList.toggle('active', days === 30);

            const state = "{{ user.state }}";
            const district = "{{ user.district }}";

            fetch(`/api/price-trend/${commodity}?state=${state}&district=${district}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTrendChart(data);
                    } else {
                        console.error('Trend data error:', data.error);
                    }
                })
                .catch(error => console.error('Error fetching trend:', error));
        }

        function renderTrendChart(data) {
            const canvas = document.getElementById('priceTrendChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const labels = data.trend_data.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            });

            const prices = data.trend_data.map(item => item.modal_price / 100); // Convert to per kg

            if (priceTrendChart) {
                priceTrendChart.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 180);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

            priceTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${data.commodity} Price`,
                        data: prices,
                        backgroundColor: gradient,
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 4,
                        hoverBackgroundColor: '#10b981',
                        hoverBorderColor: '#fff',
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Price: ‚Çπ${context.raw.toFixed(2)}/kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: {
                                    size: 10
                                },
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                font: {
                                    size: 10
                                },
                                callback: function (value) {
                                    return '‚Çπ' + value;
                                }
                            }
                        }
                    }
                }
            });

            // Update summary info
            document.getElementById('trend-commodity-name').textContent = data.commodity;

            // Update location info based on data level
            const locationInfo = document.getElementById('trend-location-info');
            if (data.data_level === 'district') {
                locationInfo.textContent = `Price analysis in {{ user.district }}`;
            } else if (data.data_level === 'state') {
                locationInfo.textContent = `Price analysis in {{ user.state }} Avg`;
            } else {
                locationInfo.textContent = `Price analysis (National Avg)`;
            }

            document.getElementById('trend-direction').textContent = data.analysis.direction;
            document.getElementById('trend-change').textContent = (data.analysis.change_percent >= 0 ? '+' : '') + data.analysis.change_percent + '%';

            const directionIcon = document.getElementById('trend-direction-icon');
            if (data.analysis.direction === 'Rising') {
                directionIcon.className = 'fas fa-arrow-trend-up';
                directionIcon.style.color = '#10b981';
                document.getElementById('trend-change').style.color = '#10b981';
                document.getElementById('trend-recommendation').innerHTML = '<span style="color: #ef4444; font-weight: 700;">Wait</span> - Price is increasing, consider selling after 3 days.';
            } else if (data.analysis.direction === 'Falling') {
                directionIcon.className = 'fas fa-arrow-trend-down';
                directionIcon.style.color = '#ef4444';
                document.getElementById('trend-change').style.color = '#ef4444';
                document.getElementById('trend-recommendation').innerHTML = '<span style="color: #10b981; font-weight: 700;">Sell Now</span> - Price might drop further, sell today.';
            } else {
                directionIcon.className = 'fas fa-arrows-left-right';
                directionIcon.style.color = '#f97316';
                document.getElementById('trend-change').style.color = '#f97316';
                document.getElementById('trend-recommendation').innerHTML = '<span style="color: #f97316; font-weight: 700;">Hold/Sell</span> - Price is stable, you can sell if needed.';
            }
        }

        // Function to scroll to trend and load it
        function viewTrend(commodity) {
            const select = document.getElementById('commodity-select');
            if (select) select.value = commodity;

            document.getElementById('trend-commodity-name').textContent = commodity;
            loadPriceTrend(commodity);
            document.getElementById('trend-card').scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize trend on load
        document.addEventListener('DOMContentLoaded', function () {
            // Populate commodity select dropdown with specific list of crops
            const commodities = [
                "Potato", "Tomato", "Onion", "Carrot", "Cabbage", "Cauliflower", "Spinach",
                "Brinjal (Eggplant)", "Lady's Finger (Okra)", "Beetroot", "Radish",
                "Capsicum", "Pumpkin", "Bottle Gourd", "Bitter Gourd", "Ridge Gourd",
                "Green Peas", "Beans", "Mushrooms", "Corn", "Apple", "Banana",
                "Mango", "Orange", "Grapes", "Papaya", "Pineapple", "Guava",
                "Watermelon", "Muskmelon", "Pomegranate", "Strawberry", "Cherry",
                "Kiwi", "Lemon", "Pear", "Peach", "Plum", "Coconut", "Custard Apple"
            ];

            const select = document.getElementById('commodity-select');
            if (select) {
                // Add unique sorted commodities
                [...new Set(commodities)].sort().forEach(c => {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    option.style.backgroundColor = "#1e293b"; // Ensure readable in dark mode
                    option.style.color = "white";
                    select.appendChild(option);
                });
            }

            const defaultCommodity = "{{ price_predictions[0].commodity if price_predictions else (market_prices[0].commodity if market_prices else 'Tomato') }}";
            if (defaultCommodity) {
                if (select) select.value = defaultCommodity;
                setTimeout(() => loadPriceTrend(defaultCommodity), 1000);
            }
        });

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const messagesContainer = document.getElementById('chatMessages');

            // Add user message
            messagesContainer.innerHTML += `
        <div class="chat-message user">
            <div class="message-avatar">üë§</div>
            <div class="message-content">${message}</div>
        </div>
    `;

            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Send to server
            fetch('/chat/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('API Response:', data);

                    // Check if the response was successful
                    if (data.success && data.response) {
                        messagesContainer.innerHTML += `
            <div class="chat-message bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">${data.response}</div>
            </div>
        `;
                    } else {
                        // Handle error response
                        const errorMsg = data.error || 'Sorry, I couldn\'t process your request. Please try again.';
                        messagesContainer.innerHTML += `
            <div class="chat-message bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">${errorMsg}</div>
            </div>
        `;
                    }
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    messagesContainer.innerHTML += `
            <div class="chat-message bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">Sorry, I couldn't process your request. Please try again.</div>
            </div>
        `;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        // Modal Functions
        function openProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function openWeatherModal() {
            document.getElementById('weatherModal').style.display = 'flex';
            // Automatically fetch weather by location when modal opens
            fetchWeatherByLocation();
        }

        function closeWeatherModal() {
            document.getElementById('weatherModal').style.display = 'none';
        }

        // Weather Functions
        function getWeatherIcon(code) {
            if (code === 0) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return '‚ùÑÔ∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        function displayWeather(data, locationName) {
            const current = data.current;
            const weatherIcon = getWeatherIcon(current.weather_code || 0);

            // Only update the modal content - NOT the dashboard card
            document.getElementById('weatherModalContent').innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="font-size: 64px;">${weatherIcon}</div>
            <h2 style="margin: 12px 0 4px 0;">${Math.round(current.temperature_2m)}¬∞C</h2>
            <p style="color: var(--text-secondary); margin: 0;">${locationName || 'Current Location'}</p>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px;">
                <div style="padding: 16px; background: var(--body-bg); border-radius: 8px;">
                    <div style="font-size: 24px;">üíß</div>
                    <div style="font-weight: 700;">${current.relative_humidity_2m}%</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Humidity</div>
                </div>
                <div style="padding: 16px; background: var(--body-bg); border-radius: 8px;">
                    <div style="font-size: 24px;">üí®</div>
                    <div style="font-weight: 700;">${Math.round(current.wind_speed_10m)} km/h</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Wind</div>
                </div>
                <div style="padding: 16px; background: var(--body-bg); border-radius: 8px;">
                    <div style="font-size: 24px;">üëÅÔ∏è</div>
                    <div style="font-weight: 700;">${(current.visibility / 1000).toFixed(1)} km</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Visibility</div>
                </div>
            </div>
        </div>
    `;
        }

        function searchWeatherByCity() {
            const cityInput = document.getElementById('citySearchInput');
            const city = cityInput.value.trim();

            if (!city) {
                alert('Please enter a city name');
                return;
            }

            document.getElementById('weatherModalContent').innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px; color: var(--text-secondary);">Searching for ${city}...</p>
        </div>
    `;

            // Use Open-Meteo Geocoding API to get coordinates
            fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`)
                .then(response => response.json())
                .then(geoData => {
                    if (!geoData.results || geoData.results.length === 0) {
                        document.getElementById('weatherModalContent').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #dc2626;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>City not found. Please try another city name.</p>
                    </div>
                `;
                        return;
                    }

                    const location = geoData.results[0];
                    const locationName = `${location.name}${location.admin1 ? ', ' + location.admin1 : ''}${location.country ? ', ' + location.country : ''}`;

                    // Fetch weather for coordinates
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,visibility,weather_code&timezone=auto`)
                        .then(response => response.json())
                        .then(data => {
                            displayWeather(data, locationName);
                        })
                        .catch(error => {
                            document.getElementById('weatherModalContent').innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #dc2626;">
                            <p>Error fetching weather data. Please try again.</p>
                        </div>
                    `;
                        });
                })
                .catch(error => {
                    document.getElementById('weatherModalContent').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #dc2626;">
                    <p>Error searching for city. Please try again.</p>
                </div>
            `;
                });
        }

        function fetchWeatherByLocation() {
            document.getElementById('weatherModalContent').innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px; color: var(--text-secondary);">Getting your location...</p>
        </div>
    `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,visibility,weather_code&timezone=auto`)
                            .then(response => response.json())
                            .then(data => {
                                displayWeather(data, 'Your Location');
                            })
                            .catch(error => {
                                document.getElementById('weatherModalContent').innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #dc2626;">
                                <p>Error fetching weather data. Please try again.</p>
                            </div>
                        `;
                            });
                    },
                    error => {
                        document.getElementById('weatherModalContent').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #dc2626;">
                        <i class="fas fa-location-arrow" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Please enable location access to use this feature.</p>
                        <p style="font-size: 12px; margin-top: 8px;">Or search for a city above.</p>
                    </div>
                `;
                    }
                );
            } else {
                document.getElementById('weatherModalContent').innerHTML = `
            <div style="text-align: center; padding: 30px; color: #dc2626;">
                <p>Geolocation is not supported by your browser. Please search for a city.</p>
            </div>
        `;
            }
        }

        function openCalculatorModal() {
            document.getElementById('calculatorModal').style.display = 'flex';
            // Set default date to today
            const entryDateInput = document.getElementById('entryDate');
            if (entryDateInput && !entryDateInput.value) {
                entryDateInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function closeCalculatorModal() {
            document.getElementById('calculatorModal').style.display = 'none';
        }

        function openGovtSchemesModal() {
            document.getElementById('govtSchemesModal').style.display = 'flex';
        }

        function closeGovtSchemesModal() {
            document.getElementById('govtSchemesModal').style.display = 'none';
        }

        function openEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'flex';
            fetchEquipmentings();
        }

        function closeEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'none';
            // Reset to view mode
            const form = document.getElementById('equipmentListingForm');
            const list = document.getElementById('equipmentListContainer');
            const btn = document.getElementById('toggleEquipFormBtn');
            form.style.display = 'none';
            list.style.display = 'grid';
            btn.innerHTML = '<i class="fas fa-plus"></i> List Your Equipment';
        }

        function toggleEquipmentForm() {
            const form = document.getElementById('equipmentListingForm');
            const list = document.getElementById('equipmentListContainer');
            const btn = document.getElementById('toggleEquipFormBtn');
            const title = document.getElementById('equipmentModalTitle');
            const subtitle = document.getElementById('equipmentModalSubtitle');

            if (form.style.display === 'none') {
                form.style.display = 'block';
                list.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-list"></i> View Listings';
                title.textContent = 'List Equipment';
                subtitle.textContent = 'Help fellow farmers by sharing your machinery.';
            } else {
                form.style.display = 'none';
                list.style.display = 'grid';
                btn.innerHTML = '<i class="fas fa-plus"></i> List Your Equipment';
                title.textContent = 'Rent Farm Machinery';
                subtitle.textContent = 'Connect with local farmers to share equipment and reduce costs.';
                fetchEquipmentings();
            }
        }

        const currentUserId = "{{ user.id | default(user._id) | default('') }}";

        function fetchEquipmentings() {
            const container = document.getElementById('equipmentListContainer');

            fetch('/api/equipment')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        container.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üöú</div>
                                <h4 style="color: var(--text-primary);">No equipment listed yet</h4>
                                <p style="color: var(--text-secondary);">Be the first to list your equipment!</p>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = data.map(item => {
                        const isOwner = item.owner_id === currentUserId;
                        let btnText = 'Rent Now';
                        let btnDisabled = '';
                        let btnStyle = '';

                        if (isOwner) {
                            btnText = 'Your Listing';
                            btnDisabled = 'disabled';
                            btnStyle = 'background: #3b82f6; opacity: 0.8; cursor: default;';
                        } else if (item.status === 'rented') {
                            btnText = 'Rented';
                            btnDisabled = 'disabled';
                            btnStyle = 'background: #94a3b8;';
                        } else if (item.status === 'requested') {
                            btnText = 'Requested';
                            btnDisabled = 'disabled';
                            btnStyle = 'background: #f59e0b; cursor: default;';
                        }

                        return `
                        <div class="equipment-card">
                            <div class="equipment-image">
                                ${item.image_emoji || 'üöú'} 
                                <div class="equipment-badge" style="background: ${item.status === 'available' ? '#dcfce7' : item.status === 'requested' ? '#fef3c7' : '#fee2e2'}; color: ${item.status === 'available' ? '#166534' : item.status === 'requested' ? '#92400e' : '#991b1b'};">
                                    ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                                </div>
                            </div>
                            <div class="equipment-content">
                                <h4 class="equipment-title">${item.name}</h4>
                                <div class="equipment-location"><i class="fas fa-map-marker-alt"></i> ${item.location}</div>
                                <div class="equipment-stats">
                                    <div class="equipment-stat-box">
                                        <div class="equipment-stat-label">Rate</div>
                                        <div class="equipment-stat-value" style="color: #4f46e5;">‚Çπ${item.rate}/${item.rate_unit}</div>
                                    </div>
                                    <div class="equipment-stat-box">
                                        <div class="equipment-stat-label">Owner</div>
                                        <div class="equipment-stat-value">${item.owner_name}</div>
                                    </div>
                                </div>
                                <button class="rent-btn" onclick="rentEquipment('${item._id}')" ${btnDisabled} style="${btnStyle}">
                                    ${btnText}
                                </button>
                            </div>
                        </div>
                    `}).join('');
                })
                .catch(err => {
                    console.error('Error fetching equipment:', err);
                    container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--accent-red);">Error loading listings. Please try again.</p>';
                });
        }

        function handleRentalAction(action, equipmentId, notificationId, requesterId) {
            fetch(`/api/equipment/${equipmentId}/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notification_id: notificationId,
                    requester_id: requesterId
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Request ${action === 'accept' ? 'accepted' : 'rejected'} successfully`, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showToast(data.error || 'Action failed', 'error');
                    }
                })
                .catch(err => console.error('Error:', err));
        }


        function submitEquipmentListing() {
            const submitBtn = document.querySelector('#addEquipmentForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Listing...';

            const data = {
                name: document.getElementById('equipName').value,
                type: document.getElementById('equipType').value,
                rate: document.getElementById('equipRate').value,
                rate_unit: document.getElementById('equipRateUnit').value,
                description: document.getElementById('equipDesc').value,
                image_emoji: document.getElementById('equipType').value === 'Tractor' ? 'üöú' :
                    document.getElementById('equipType').value === 'Sprayer' ? 'üöø' :
                        document.getElementById('equipType').value === 'Harvester' ? 'üåæ' :
                            document.getElementById('equipType').value === 'Plough' ? '‚õèÔ∏è' : 'üõ†Ô∏è'
            };

            fetch('/api/equipment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(res => {
                    if (res.success) {
                        showToast('Equipment listed successfully!', 'success');
                        document.getElementById('addEquipmentForm').reset();
                        toggleEquipmentForm();
                    } else {
                        showToast(res.error || 'Failed to list equipment', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error listing equipment:', err);
                    showToast('An error occurred. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'List Equipment';
                });
        }

        function rentEquipment(id) {
            if (!confirm('Are you sure you want to rent this equipment?')) return;

            fetch(`/api/equipment/${id}/rent`, { method: 'POST' })
                .then(response => response.json())
                .then(res => {
                    if (res.success) {
                        showToast('Rental request sent successfully!', 'success');
                        fetchEquipmentings();
                    } else {
                        showToast(res.error || 'Failed to rent equipment', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error renting equipment:', err);
                    showToast('An error occurred. Please try again.', 'error');
                });
        }

        // Expense Calculator Variables and Functions
        let expenseChart = null;
        const expenseHistory = [];

        // Benchmark data for different crops (‚Çπ per acre)
        const cropBenchmarks = {
            // Cereals
            rice: { seed: 2000, fertilizer: 6000, pesticide: 2500, total: 35000 },
            wheat: { seed: 1500, fertilizer: 5000, pesticide: 2000, total: 28000 },
            maize: { seed: 1500, fertilizer: 5000, pesticide: 2000, total: 30000 },

            // Cash Crops
            cotton: { seed: 3000, fertilizer: 7000, pesticide: 4000, total: 42000 },
            sugarcane: { seed: 8000, fertilizer: 10000, pesticide: 3000, total: 60000 },
            jute: { seed: 1000, fertilizer: 3000, pesticide: 1500, total: 25000 },
            coffee: { seed: 5000, fertilizer: 8000, pesticide: 3000, total: 50000 },
            coconut: { seed: 4000, fertilizer: 6000, pesticide: 2000, total: 40000 },
            oilseeds: { seed: 2200, fertilizer: 5500, pesticide: 2800, total: 30000 },

            // Pulses & Legumes (Standardized average)
            pulses: { seed: 1800, fertilizer: 4000, pesticide: 1500, total: 22000 },
            blackgram: { seed: 1800, fertilizer: 4000, pesticide: 1500, total: 22000 },
            chickpea: { seed: 2000, fertilizer: 4500, pesticide: 1500, total: 25000 },
            kidneybeans: { seed: 2000, fertilizer: 4500, pesticide: 2000, total: 26000 },
            lentil: { seed: 1500, fertilizer: 3500, pesticide: 1500, total: 20000 },
            mothbeans: { seed: 1500, fertilizer: 3000, pesticide: 1000, total: 18000 },
            mungbean: { seed: 1800, fertilizer: 4000, pesticide: 1500, total: 22000 },
            pigeonpeas: { seed: 2000, fertilizer: 4500, pesticide: 2000, total: 24000 },
            greenpeas: { seed: 2500, fertilizer: 5000, pesticide: 2500, total: 30000 },
            beans: { seed: 2000, fertilizer: 4500, pesticide: 2000, total: 28000 },

            // Vegetables (Standardized average)
            vegetables: { seed: 4000, fertilizer: 8000, pesticide: 3500, total: 45000 },
            potato: { seed: 15000, fertilizer: 8000, pesticide: 4000, total: 55000 },
            tomato: { seed: 5000, fertilizer: 10000, pesticide: 5000, total: 60000 },
            onion: { seed: 4000, fertilizer: 8000, pesticide: 3500, total: 50000 },
            carrot: { seed: 3000, fertilizer: 6000, pesticide: 2500, total: 40000 },
            cabbage: { seed: 2500, fertilizer: 6000, pesticide: 3000, total: 40000 },
            cauliflower: { seed: 2500, fertilizer: 6000, pesticide: 3000, total: 40000 },
            spinach: { seed: 2000, fertilizer: 4000, pesticide: 1500, total: 25000 },
            brinjal: { seed: 3000, fertilizer: 7000, pesticide: 4000, total: 45000 },
            okra: { seed: 3000, fertilizer: 6000, pesticide: 3500, total: 40000 },
            beetroot: { seed: 3000, fertilizer: 6000, pesticide: 2500, total: 35000 },
            radish: { seed: 1500, fertilizer: 4000, pesticide: 1500, total: 25000 },
            capsicum: { seed: 10000, fertilizer: 12000, pesticide: 6000, total: 80000 },
            pumpkin: { seed: 2000, fertilizer: 5000, pesticide: 2000, total: 30000 },
            bottlegourd: { seed: 2000, fertilizer: 5000, pesticide: 2000, total: 30000 },
            bittergourd: { seed: 2500, fertilizer: 6000, pesticide: 3000, total: 35000 },
            ridgegourd: { seed: 2000, fertilizer: 5000, pesticide: 2000, total: 30000 },
            mushroom: { seed: 20000, fertilizer: 5000, pesticide: 2000, total: 100000 },

            // Fruits (Standardized average)
            apple: { seed: 20000, fertilizer: 15000, pesticide: 10000, total: 80000 },
            banana: { seed: 10000, fertilizer: 15000, pesticide: 5000, total: 70000 },
            mango: { seed: 5000, fertilizer: 10000, pesticide: 4000, total: 50000 },
            orange: { seed: 8000, fertilizer: 12000, pesticide: 6000, total: 60000 },
            grapes: { seed: 15000, fertilizer: 20000, pesticide: 10000, total: 100000 },
            papaya: { seed: 5000, fertilizer: 10000, pesticide: 3000, total: 50000 },
            pineapple: { seed: 10000, fertilizer: 12000, pesticide: 4000, total: 60000 },
            guava: { seed: 5000, fertilizer: 8000, pesticide: 3000, total: 40000 },
            watermelon: { seed: 5000, fertilizer: 8000, pesticide: 4000, total: 45000 },
            muskmelon: { seed: 6000, fertilizer: 9000, pesticide: 5000, total: 50000 },
            pomegranate: { seed: 10000, fertilizer: 15000, pesticide: 8000, total: 75000 },
            strawberry: { seed: 30000, fertilizer: 20000, pesticide: 10000, total: 120000 },
            cherry: { seed: 25000, fertilizer: 15000, pesticide: 10000, total: 90000 },
            kiwi: { seed: 30000, fertilizer: 20000, pesticide: 10000, total: 100000 },
            lemon: { seed: 5000, fertilizer: 8000, pesticide: 4000, total: 45000 },
            pear: { seed: 10000, fertilizer: 10000, pesticide: 5000, total: 60000 },
            peach: { seed: 10000, fertilizer: 10000, pesticide: 5000, total: 60000 },
            plum: { seed: 10000, fertilizer: 10000, pesticide: 5000, total: 60000 },
            custardapple: { seed: 5000, fertilizer: 6000, pesticide: 3000, total: 40000 }
        };

        function loadBenchmarkData() {
            const cropType = document.getElementById('cropType').value;
            if (!cropType || !cropBenchmarks[cropType]) {
                document.getElementById('seedBenchmark').textContent = '';
                document.getElementById('fertilizerBenchmark').textContent = '';
                document.getElementById('pesticideBenchmark').textContent = '';
                return;
            }

            const benchmark = cropBenchmarks[cropType];
            document.getElementById('seedBenchmark').textContent = `Average: ‚Çπ${benchmark.seed.toLocaleString('en-IN')}/acre`;
            document.getElementById('fertilizerBenchmark').textContent = `Average: ‚Çπ${benchmark.fertilizer.toLocaleString('en-IN')}/acre`;
            document.getElementById('pesticideBenchmark').textContent = `Average: ‚Çπ${benchmark.pesticide.toLocaleString('en-IN')}/acre`;
        }

        function calculateTotal() {
            // Get expense values
            const seed = parseFloat(document.getElementById('seedCost')?.value) || 0;
            const fertilizer = parseFloat(document.getElementById('fertilizerCost')?.value) || 0;
            const pesticide = parseFloat(document.getElementById('pesticideCost')?.value) || 0;
            const irrigation = parseFloat(document.getElementById('irrigationCost')?.value) || 0;
            const labor = parseFloat(document.getElementById('laborCost')?.value) || 0;
            const machinery = parseFloat(document.getElementById('machineryCost')?.value) || 0;
            const other = parseFloat(document.getElementById('otherCost')?.value) || 0;

            const total = seed + fertilizer + pesticide + irrigation + labor + machinery + other;

            // Update displays
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            updateElement('totalExpense', '‚Çπ' + total.toLocaleString('en-IN'));
            updateElement('seedDisplay', '‚Çπ' + seed.toLocaleString('en-IN'));
            updateElement('fertilizerDisplay', '‚Çπ' + fertilizer.toLocaleString('en-IN'));
            updateElement('pesticideDisplay', '‚Çπ' + pesticide.toLocaleString('en-IN'));
            updateElement('irrigationDisplay', '‚Çπ' + irrigation.toLocaleString('en-IN'));
            updateElement('laborDisplay', '‚Çπ' + labor.toLocaleString('en-IN'));
            updateElement('machineryDisplay', '‚Çπ' + machinery.toLocaleString('en-IN'));
            updateElement('otherDisplay', '‚Çπ' + other.toLocaleString('en-IN'));

            // Update chart
            updateExpenseChart([seed, fertilizer, pesticide, irrigation, labor, machinery, other]);

            // Calculate cost per acre
            const landArea = parseFloat(document.getElementById('landArea')?.value) || 0;
            if (landArea > 0) {
                const perAcre = total / landArea;
                updateElement('costPerAcre', '‚Çπ' + perAcre.toLocaleString('en-IN', { maximumFractionDigits: 2 }) + ' per acre');

                // Benchmark comparison
                const cropType = document.getElementById('cropType')?.value;
                if (cropType && cropBenchmarks[cropType]) {
                    const benchmark = cropBenchmarks[cropType].total;
                    const diff = perAcre - benchmark;
                    const diffPercent = ((diff / benchmark) * 100).toFixed(1);
                    const benchmarkEl = document.getElementById('benchmarkComparison');
                    if (benchmarkEl) {
                        if (diff > 0) {
                            benchmarkEl.textContent = `‚Çπ${Math.abs(diff).toLocaleString('en-IN', { maximumFractionDigits: 0 })} (${diffPercent}%) above average`;
                            benchmarkEl.style.color = '#d32f2f';
                        } else if (diff < 0) {
                            benchmarkEl.textContent = `‚Çπ${Math.abs(diff).toLocaleString('en-IN', { maximumFractionDigits: 0 })} (${Math.abs(diffPercent)}%) below average`;
                            benchmarkEl.style.color = '#388e3c';
                        } else {
                            benchmarkEl.textContent = 'At average cost';
                            benchmarkEl.style.color = '#1976d2';
                        }
                    }
                }
            } else {
                updateElement('costPerAcre', '‚Çπ0 per acre');
            }

            // Calculate revenue and profit
            const yieldQty = parseFloat(document.getElementById('expectedYield')?.value) || 0;
            const marketPrice = parseFloat(document.getElementById('marketPrice')?.value) || 0;
            const revenue = yieldQty * marketPrice;
            const profit = revenue - total;
            const profitMargin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;

            updateElement('totalRevenue', '‚Çπ' + revenue.toLocaleString('en-IN'));
            updateElement('netProfit', '‚Çπ' + profit.toLocaleString('en-IN'));
            updateElement('profitMargin', `Profit Margin: ${profitMargin}%`);

            // Update profit card color
            const profitCard = document.getElementById('profitCard');
            if (profitCard) {
                if (profit > 0) {
                    profitCard.style.background = 'linear-gradient(135deg, #4caf50, #2e7d32)';
                } else if (profit < 0) {
                    profitCard.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
                } else {
                    profitCard.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
                }
            }

            // Calculate break-even price
            if (yieldQty > 0) {
                const minPrice = total / yieldQty;
                updateElement('minPrice', '‚Çπ' + minPrice.toLocaleString('en-IN', { maximumFractionDigits: 2 }) + ' per quintal');
            }

            // Calculate break-even quantity
            if (marketPrice > 0) {
                const breakEvenQty = total / marketPrice;
                updateElement('breakEvenQty', breakEvenQty.toLocaleString('en-IN', { maximumFractionDigits: 2 }) + ' quintals');
            }
        }

        function updateExpenseChart(data) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx || typeof Chart === 'undefined') return;

            if (expenseChart) {
                expenseChart.destroy();
            }

            try {
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Seeds', 'Fertilizers', 'Pesticides', 'Irrigation', 'Labor', 'Machinery', 'Other'],
                        datasets: [{
                            data: data,
                            backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#00bcd4', '#9c27b0', '#f44336', '#607d8b'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ‚Çπ${value.toLocaleString('en-IN')} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
            }
        }

        function calculateLoan() {
            const principal = parseFloat(document.getElementById('loanAmount')?.value) || 0;
            const annualRate = parseFloat(document.getElementById('interestRate')?.value) || 0;
            const months = parseFloat(document.getElementById('loanPeriod')?.value) || 0;

            if (principal > 0 && annualRate > 0 && months > 0) {
                const monthlyRate = (annualRate / 12) / 100;
                const emi = (principal * monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
                const totalAmount = emi * months;
                const totalInterest = totalAmount - principal;

                document.getElementById('monthlyEMI').textContent = '‚Çπ' + emi.toLocaleString('en-IN', { maximumFractionDigits: 0 });
                document.getElementById('totalInterest').textContent = '‚Çπ' + totalInterest.toLocaleString('en-IN', { maximumFractionDigits: 0 });
                document.getElementById('totalAmount').textContent = '‚Çπ' + totalAmount.toLocaleString('en-IN', { maximumFractionDigits: 0 });
            } else {
                document.getElementById('monthlyEMI').textContent = '‚Çπ0';
                document.getElementById('totalInterest').textContent = '‚Çπ0';
                document.getElementById('totalAmount').textContent = '‚Çπ0';
            }
        }

        async function saveExpenseEntry() {
            const entry = {
                date: document.getElementById('entryDate')?.value,
                cropType: document.getElementById('cropType')?.value,
                season: document.getElementById('seasonType')?.value,
                expenses: {
                    seed: parseFloat(document.getElementById('seedCost')?.value) || 0,
                    fertilizer: parseFloat(document.getElementById('fertilizerCost')?.value) || 0,
                    pesticide: parseFloat(document.getElementById('pesticideCost')?.value) || 0,
                    irrigation: parseFloat(document.getElementById('irrigationCost')?.value) || 0,
                    labor: parseFloat(document.getElementById('laborCost')?.value) || 0,
                    machinery: parseFloat(document.getElementById('machineryCost')?.value) || 0,
                    other: parseFloat(document.getElementById('otherCost')?.value) || 0
                },
                landArea: parseFloat(document.getElementById('landArea')?.value) || 0,
                expectedYield: parseFloat(document.getElementById('expectedYield')?.value) || 0,
                marketPrice: parseFloat(document.getElementById('marketPrice')?.value) || 0
            };

            if (!entry.date) {
                alert('Please select an entry date');
                return;
            }

            const total = Object.values(entry.expenses).reduce((a, b) => a + b, 0);
            entry.total = total;
            entry.revenue = entry.expectedYield * entry.marketPrice;
            entry.profit = entry.revenue - total;

            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(entry)
                });

                const result = await response.json();
                if (result.success) {
                    expenseHistory.push(entry);
                    localStorage.setItem('farmExpenseHistory', JSON.stringify(expenseHistory));
                    alert('‚úÖ Expense entry saved successfully to database!');
                } else {
                    alert('‚ùå Failed to save to database: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving expense:', error);
                // Fallback to local storage if API fails
                expenseHistory.push(entry);
                localStorage.setItem('farmExpenseHistory', JSON.stringify(expenseHistory));
                alert('‚ö†Ô∏è Saved to local storage (Backend unavailable)');
            }
        }

        function toggleNotificationPanel() {
            document.getElementById('notificationModal').style.display = 'flex';
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        function openDownloadModal() {
            document.getElementById('downloadModal').style.display = 'flex';
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }

        function exportToPDF() {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('PDF library is loading. Please try again in a moment.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.setTextColor(45, 106, 79);
            doc.text('Farming Expense Report', 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });

            const cropType = document.getElementById('cropType')?.value || 'Not specified';
            const season = document.getElementById('seasonType')?.value || 'Not specified';
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Crop: ${cropType.charAt(0).toUpperCase() + cropType.slice(1)}`, 20, 40);
            doc.text(`Season: ${season.charAt(0).toUpperCase() + season.slice(1)}`, 20, 47);

            doc.setFontSize(14);
            doc.setTextColor(45, 106, 79);
            doc.text('Expense Breakdown:', 20, 60);

            doc.setFontSize(11);
            doc.setTextColor(0);
            let y = 70;

            const expenses = [
                ['Seeds & Planting', document.getElementById('seedCost')?.value || '0'],
                ['Fertilizers', document.getElementById('fertilizerCost')?.value || '0'],
                ['Pesticides', document.getElementById('pesticideCost')?.value || '0'],
                ['Irrigation', document.getElementById('irrigationCost')?.value || '0'],
                ['Labor', document.getElementById('laborCost')?.value || '0'],
                ['Machinery', document.getElementById('machineryCost')?.value || '0'],
                ['Other', document.getElementById('otherCost')?.value || '0']
            ];

            expenses.forEach(([label, value]) => {
                doc.text(label + ':', 25, y);
                doc.text('Rs. ' + parseFloat(value).toLocaleString('en-IN'), 180, y, { align: 'right' });
                y += 8;
            });

            doc.setDrawColor(45, 106, 79);
            doc.line(20, y, 190, y);
            y += 8;
            doc.setFontSize(13);
            doc.text('Total Expenses:', 25, y);
            doc.text(document.getElementById('totalExpense')?.textContent || '‚Çπ0', 180, y, { align: 'right' });

            y += 15;
            doc.setFontSize(11);
            doc.text('Total Revenue:', 25, y);
            doc.text(document.getElementById('totalRevenue')?.textContent || '‚Çπ0', 180, y, { align: 'right' });
            y += 8;
            doc.text('Net Profit:', 25, y);
            doc.text(document.getElementById('netProfit')?.textContent || '‚Çπ0', 180, y, { align: 'right' });

            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text('Smart Farming Assistant - Your Digital Agriculture Partner', 105, 280, { align: 'center' });

            doc.save(`farming-expense-report-${new Date().toISOString().split('T')[0]}.pdf`);
            alert('üìÑ PDF report generated successfully!');
        }

        async function generateReport(cardElement, reportName) {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                alert('PDF library is loading. Please try again in a moment.');
                return;
            }

            // Add loading state
            cardElement.classList.add('report-loading');
            const btnIcon = cardElement.querySelector('.report-btn i') || cardElement.querySelector('.download-icon-box i') || cardElement.querySelector('i');
            let originalIconClass = '';
            if (btnIcon) {
                originalIconClass = btnIcon.className;
                btnIcon.className = 'fas fa-spinner fa-spin';
            }

            // Show toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `<div class="toast-content"><i class="fas fa-cog fa-spin"></i> Generating ${reportName}...</div>`;
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out;';
            document.body.appendChild(toast);

            try {
                // Fetch real data from API
                let apiEndpoint = '';
                if (reportName === 'Crop Plan PDF') {
                    apiEndpoint = '/api/report/crop-plan';
                } else if (reportName === 'Harvest Report') {
                    apiEndpoint = '/api/report/harvest';
                } else if (reportName === 'Profit Summary') {
                    apiEndpoint = '/api/report/profit';
                } else if (reportName === 'Market Report') {
                    apiEndpoint = '/api/report/market-watch';
                } else if (reportName === 'Weather Report') {
                    apiEndpoint = '/api/report/weather';
                }

                const response = await fetch(apiEndpoint);
                const result = await response.json();

                // Check if data is available
                if (!result.success || !result.data) {
                    cardElement.classList.remove('report-loading');
                    if (btnIcon) btnIcon.className = originalIconClass;

                    // Show "Not Found" message
                    toast.innerHTML = `<div class="toast-content"><i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i> ${result.message || 'No data available'}</div>`;
                    toast.style.background = '#fef3c7';
                    toast.style.color = '#92400e';
                    toast.style.border = '2px solid #fbbf24';

                    setTimeout(() => {
                        toast.style.animation = 'slideOut 0.3s ease-in';
                        setTimeout(() => toast.remove(), 300);
                    }, 4000);

                    return;
                }

                // Generate PDF with real data
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const today = new Date().toLocaleDateString();
                const reportData = result.data;

                // Header
                doc.setFontSize(22);
                doc.setTextColor(45, 106, 79); // Dark Green
                doc.text(reportName, 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated on: ${today}`, 105, 28, { align: 'center' });
                doc.text(`Farmer: ${reportData.user.name}`, 105, 34, { align: 'center' });
                if (reportData.user.district) {
                    doc.text(`Location: ${reportData.user.district}, ${reportData.user.state}`, 105, 40, { align: 'center' });
                }

                doc.setLineWidth(0.5);
                doc.setDrawColor(200);
                doc.line(20, 45, 190, 45);

                // Content based on report type
                let y = 55;
                doc.setFontSize(12);
                doc.setTextColor(0);

                if (reportName === 'Crop Plan PDF') {
                    // PREMIUM REDESIGN: CROP PLAN
                    doc.setFillColor(6, 78, 59);
                    doc.rect(0, y - 5, 210, 25, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(255);
                    doc.text('CROP CULTIVATION & PLANNING', 105, y + 10, { align: 'center' });
                    y += 35;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100);
                    doc.text(`Active cultivation status and scheduling for ${reportData.crops.length} crops.`, 20, y);
                    y += 15;

                    // KPI Cards
                    const dCW = 82;
                    const dCH = 25;
                    const dGap = 6;

                    doc.setFillColor(16, 185, 129);
                    doc.roundedRect(20, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.text('TOTAL ACTIVE CROPS', 20 + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${reportData.crops.length}`, 20 + dCW / 2, y + 18, { align: 'center' });

                    const avgProgress = reportData.crops.length > 0 ? (reportData.crops.reduce((acc, c) => acc + (parseInt(c.progress) || 0), 0) / reportData.crops.length).toFixed(0) : 0;
                    doc.setFillColor(5, 150, 105);
                    doc.roundedRect(20 + dCW + dGap, y, dCW, dCH, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text('AVG. MATURITY PROGRESS', 20 + dCW + dGap + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${avgProgress}%`, 20 + dCW + dGap + dCW / 2, y + 18, { align: 'center' });

                    y += dCH + 15;

                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    doc.text('Current Field Activities', 20, y);
                    y += 8;

                    reportData.crops.forEach((crop, index) => {
                        doc.setFillColor(248, 250, 252);
                        doc.roundedRect(20, y, 170, 32, 2, 2, 'F');

                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(11);
                        doc.setTextColor(6, 78, 59);
                        doc.text(`${crop.crop.toUpperCase()}`, 25, y + 8);

                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(9);
                        doc.setTextColor(71, 85, 105);
                        doc.text(`Started: ${crop.started}`, 25, y + 15);
                        doc.text(`Stage: ${crop.stage}`, 25, y + 21);
                        doc.text(`Current Day: ${crop.current_day}`, 25, y + 27);

                        // Progress bar in card
                        const progW = 60;
                        doc.setFillColor(226, 232, 240);
                        doc.rect(120, y + 12, progW, 3, 'F');
                        doc.setFillColor(16, 185, 129);
                        doc.rect(120, y + 12, (parseInt(crop.progress) / 100) * progW, 3, 'F');

                        doc.setFont("helvetica", "bold");
                        doc.text(`${crop.progress}% COMPLETE`, 120, y + 10);

                        y += 38;
                        if (y > 260) {
                            doc.addPage();
                            y = 20;
                        }
                    });


                } else if (reportName === 'Profit Summary') {
                    // PREMIUM DASHBOARD REDESIGN
                    doc.setFillColor(15, 23, 42);
                    doc.rect(0, y - 5, 210, 25, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(255);
                    doc.text('FINANCIAL PERFORMANCE DASHBOARD', 105, y + 10, { align: 'center' });
                    y += 35;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100);
                    doc.text(`Comprehensive financial analysis based on ${reportData.total_entries} cumulative expense records.`, 20, y);
                    y += 15;

                    // Row 1: KPI Cards (Revenue, Expenses, Profit)
                    const dCW = 55;
                    const dCH = 32;
                    const dGap = 5;
                    let curX = 17.5;

                    // Total Revenue Card - Cyan
                    doc.setFillColor(8, 145, 178);
                    doc.roundedRect(curX, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.text('TOTAL REVENUE', curX + dCW / 2, y + 10, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`‚Çπ${reportData.total_revenue.toLocaleString('en-IN')}`, curX + dCW / 2, y + 22, { align: 'center' });

                    // Total Expenses Card - Rose
                    curX += dCW + dGap;
                    doc.setFillColor(225, 29, 72);
                    doc.roundedRect(curX, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text('TOTAL EXPENSES', curX + dCW / 2, y + 10, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`‚Çπ${reportData.total_expenses.toLocaleString('en-IN')}`, curX + dCW / 2, y + 22, { align: 'center' });

                    // Net Profit Card - Emerald
                    curX += dCW + dGap;
                    const isProfit = reportData.net_profit >= 0;
                    doc.setFillColor(isProfit ? 16 : 220, isProfit ? 185 : 38, isProfit ? 129 : 38);
                    doc.roundedRect(curX, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text('NET PROFIT', curX + dCW / 2, y + 10, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`‚Çπ${reportData.net_profit.toLocaleString('en-IN')}`, curX + dCW / 2, y + 22, { align: 'center' });

                    y += dCH + 12;

                    // Summary Utility Bar
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(20, y, 170, 12, 2, 2, 'F');
                    doc.setTextColor(71, 85, 105);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "bold");
                    doc.text(`ROI Analysis: ${reportData.roi.toFixed(2)}%`, 45, y + 8);
                    const netMargin = reportData.total_revenue > 0 ? ((reportData.net_profit / reportData.total_revenue) * 100).toFixed(1) : 0;
                    doc.text(`Profit Margin: ${netMargin}%`, 135, y + 8);

                    y += 22;

                    // Visual Comparison Section
                    doc.setFontSize(12);
                    doc.setTextColor(15, 23, 42);
                    doc.text('Revenue vs Expenditure Visual Comparison', 20, y);
                    y += 8;

                    const mValue = Math.max(reportData.total_revenue, reportData.total_expenses);
                    const barW = 120;
                    const rW = reportData.total_revenue > 0 ? (reportData.total_revenue / mValue) * barW : 2;
                    const eW = reportData.total_expenses > 0 ? (reportData.total_expenses / mValue) * barW : 2;

                    // Chart Bars
                    doc.setFillColor(8, 145, 178, 0.1);
                    doc.rect(50, y, barW, 6, 'F');
                    doc.setFillColor(8, 145, 178);
                    doc.rect(50, y, rW, 6, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text('Revenue', 20, y + 4.5);
                    y += 10;

                    doc.setFillColor(225, 29, 72, 0.1);
                    doc.rect(50, y, barW, 6, 'F');
                    doc.setFillColor(225, 29, 72);
                    doc.rect(50, y, eW, 6, 'F');
                    doc.text('Expenses', 20, y + 4.5);

                    y += 18;

                    // Detailed Analytics Table
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(15, 23, 42);
                    doc.text('Crop-wise Performance Break-down', 20, y);
                    y += 8;

                    // Professional Table Header
                    doc.setFillColor(51, 65, 85);
                    doc.rect(20, y, 170, 8, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.text('CROP TYPE', 25, y + 5.5);
                    doc.text('REVENUE (‚Çπ)', 75, y + 5.5);
                    doc.text('EXPENSES (‚Çπ)', 115, y + 5.5);
                    doc.text('EARNINGS (‚Çπ)', 155, y + 5.5);

                    y += 13;
                    doc.setTextColor(30, 41, 59);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);

                    if (reportData.crop_wise) {
                        for (const [crop, data] of Object.entries(reportData.crop_wise)) {
                            const earnings = data.revenue - data.expenses;
                            doc.text(crop.toUpperCase(), 25, y);
                            doc.text(data.revenue.toLocaleString('en-IN'), 75, y);
                            doc.text(data.expenses.toLocaleString('en-IN'), 115, y);

                            if (earnings >= 0) {
                                doc.setTextColor(16, 185, 129);
                                doc.text(`+${earnings.toLocaleString('en-IN')}`, 155, y);
                            } else {
                                doc.setTextColor(225, 29, 72);
                                doc.text(`-${Math.abs(earnings).toLocaleString('en-IN')}`, 155, y);
                            }
                            doc.setTextColor(30, 41, 59);
                            doc.setDrawColor(241, 245, 249);
                            doc.line(20, y + 2, 190, y + 2);

                            y += 10;
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                        }
                    }

                    y += 15;
                    doc.setFontSize(8);
                    doc.setTextColor(148, 163, 184);
                    doc.text('* Data based on the digital records in Smart Farming Assistant ledger.', 105, y, { align: 'center' });
                } else if (reportName === 'Market Report') {
                    // PREMIUM REDESIGN: MARKET REPORT
                    doc.setFillColor(30, 58, 138); // Dark Blue
                    doc.rect(0, y - 5, 210, 25, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(255);
                    doc.text('REGIONAL MARKET PRICE TRENDS', 105, y + 10, { align: 'center' });
                    y += 35;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100);
                    doc.text(`Latest commodity prices and trends for ${reportData.user.district || 'All Markets'}.`, 20, y);
                    y += 15;

                    // KPI Cards
                    const dCW = 82;
                    const dCH = 25;
                    const dGap = 6;

                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(20, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.text('TRACKED COMMODITIES', 20 + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${reportData.prices ? reportData.prices.length : 0}`, 20 + dCW / 2, y + 18, { align: 'center' });

                    doc.setFillColor(37, 99, 235);
                    doc.roundedRect(20 + dCW + dGap, y, dCW, dCH, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text('REGION FOCUS', 20 + dCW + dGap + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${reportData.user.district || 'State'}`, 20 + dCW + dGap + dCW / 2, y + 18, { align: 'center' });

                    y += dCH + 15;

                    // Professional Table Header
                    doc.setFillColor(30, 41, 59);
                    doc.rect(20, y, 170, 8, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(8);
                    doc.text('COMMODITY', 25, y + 5.5);
                    doc.text('MARKET', 80, y + 5.5);
                    doc.text('PRICE (‚Çπ/Q)', 150, y + 5.5);

                    y += 13;
                    doc.setTextColor(30, 41, 59);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);

                    if (reportData.prices && reportData.prices.length > 0) {
                        reportData.prices.forEach((item, index) => {
                            if (index % 2 === 0) {
                                doc.setFillColor(248, 250, 252);
                                doc.rect(20, y - 5, 170, 8, 'F');
                            }
                            const commodity = item.commodity || 'Unknown';
                            const market = item.market || item.district || 'Local Market';
                            const price = item.modal_price !== undefined ? item.modal_price.toString() : 'N/A';

                            doc.text(commodity.toUpperCase(), 25, y);
                            doc.text(market, 80, y);
                            doc.setFont("helvetica", "bold");
                            doc.text(`‚Çπ${price}`, 150, y);
                            doc.setFont("helvetica", "normal");

                            doc.setDrawColor(241, 245, 249);
                            doc.line(20, y + 2, 190, y + 2);

                            y += 8;
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                        });
                    } else {
                        doc.text('No market data found for your district today.', 25, y);
                    }

                } else if (reportName === 'Weather Report') {
                    // PREMIUM REDESIGN: WEATHER REPORT
                    doc.setFillColor(30, 58, 138); // Dark Blue Focus
                    doc.rect(0, y - 5, 210, 25, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(255);
                    doc.text('METEOROLOGICAL ADVISORY DASHBOARD', 105, y + 10, { align: 'center' });
                    y += 35;

                    const weather = reportData.weather;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100);
                    doc.text(`7-day agricultural forecast and field advisories for ${reportData.user.district}.`, 20, y);
                    y += 15;

                    // KPI Cards
                    const dCW = 54;
                    const dCH = 25;
                    const dGap = 4;

                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(20, y, dCW, dCH, 3, 3, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(7);
                    doc.text('CURRENT TEMP', 20 + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${weather.current.temperature}¬∞C`, 20 + dCW / 2, y + 18, { align: 'center' });

                    doc.setFillColor(37, 99, 235);
                    doc.roundedRect(20 + dCW + dGap, y, dCW, dCH, 3, 3, 'F');
                    doc.setFontSize(7);
                    doc.setFont("helvetica", "normal");
                    doc.text('HUMIDITY', 20 + (dCW + dGap) + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${weather.current.humidity}%`, 20 + (dCW + dGap) + dCW / 2, y + 18, { align: 'center' });

                    doc.setFillColor(29, 78, 216);
                    doc.roundedRect(20 + 2 * (dCW + dGap), y, dCW, dCH, 3, 3, 'F');
                    doc.setFontSize(7);
                    doc.setFont("helvetica", "normal");
                    doc.text('WIND SPEED', 20 + 2 * (dCW + dGap) + dCW / 2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${weather.current.wind_speed} KM/H`, 20 + 2 * (dCW + dGap) + dCW / 2, y + 18, { align: 'center' });

                    y += dCH + 15;

                    doc.setFontSize(11);
                    doc.setTextColor(15, 23, 42);
                    doc.setFont("helvetica", "bold");
                    doc.text('7-Day Daily Forecast:', 20, y);
                    y += 8;

                    // Header for forecast table
                    doc.setFillColor(30, 41, 59);
                    doc.rect(20, y, 175, 8, 'F');
                    doc.setTextColor(255);
                    doc.setFontSize(7);
                    doc.text('DAY', 25, y + 5.5);
                    doc.text('CONDITION', 55, y + 5.5);
                    doc.text('TEMP (L/H)', 95, y + 5.5);
                    doc.text('UV/RAIN', 125, y + 5.5);
                    doc.text('MOON PHASE', 150, y + 5.5);
                    doc.text('WIND', 180, y + 5.5);
                    y += 12;

                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(30, 41, 59);
                    weather.forecast.forEach((day, index) => {
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 250, 252);
                            doc.rect(20, y - 5, 175, 8, 'F');
                        }
                        doc.text(day.day.toUpperCase(), 25, y);
                        doc.text(day.condition.substring(0, 18), 55, y);
                        doc.text(`${day.low}¬∞C - ${day.high}¬∞C`, 95, y);
                        doc.text(`UV ${day.uv || 0} / ${day.rain_chance}%`, 125, y);
                        doc.text(day.moon_phase || 'N/A', 150, y);
                        doc.text(`${day.wind || '-'}kph`, 180, y);

                        doc.setDrawColor(241, 245, 249);
                        doc.line(20, y + 2, 195, y + 2);
                        y += 8;

                        if (y > 275) {
                            doc.addPage();
                            y = 20;
                        }
                    });

                    // Agricultural Advisory
                    y += 12;
                    doc.setFillColor(239, 246, 255);
                    doc.setDrawColor(59, 130, 246);
                    doc.roundedRect(20, y, 170, 40, 2, 2, 'FD');

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.setTextColor(30, 58, 138);
                    doc.text('FIELD-LEVEL AGRICULTURAL ADVISORY:', 25, y + 8);

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    doc.setTextColor(71, 85, 105);

                    const rainDays = weather.forecast.filter(d => d.rain_chance > 40).length;
                    let advText = "";
                    if (rainDays > 2) {
                        advText = "[RAIN ALERT] Heavy rain expected. Postpone irrigation and fertilizer application. Ensure field drainage.";
                    } else if (weather.current.temperature > 35) {
                        advText = "[SUN ALERT] High heat spell. Increase irrigation frequency. Apply mulch to conserve soil moisture.";
                    } else {
                        advText = "[ADVICE] Favorable conditions. Continue standard cultural practices and scheduled activities.";
                    }

                    const lines = doc.splitTextToSize(advText, 160);
                    doc.text(lines, 25, y + 16);
                }

                // Standard Footer & Save logic for all reports
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text('Smart Farming Assistant - Generated via User Dashboard', 105, 280, { align: 'center' });

                const fileName = `${reportName.replace(/\s+/g, '_').toLowerCase()}_${today.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);

                const storageKey = 'last_gen_' + reportName.toLowerCase().replace(/\s+/g, '-');
                localStorage.setItem(storageKey, Date.now());
                if (typeof updateLastGeneratedDates === 'function') updateLastGeneratedDates();

                cardElement.classList.remove('report-loading');
                if (btnIcon) btnIcon.className = originalIconClass;

                toast.innerHTML = `<div class="toast-content"><i class="fas fa-check-circle" style="color: #10b981;"></i> ${reportName} Ready!</div>`;
                toast.style.background = '#ecfdf5';
                toast.style.color = '#065f46';
                toast.style.border = '2px solid #34d399';

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);

            } catch (error) {
                console.error('Report Generation Error:', error);
                if (cardElement) cardElement.classList.remove('report-loading');
                if (btnIcon) btnIcon.className = originalIconClass;
                toast.innerHTML = `<div class="toast-content"><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> Error generating report</div>`;
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        function updateReportHistory() {
            const reports = ['Crop Plan PDF', 'Harvest Report', 'Profit Summary'];

            reports.forEach(name => {
                const lastGen = localStorage.getItem('lastGen_' + name);
                if (lastGen) {
                    const date = new Date(parseInt(lastGen));
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    let text = 'Never';
                    // Check if same day
                    if (date.toDateString() === now.toDateString()) {
                        text = 'Today';
                    } else if (diffDays === 1) {
                        text = 'Yesterday';
                    } else if (diffDays > 1) {
                        text = `${diffDays} days ago`;
                    } else {
                        text = 'Today';
                    }

                    // Select card based on report name
                    let selectorClass = '';
                    if (name === 'Crop Plan PDF') selectorClass = 'crop';
                    else if (name === 'Harvest Report') selectorClass = 'harvest';
                    else if (name === 'Profit Summary') selectorClass = 'profit';

                    if (selectorClass) {
                        const card = document.querySelector(`.report-card.${selectorClass}`);
                        if (card) {
                            const metaSpan = card.querySelector('.report-meta span:first-child');
                            if (metaSpan && metaSpan.innerText !== 'Last: Just now') { // Avoid overwriting 'Just now' instantly if it's there
                                metaSpan.innerHTML = `<i class="fas fa-calendar-check"></i> Last: ${text}`;
                            }
                        }
                    }
                }
            });
        }

        function resetCalculator() {
            const ids = ['cropType', 'seedCost', 'fertilizerCost', 'pesticideCost', 'irrigationCost', 'laborCost', 'machineryCost', 'otherCost', 'landArea', 'expectedYield', 'marketPrice', 'loanAmount'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('seasonType').value = 'kharif';
            document.getElementById('interestRate').value = '7';
            document.getElementById('loanPeriod').value = '12';
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            loadBenchmarkData();
            calculateTotal();
            calculateLoan();
        }

        function updateLastGeneratedDates() {
            const reportIds = ['crop-plan-pdf', 'profit-summary', 'market-report', 'weather-report'];
            reportIds.forEach(id => {
                const timestamp = localStorage.getItem(`last_gen_${id}`);
                const element = document.getElementById(`last-gen-${id}`);
                if (timestamp && element) {
                    const date = new Date(parseInt(timestamp));
                    const now = new Date();
                    const diffTime = Math.abs(now - date);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    let timeStr = "";
                    if (diffDays === 0) timeStr = "Today";
                    else if (diffDays === 1) timeStr = "Yesterday";
                    else timeStr = `${diffDays} days ago`;
                    element.textContent = `Last Generated: ${timeStr}`;
                    element.style.color = "#10b981";
                    element.style.fontWeight = "600";
                }
            });
        }

        // Live Weather Update System
        function refreshWeather() {
            const weatherCard = document.querySelector('.weather-card');
            if (weatherCard) weatherCard.style.opacity = '0.7';

            fetch('/api/weather-update')
                .then(response => response.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);

                    const current = data.current;

                    // Update main metrics
                    const tempEl = document.getElementById('weather-temp');
                    const humEl = document.getElementById('weather-humidity');
                    const windEl = document.getElementById('weather-wind');
                    const visEl = document.getElementById('weather-visibility');
                    const descEl = document.getElementById('weather-desc');
                    const locEl = document.getElementById('weather-location');
                    const iconEl = document.querySelector('.weather-icon-large');

                    if (tempEl) tempEl.textContent = Math.round(current.temperature) + '¬∞C';
                    if (humEl) humEl.textContent = current.humidity + '%';
                    if (windEl) windEl.textContent = current.wind_speed + ' km/h';
                    if (visEl) visEl.textContent = current.visibility + ' km';
                    if (descEl) descEl.textContent = current.condition;
                    if (locEl) locEl.textContent = current.location;
                    if (iconEl) iconEl.textContent = current.icon;

                    if (weatherCard) weatherCard.style.opacity = '1';
                })
                .catch(error => {
                    console.error('Weather Pulse Error:', error);
                    // Silent retry or partial update
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateLastGeneratedDates();
            updateReportHistory();

            // Initial fetch
            refreshWeather();

            // Set live update interval (every 15 minutes)
            setInterval(refreshWeather, 15 * 60 * 1000);
        });
    </script>
    {% endblock %}