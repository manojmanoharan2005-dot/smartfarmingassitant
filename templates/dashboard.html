{% extends "base.html" %}

{% block title %}Dashboard - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">üåæ</span>
                <span class="logo-text">Farming Assistant</span>
            </div>
            <p class="subtitle">Smart Agriculture Platform</p>
        </div>
        
        <div class="welcome-section">
            <p class="welcome-label">Welcome back,</p>
            <h3 class="welcome-name">{{ user_name }}! üëã</h3>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-item active">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-item">
                <span class="nav-icon">üå±</span>
                <span class="nav-text">Crop Suggestion</span>
            </a>
            <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-item">
                <span class="nav-icon">üß™</span>
                <span class="nav-text">Fertilizer Advice</span>
            </a>
            <a href="{{ url_for('market.market_watch') }}" class="nav-item">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Market Watch</span>
            </a>
        </nav>
    </div>

    <!-- Green Header Section -->
    <div class="dashboard-header">        
        <div class="header-content">
            <div class="header-left">
                <h1>Dashboard</h1>
                <p>Monitor your farm's performance and get insights</p>
            </div>
            <div class="header-right">
                <button class="action-btn chatbot-btn" onclick="openChatbotModal()">ü§ñ Ask AI Assistant</button>
                <div class="tools-dropdown">
                    <button class="action-btn tools-btn" onclick="toggleToolsMenu(event)">üõ†Ô∏è Tools ‚ñº</button>
                    <div class="tools-menu" id="toolsMenu">
                        <button class="tool-item" onclick="openCalculatorModal()">
                            <span class="tool-icon">üí∞</span>
                            <span class="tool-name">Expense Calculator</span>
                        </button>
                        <button class="tool-item" onclick="openManualModal()">
                            <span class="tool-icon">üìñ</span>
                            <span class="tool-name">Farmer's Manual</span>
                        </button>
                        <button class="tool-item" onclick="openGovtSchemesModal()">
                            <span class="tool-icon">üèõÔ∏è</span>
                            <span class="tool-name">Govt Schemes</span>
                        </button>
                        <button class="tool-item" onclick="openWeatherModal()">
                            <span class="tool-icon">üå§Ô∏è</span>
                            <span class="tool-name">Weather</span>
                        </button>
                    </div>
                </div>
                <span class="header-date">üìÖ {{ current_date }}</span>
                <button class="logout-button" onclick="window.location.href='{{ url_for('auth.logout') }}'">Logout</button>
                <button class="profile-button" onclick="openProfileModal()">üë§ Profile</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Content Panel -->
        <div class="content-panel">
            <!-- Greeting Card -->
            <div class="greeting-card">
                <div class="greeting-left">
                    <h2>Hi, {{ user_name }}! üëã</h2>
                    <p>Your farm is looking great today. Here's what's happening.</p>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon chart">üìä</div>
                    <div class="stat-info">
                        <h3>{{ stats.total_recommendations }}</h3>
                        <p>Total Recommendations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon plant">üå±</div>
                    <div class="stat-info">
                        <h3>{{ stats.crops_suggested }}</h3>
                        <p>Crops Monitoring</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon fertilizer">üß™</div>
                    <div class="stat-info">
                        <h3>{{ stats.fertilizers_saved }}</h3>
                        <p>Saved Fertilizers</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üå±</div>
                    <div class="stat-info">
                        <h3>{{ stats.active_crops }}</h3>
                        <p>Active Growing</p>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            {% if notifications %}
            <div class="notifications-section">
                <h3 class="section-title">üîî Active Notifications</h3>
                <div class="notifications-list">
                    {% for notification in notifications %}
                    <div class="notification-card {{ notification.priority }}">
                        <div class="notification-icon">
                            {% if notification.type == 'task' %}‚ö°
                            {% elif notification.type == 'harvest' %}üéØ
                            {% else %}üì¢{% endif %}
                        </div>
                        <div class="notification-content">
                            <h4>{{ notification.crop }}</h4>
                            <p>{{ notification.message }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Saved Fertilizers Section -->
            {% if saved_fertilizers %}
            <div class="progress-section">
                <h3 class="section-title">üß™ Saved Fertilizer Recommendations</h3>
                <div class="fertilizer-cards">
                    {% for fert in saved_fertilizers %}
                    <div class="fertilizer-card" id="fertilizer-{{ fert._id }}">
                        <div class="fertilizer-header">
                            <h4>{{ fert.name }}</h4>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="priority-badge {{ fert.priority|lower }}">{{ fert.priority }}</span>
                                <button class="delete-btn" onclick="deleteFertilizer('{{ fert._id }}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="fertilizer-details">
                            <p><strong>Crop:</strong> {{ fert.crop_type|title }}</p>
                            <p><strong>Dosage:</strong> {{ fert.dosage }}</p>
                            <p><strong>Usage:</strong> {{ fert.usage }}</p>
                            {% if fert.saved_at %}
                            <p class="saved-date"><small>Saved: {{ fert.saved_at[:10] }}</small></p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Active Growing Activities -->
            {% if growing_activities %}
            <div class="progress-section">
                <h3 class="section-title">üå± Active Growing Activities</h3>
                {% for activity in growing_activities %}
                <div class="crop-progress" id="activity-{{ activity._id }}">
                    <div class="crop-header">
                        <h4 class="crop-name">{{ activity.crop_display_name }}</h4>
                        <div class="crop-actions">
                            <span class="crop-percentage">{{ activity.current_stage }}/{{ activity.tasks|length }} tasks</span>
                            <button class="delete-btn" onclick="deleteActivity('{{ activity._id }}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (activity.current_stage / activity.tasks|length * 100) }}%"></div>
                    </div>
                    <p class="crop-details">Started: {{ activity.start_date }} ‚Ä¢ Harvest: {{ activity.harvest_date }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Recent Activity Section -->
            <div class="recent-activity">
                <h3 class="section-title">Recent Activity</h3>
                {% if recent_activity %}
                <ul class="activity-list">
                    {% for item in recent_activity %}
                    <li class="activity-item">
                        <span class="activity-time">{{ item.time }}</span>
                        <span class="activity-text">{{ item.text }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-activity">No recent activity. Your dashboard will show actions like recommendations and detections here.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üë§ User Profile</h2>
            <span class="close-modal" onclick="closeProfileModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="profile-info">
                <div class="profile-item">
                    <label>Full Name:</label>
                    <span>{{ user.name or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Email:</label>
                    <span>{{ user.email or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Phone:</label>
                    <span>{{ user.phone or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>State:</label>
                    <span>{{ user.state or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>District:</label>
                    <span>{{ user.district or 'Not provided' }}</span>
                </div>
                <div class="profile-item">
                    <label>Member Since:</label>
                    <span>
                        {% if user.created_at %}
                            {{ user.created_at.strftime('%B %d, %Y') }}
                        {% else %}
                            Registration date not available
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Government Schemes Modal -->
<div id="govtSchemesModal" class="modal">
    <div class="modal-content schemes-modal">
        <div class="modal-header">
            <h2>üèõÔ∏è Government Schemes for Farmers</h2>
            <span class="close-modal" onclick="closeGovtSchemesModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="schemes-intro">Explore government schemes designed to support farmers across India</p>
            
            <div class="schemes-grid">
                <!-- Central Government Schemes -->
                <div class="scheme-category">
                    <h3>üáÆüá≥ Central Government Schemes</h3>
                    
                    <div class="scheme-card">
                        <h4>PM-KISAN (Pradhan Mantri Kisan Samman Nidhi)</h4>
                        <p>Income support of ‚Çπ6,000/year in three equal installments to all farmer families</p>
                        <a href="https://pmkisan.gov.in/" target="_blank" class="scheme-link">Visit Official Website ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Kisan Credit Card (KCC)</h4>
                        <p>Provides credit to farmers for agriculture and allied activities at concessional rates</p>
                        <a href="https://www.nabard.org/content1.aspx?id=523&catid=8&mid=523" target="_blank" class="scheme-link">Learn More ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>PM Fasal Bima Yojana</h4>
                        <p>Crop insurance scheme providing financial support to farmers in case of crop failure</p>
                        <a href="https://pmfby.gov.in/" target="_blank" class="scheme-link">Apply Now ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Soil Health Card Scheme</h4>
                        <p>Provides soil health cards to farmers with information on nutrient status of their soil</p>
                        <a href="https://soilhealth.dac.gov.in/" target="_blank" class="scheme-link">Get Soil Card ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>PM Krishi Sinchayee Yojana</h4>
                        <p>Aims to enhance water use efficiency through Micro Irrigation and watershed development</p>
                        <a href="https://pmksy.gov.in/" target="_blank" class="scheme-link">Know More ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Paramparagat Krishi Vikas Yojana</h4>
                        <p>Promotes organic farming through cluster approach and PGS certification</p>
                        <a href="https://pgsindia-ncof.gov.in/" target="_blank" class="scheme-link">Register ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>National Agriculture Market (e-NAM)</h4>
                        <p>Online trading platform for agricultural commodities in India</p>
                        <a href="https://www.enam.gov.in/" target="_blank" class="scheme-link">Trade Online ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Kisan Call Centre</h4>
                        <p>24x7 toll-free helpline (1800-180-1551) for farmers' queries</p>
                        <a href="https://mkisan.gov.in/Home/KCC" target="_blank" class="scheme-link">Contact Support ‚Üí</a>
                    </div>
                </div>

                <!-- State-Specific Information -->
                <div class="scheme-category">
                    <h3>üìç State Government Schemes</h3>
                    
                    <div class="scheme-card">
                        <h4>Check Your State Schemes</h4>
                        <p>Each state offers additional schemes. Visit your state agriculture department website</p>
                        <a href="https://agricoop.gov.in/en" target="_blank" class="scheme-link">State Agriculture Portals ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Karnataka Schemes</h4>
                        <p>Raitha Bandhu, Krishi Bhagya, and other state-specific programs</p>
                        <a href="https://raitamitra.karnataka.gov.in/" target="_blank" class="scheme-link">Karnataka Portal ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Maharashtra Schemes</h4>
                        <p>Mahatma Jyotiba Phule Shetkari Karjmukti Yojana and others</p>
                        <a href="https://krishi.maharashtra.gov.in/" target="_blank" class="scheme-link">Maharashtra Portal ‚Üí</a>
                    </div>
                </div>

                <!-- Support & Resources -->
                <div class="scheme-category">
                    <h3>üìö Additional Resources</h3>
                    
                    <div class="scheme-card">
                        <h4>Ministry of Agriculture Portal</h4>
                        <p>Complete information about all agricultural schemes and subsidies</p>
                        <a href="https://agricoop.gov.in/" target="_blank" class="scheme-link">Visit Portal ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Kisan Rath Mobile App</h4>
                        <p>Helps farmers find transport for their agricultural produce</p>
                        <a href="https://kisanrath.nic.in/" target="_blank" class="scheme-link">Download App ‚Üí</a>
                    </div>

                    <div class="scheme-card">
                        <h4>Direct Benefit Transfer (DBT)</h4>
                        <p>Track your subsidy and benefit transfers</p>
                        <a href="https://dbtbharat.gov.in/" target="_blank" class="scheme-link">Check Status ‚Üí</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Expense Calculator Modal -->
<div id="calculatorModal" class="modal">
    <div class="modal-content calculator-modal" style="max-width: 1200px;">
        <div class="modal-header">
            <h2>üí∞ Advanced Farming Expense Calculator</h2>
            <span class="close-modal" onclick="closeCalculatorModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="schemes-intro">Calculate and track all your farming expenses for better financial planning with profit analysis</p>
            
            <!-- Season and Crop Type Selection -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div class="scheme-card" style="padding: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #2d6a4f; font-weight: 600;">üå± Select Crop Type</label>
                    <select id="cropType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" onchange="loadBenchmarkData()">
                        <option value="">Select Crop</option>
                        <option value="rice">Rice</option>
                        <option value="wheat">Wheat</option>
                        <option value="cotton">Cotton</option>
                        <option value="sugarcane">Sugarcane</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="pulses">Pulses</option>
                        <option value="oilseeds">Oilseeds</option>
                    </select>
                </div>
                <div class="scheme-card" style="padding: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #2d6a4f; font-weight: 600;">üóìÔ∏è Select Season</label>
                    <select id="seasonType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="kharif">Kharif (Monsoon)</option>
                        <option value="rabi">Rabi (Winter)</option>
                        <option value="zaid">Zaid (Summer)</option>
                    </select>
                </div>
                <div class="scheme-card" style="padding: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #2d6a4f; font-weight: 600;">üìÖ Entry Date</label>
                    <input type="date" id="entryDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" value="">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px;">
                <!-- Input Section -->
                <div>
                    <h3 style="color: #2d6a4f; margin-bottom: 20px;">‚úèÔ∏è Add Expenses</h3>
                    
                    <div class="scheme-card">
                        <h4>üåæ Seeds & Planting Material</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Cost (‚Çπ)</label>
                        <input type="number" id="seedCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                        <small id="seedBenchmark" style="color: #888; font-size: 11px;"></small>
                    </div>

                    <div class="scheme-card">
                        <h4>üß™ Fertilizers & Manure</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Cost (‚Çπ)</label>
                        <input type="number" id="fertilizerCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                        <small id="fertilizerBenchmark" style="color: #888; font-size: 11px;"></small>
                    </div>

                    <div class="scheme-card">
                        <h4>üêõ Pesticides & Insecticides</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Cost (‚Çπ)</label>
                        <input type="number" id="pesticideCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                        <small id="pesticideBenchmark" style="color: #888; font-size: 11px;"></small>
                    </div>

                    <div class="scheme-card">
                        <h4>üíß Irrigation & Water</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Electricity/Diesel (‚Çπ)</label>
                        <input type="number" id="irrigationCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                    </div>

                    <div class="scheme-card">
                        <h4>üë®‚Äçüåæ Labor Cost</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Wages (‚Çπ)</label>
                        <input type="number" id="laborCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                    </div>

                    <div class="scheme-card">
                        <h4>üöú Machinery & Equipment</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Rent/Fuel (‚Çπ)</label>
                        <input type="number" id="machineryCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                    </div>

                    <div class="scheme-card">
                        <h4>üì¶ Other Expenses</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #666; font-size: 13px;">Transport, Storage, etc. (‚Çπ)</label>
                        <input type="number" id="otherCost" placeholder="Enter amount" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                    </div>
                </div>

                <!-- Summary Section -->
                <div>
                    <h3 style="color: #2d6a4f; margin-bottom: 20px;">üìÑ Expense Summary</h3>
                    
                    <div class="scheme-card" style="background: linear-gradient(135deg, #52b788 0%, #2d6a4f 100%); color: white;">
                        <h3 style="margin: 0 0 10px 0; color: white;">Total Expenses</h3>
                        <h1 style="margin: 0; font-size: 42px; color: white;" id="totalExpense">‚Çπ0</h1>
                    </div>

                    <div class="scheme-card">
                        <h4>üìä Expense Breakdown</h4>
                        <canvas id="expenseChart" style="max-height: 250px; margin: 15px 0;"></canvas>
                        <div id="expenseBreakdown" style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Seeds & Planting:</span>
                                <strong id="seedDisplay">‚Çπ0 (<span id="seedPercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Fertilizers:</span>
                                <strong id="fertilizerDisplay">‚Çπ0 (<span id="fertilizerPercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Pesticides:</span>
                                <strong id="pesticideDisplay">‚Çπ0 (<span id="pesticidePercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Irrigation:</span>
                                <strong id="irrigationDisplay">‚Çπ0 (<span id="irrigationPercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Labor:</span>
                                <strong id="laborDisplay">‚Çπ0 (<span id="laborPercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                <span style="color: #666;">Machinery:</span>
                                <strong id="machineryDisplay">‚Çπ0 (<span id="machineryPercent">0%</span>)</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #666;">Other:</span>
                                <strong id="otherDisplay">‚Çπ0 (<span id="otherPercent">0%</span>)</strong>
                            </div>
                        </div>
                    </div>

                    <div class="scheme-card" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                        <h4 style="margin: 0 0 10px 0; color: #856404;">üí° Cost per Acre</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #856404; font-size: 13px;">Enter your land area (acres):</label>
                        <input type="number" id="landArea" placeholder="e.g., 2.5" step="0.1" style="width: 100%; padding: 10px; border: 1px solid #ffc107; border-radius: 8px; font-size: 14px; margin-bottom: 10px;" oninput="calculateTotal()">
                        <h3 style="margin: 0; color: #856404;" id="costPerAcre">‚Çπ0 per acre</h3>
                        <small id="benchmarkComparison" style="color: #856404; font-size: 12px; display: block; margin-top: 5px;"></small>
                    </div>
                </div>

                <!-- Revenue & Profit Section -->
                <div>
                    <h3 style="color: #2d6a4f; margin-bottom: 20px;">üíµ Revenue & Profit Analysis</h3>
                    
                    <div class="scheme-card" style="background: #d1f2eb; border-left: 4px solid #52b788;">
                        <h4 style="margin: 0 0 10px 0; color: #0f5132;">üì¶ Expected Production</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #0f5132; font-size: 13px;">Expected yield (quintals):</label>
                        <input type="number" id="expectedYield" placeholder="e.g., 50" step="1" style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px; font-size: 14px; margin-bottom: 10px;" oninput="calculateTotal()">
                        
                        <label style="display: block; margin: 8px 0 4px 0; color: #0f5132; font-size: 13px;">Current market price (‚Çπ/quintal):</label>
                        <input type="number" id="marketPrice" placeholder="e.g., 2500" step="10" style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px; font-size: 14px;" oninput="calculateTotal()">
                    </div>

                    <div class="scheme-card" style="background: linear-gradient(135deg, #06d6a0 0%, #118ab2 100%); color: white;">
                        <h3 style="margin: 0 0 10px 0; color: white;">Total Revenue</h3>
                        <h1 style="margin: 0; font-size: 42px; color: white;" id="totalRevenue">‚Çπ0</h1>
                    </div>

                    <div class="scheme-card" id="profitCard" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white;">
                        <h3 style="margin: 0 0 10px 0; color: white;">Net Profit</h3>
                        <h1 style="margin: 0; font-size: 42px; color: white;" id="netProfit">‚Çπ0</h1>
                        <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;" id="profitMargin">Profit Margin: 0%</p>
                    </div>

                    <div class="scheme-card" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                        <h4 style="margin: 0 0 10px 0; color: #2e7d32;">üéØ Break-even Analysis</h4>
                        <div id="breakEvenPrice">
                            <p style="margin: 5px 0; color: #2e7d32; font-size: 13px;">Minimum selling price to break-even:</p>
                            <h3 style="margin: 5px 0; color: #2e7d32;" id="minPrice">‚Çπ0 per quintal</h3>
                            <p style="margin: 10px 0 5px 0; color: #2e7d32; font-size: 13px;">Total quantity to break-even at current price:</p>
                            <h3 style="margin: 5px 0; color: #2e7d32;" id="breakEvenQty">0 quintals</h3>
                        </div>
                    </div>

                    <div class="scheme-card" style="background: #fff9e6; border-left: 4px solid #ff9800;">
                        <h4 style="margin: 0 0 10px 0; color: #e65100;">üè¶ Loan Calculator</h4>
                        <label style="display: block; margin: 8px 0 4px 0; color: #e65100; font-size: 13px;">Loan amount (‚Çπ):</label>
                        <input type="number" id="loanAmount" placeholder="e.g., 50000" step="1000" style="width: 100%; padding: 10px; border: 1px solid #ff9800; border-radius: 8px; font-size: 14px; margin-bottom: 10px;" oninput="calculateLoan()">
                        
                        <label style="display: block; margin: 8px 0 4px 0; color: #e65100; font-size: 13px;">Interest rate (% p.a.):</label>
                        <input type="number" id="interestRate" placeholder="e.g., 7" step="0.5" value="7" style="width: 100%; padding: 10px; border: 1px solid #ff9800; border-radius: 8px; font-size: 14px; margin-bottom: 10px;" oninput="calculateLoan()">
                        
                        <label style="display: block; margin: 8px 0 4px 0; color: #e65100; font-size: 13px;">Loan period (months):</label>
                        <input type="number" id="loanPeriod" placeholder="e.g., 12" step="1" value="12" style="width: 100%; padding: 10px; border: 1px solid #ff9800; border-radius: 8px; font-size: 14px; margin-bottom: 15px;" oninput="calculateLoan()">
                        
                        <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #e65100; font-size: 13px;">Monthly EMI:</span>
                                <strong id="monthlyEMI" style="color: #e65100;">‚Çπ0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #e65100; font-size: 13px;">Total Interest:</span>
                                <strong id="totalInterest" style="color: #e65100;">‚Çπ0</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-top: 1px solid #ffe0b2; margin-top: 5px; padding-top: 10px;">
                                <span style="color: #e65100; font-size: 13px; font-weight: 600;">Total Amount:</span>
                                <strong id="totalAmount" style="color: #e65100; font-size: 16px;">‚Çπ0</strong>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <button onclick="saveExpenseEntry()" style="width: 100%; padding: 12px; background: #52b788; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">üíæ Save Entry</button>
                        <button onclick="exportToPDF()" style="width: 100%; padding: 12px; background: #0284c7; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">üìÑ Export PDF</button>
                    </div>
                    <button onclick="resetCalculator()" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px;">üîÑ Reset Calculator</button>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="scheme-card" style="margin-top: 30px; background: #e7f5ff; border-left: 4px solid #0284c7;">
                <h4 style="color: #0c4a6e;">üí° Money Saving Tips</h4>
                <ul style="margin-left: 20px; line-height: 1.8; color: #0c4a6e;">
                    <li><strong>Buy in Bulk:</strong> Purchase seeds and fertilizers with other farmers to get discounts</li>
                    <li><strong>Government Subsidies:</strong> Check schemes for subsidy on seeds, fertilizers, equipment</li>
                    <li><strong>Drip Irrigation:</strong> Saves 40-60% water cost compared to flood irrigation</li>
                    <li><strong>Organic Manure:</strong> Make your own compost to reduce fertilizer cost</li>
                    <li><strong>Labor Exchange:</strong> Form groups with neighbors for mutual labor help</li>
                    <li><strong>Proper Storage:</strong> Good storage prevents 15-20% post-harvest losses</li>
                    <li><strong>Soil Testing:</strong> Prevents over-fertilization, saves 20-30% fertilizer cost</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Farmer's Manual Modal -->
<div id="manualModal" class="modal">
    <div class="modal-content manual-modal" style="max-width: 1000px;">
        <div class="modal-header">
            <h2>üìñ Farmer's Manual - How to Measure & Calculate</h2>
            <span class="close-modal" onclick="closeManualModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="schemes-intro">Complete guide to measuring soil nutrients, climate conditions, and entering correct values</p>
            
            <div class="schemes-grid">
                <!-- Soil Nutrients Section -->
                <div class="scheme-category">
                    <h3>üß™ Soil Nutrients (N, P, K) - Complete Testing Guide</h3>
                    
                    <div class="scheme-card">
                        <h4>üìù Step-by-Step Soil Sample Collection</h4>
                        <p><strong>Before Testing - Collect Proper Sample:</strong></p>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Time:</strong> Collect 2-3 months before planting season</li>
                            <li><strong>Tools Needed:</strong> Clean bucket, spade/auger, clean polythene bag</li>
                            <li><strong>Method:</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Remove top 2-3 cm surface soil (grass, stones, debris)</li>
                                    <li>Dig V-shaped hole 6-8 inches (15-20 cm) deep</li>
                                    <li>Take 1 inch (2.5 cm) slice from side of hole</li>
                                    <li>Collect from 10-15 different spots in your field (zigzag pattern)</li>
                                    <li>Mix all samples in bucket thoroughly</li>
                                    <li>Take 500 grams (2 cups) from mixed sample</li>
                                    <li>Put in clean polythene bag, label with field details</li>
                                </ul>
                            </li>
                            <li><strong>Avoid:</strong> Wet soil, near fertilizer heaps, boundary areas, tree shade</li>
                        </ol>
                    </div>

                    <div class="scheme-card">
                        <h4>Nitrogen (N) - Range: 0-140 mg/kg</h4>
                        <p><strong>Professional Testing (Most Accurate):</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Krishi Vigyan Kendra (KVK):</strong> ‚Çπ50-100 per sample, results in 7-10 days</li>
                            <li><strong>Soil Health Card:</strong> Free testing at district agriculture office</li>
                            <li><strong>Private Labs:</strong> ‚Çπ200-500, results in 2-3 days</li>
                            <li><strong>Mobile Testing Vans:</strong> On-spot results in villages</li>
                        </ul>
                        <p><strong>DIY Home Testing (Approximate):</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Soil Test Kit:</strong> Buy from agriculture shop (‚Çπ500-1500)
                                <ul style="margin-left: 20px;">
                                    <li>Mix 1 spoon soil + water in test tube</li>
                                    <li>Add nitrogen test powder/tablet</li>
                                    <li>Shake well and wait 2-3 minutes</li>
                                    <li>Compare color with chart provided</li>
                                    <li>Light color = Low N, Dark color = High N</li>
                                </ul>
                            </li>
                            <li><strong>Visual Signs (Field Observation):</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Yellowish-green leaves ‚Üí Low nitrogen (0-40 mg/kg)</li>
                                    <li>Normal green leaves ‚Üí Medium nitrogen (40-80 mg/kg)</li>
                                    <li>Dark green, lush growth ‚Üí High nitrogen (80-140 mg/kg)</li>
                                </ul>
                            </li>
                        </ul>
                        <p><strong>How Lab Calculates N:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Lab uses Alkaline Permanganate Method or Kjeldahl Method</li>
                            <li>Formula: Available N (mg/kg) = (Test reading √ó dilution factor) √∑ soil weight</li>
                            <li>Report shows as kg/hectare or mg/kg (ppm)</li>
                        </ul>
                        <p><strong>Typical Values for Indian Soil:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Low (0-40 mg/kg):</strong> Sandy soil, repeated cropping, no manure</li>
                            <li><strong>Medium (40-80 mg/kg):</strong> Normal agricultural soil</li>
                            <li><strong>High (80-140 mg/kg):</strong> Black soil, regular organic manure use</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Phosphorus (P) - Range: 5-145 mg/kg</h4>
                        <p><strong>Professional Testing:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Included in standard soil test package (‚Çπ50-200)</li>
                            <li>Available at KVK, Agriculture Department, Soil Health Card</li>
                        </ul>
                        <p><strong>DIY Home Testing:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Soil Test Kit Method:</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Take 1 spoon soil in test tube</li>
                                    <li>Add phosphorus extracting solution</li>
                                    <li>Shake for 1 minute, let settle</li>
                                    <li>Add phosphorus reagent tablet</li>
                                    <li>Blue color = High P, Light/No color = Low P</li>
                                    <li>Match color intensity with chart</li>
                                </ul>
                            </li>
                            <li><strong>Visual Signs:</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Purple/dark green leaves + stunted growth ‚Üí Low P (5-20 mg/kg)</li>
                                    <li>Normal growth, good flowering ‚Üí Medium P (20-60 mg/kg)</li>
                                    <li>Excellent root, flower, fruit development ‚Üí High P (60-145 mg/kg)</li>
                                </ul>
                            </li>
                        </ul>
                        <p><strong>How Lab Calculates P:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Lab uses Olsen Method (alkaline soil) or Bray Method (acidic soil)</li>
                            <li>Formula: Available P‚ÇÇO‚ÇÖ = (Reading √ó dilution √ó 2.29) √∑ soil weight</li>
                            <li>Result in kg/hectare or mg/kg</li>
                        </ul>
                        <p><strong>Typical Values:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Low (5-20 mg/kg):</strong> Acidic soil, laterite soil</li>
                            <li><strong>Medium (20-60 mg/kg):</strong> Most cultivated soil</li>
                            <li><strong>High (60-145 mg/kg):</strong> Regular fertilizer use, black soil</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Potassium (K) - Range: 5-205 mg/kg</h4>
                        <p><strong>Professional Testing:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Always included in complete soil test</li>
                            <li>KVK/Soil Health Card provides all three (N, P, K) together</li>
                        </ul>
                        <p><strong>DIY Home Testing:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Soil Test Kit Method:</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Mix soil with potassium extracting solution</li>
                                    <li>Filter through provided paper</li>
                                    <li>Add reagent drops to clear solution</li>
                                    <li>Measure turbidity (cloudiness)</li>
                                    <li>More cloudy = More potassium</li>
                                    <li>Compare with color/turbidity chart</li>
                                </ul>
                            </li>
                            <li><strong>Visual Signs:</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Brown/yellow leaf edges (scorched) ‚Üí Low K (5-50 mg/kg)</li>
                                    <li>Weak stems, lodging in crops ‚Üí Low K</li>
                                    <li>Good stem strength, disease resistance ‚Üí Medium K (50-110 mg/kg)</li>
                                    <li>Excellent quality grains/fruits ‚Üí High K (110-205 mg/kg)</li>
                                </ul>
                            </li>
                        </ul>
                        <p><strong>How Lab Calculates K:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Lab uses Flame Photometer or Ammonium Acetate Method</li>
                            <li>Formula: Available K‚ÇÇO = (Reading √ó dilution √ó 1.205) √∑ soil weight</li>
                            <li>Reported as kg/hectare or mg/kg</li>
                        </ul>
                        <p><strong>Typical Values:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Low (5-50 mg/kg):</strong> Sandy, laterite soil</li>
                            <li><strong>Medium (50-110 mg/kg):</strong> Red soil, alluvial soil</li>
                            <li><strong>High (110-205 mg/kg):</strong> Black soil, clay-rich soil</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>üßÆ Converting Units - Important!</h4>
                        <p><strong>Common Confusion in Reports:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>mg/kg = ppm (parts per million)</strong> ‚Üí Use directly in our system</li>
                            <li><strong>kg/hectare ‚Üí mg/kg:</strong> Divide by 2.24</li>
                            <li><strong>Example:</strong> Report shows "Nitrogen: 180 kg/hectare"
                                <ul style="margin-left: 20px;">
                                    <li>Convert: 180 √∑ 2.24 = 80 mg/kg</li>
                                    <li>Enter 80 in our system</li>
                                </ul>
                            </li>
                            <li><strong>lb/acre ‚Üí mg/kg:</strong> Multiply by 1.12</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Soil pH Level - Range: 3.5-9.5</h4>
                        <p><strong>How to Measure:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Get soil tested at nearest Krishi Vigyan Kendra (KVK) or soil testing lab</li>
                            <li>Cost: ‚Çπ50-200 per sample</li>
                            <li>OR use Soil Health Card (Free) from government</li>
                        </ul>
                        <p><strong>Typical Values:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Low: 0-40 mg/kg (Poor soil)</li>
                            <li>Medium: 40-80 mg/kg (Average soil)</li>
                            <li>High: 80-140 mg/kg (Rich soil)</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Soil pH Level - Range: 3.5-9.5</h4>
                        <p><strong>Professional Testing:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Included in standard soil test (‚Çπ50-200)</li>
                            <li>Most accurate method with calibrated instruments</li>
                        </ul>
                        <p><strong>DIY Methods - At Home/Field:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Method 1: Digital pH Meter (‚Çπ200-500):</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Collect fresh soil sample (avoid dry/old soil)</li>
                                    <li>Mix 1 part soil + 2 parts distilled/clean water</li>
                                    <li>Stir well and let settle for 10 minutes</li>
                                    <li>Calibrate pH meter (if needed)</li>
                                    <li>Dip electrode in clear water above settled soil</li>
                                    <li>Wait 30-60 seconds, read pH value</li>
                                    <li>Accurate to ¬±0.1 pH units</li>
                                </ul>
                            </li>
                            <li><strong>Method 2: pH Test Strips (‚Çπ50-100):</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Mix soil + water (1:2 ratio) in glass</li>
                                    <li>Let settle for 5 minutes</li>
                                    <li>Dip test strip in clear water part</li>
                                    <li>Wait 15-30 seconds</li>
                                    <li>Match color with provided chart</li>
                                    <li>Accuracy: ¬±0.5 pH units</li>
                                </ul>
                            </li>
                            <li><strong>Method 3: Vinegar & Baking Soda Test (Free!):</strong>
                                <ul style="margin-left: 20px;">
                                    <li>Take 2 soil samples in separate cups</li>
                                    <li><strong>Test 1:</strong> Add vinegar (acid) ‚Üí If fizzes = Alkaline soil (pH > 7)</li>
                                    <li><strong>Test 2:</strong> Add baking soda + water ‚Üí If fizzes = Acidic soil (pH < 7)</li>
                                    <li><strong>No fizz in both:</strong> Neutral soil (pH ‚âà 7)</li>
                                    <li>Not exact number, but tells acidic/neutral/alkaline</li>
                                </ul>
                            </li>
                        </ul>
                        <p><strong>How to Read Your pH Number:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Very Acidic (3.5-5.0):</strong> Tea, blueberries, potatoes</li>
                            <li><strong>Moderately Acidic (5.0-6.5):</strong> Rice, tomatoes, carrots</li>
                            <li><strong>Neutral (6.5-7.5):</strong> Most vegetables, corn, cotton</li>
                            <li><strong>Alkaline (7.5-9.5):</strong> Wheat, barley, cauliflower</li>
                        </ul>
                    </div>
                </div>

                <!-- Climate Conditions Section -->
                <div class="scheme-category">
                    <h3>üå§Ô∏è Climate & Weather Conditions</h3>
                    
                    <div class="scheme-card">
                        <h4>Temperature - Range: 8-45¬∞C</h4>
                        <p><strong>How to Measure:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Use thermometer or check weather apps</li>
                            <li>Enter average temperature of your area</li>
                            <li>For crop prediction, use average annual temperature</li>
                        </ul>
                        <p><strong>Quick Guide:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Hill areas: 8-20¬∞C</li>
                            <li>North India (Winter): 10-25¬∞C</li>
                            <li>North India (Summer): 25-45¬∞C</li>
                            <li>South India: 20-35¬∞C</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Humidity - Range: 14-100%</h4>
                        <p><strong>How to Measure:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Check weather apps (Google Weather, IMD app)</li>
                            <li>Buy hygrometer from market (‚Çπ300-800)</li>
                            <li>Enter average humidity of your region</li>
                        </ul>
                        <p><strong>Typical Values:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Low: 14-40% (Dry areas like Rajasthan)</li>
                            <li>Medium: 40-70% (Most of India)</li>
                            <li>High: 70-100% (Coastal areas, Monsoon season)</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>Rainfall - Range: 20-3000 mm/year</h4>
                        <p><strong>How to Measure:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Check India Meteorological Department (IMD) website</li>
                            <li>Ask at local agriculture office</li>
                            <li>Enter annual rainfall of your district</li>
                        </ul>
                        <p><strong>India's Rainfall Zones:</strong></p>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>Very Low: 20-400 mm (Rajasthan, Gujarat)</li>
                            <li>Low: 400-800 mm (Central India)</li>
                            <li>Medium: 800-1500 mm (Most states)</li>
                            <li>High: 1500-2500 mm (Coastal areas)</li>
                            <li>Very High: 2500-3000+ mm (Northeast, Kerala)</li>
                        </ul>
                    </div>
                </div>

                <!-- Practical Tips Section -->
                <div class="scheme-category" style="grid-column: 1/-1;">
                    <h3>üí° Important Tips & Resources</h3>
                    
                    <div class="scheme-card">
                        <h4>üèõÔ∏è Where to Get Soil Testing</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Krishi Vigyan Kendra (KVK):</strong> Available in every district</li>
                            <li><strong>State Agriculture Department:</strong> Free or subsidized testing</li>
                            <li><strong>Soil Health Card:</strong> Register at https://soilhealth.dac.gov.in/</li>
                            <li><strong>Private Labs:</strong> Faster results, costs ‚Çπ200-500</li>
                            <li><strong>Mobile Soil Testing Vans:</strong> Visit villages periodically</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>üì± Helpful Apps & Websites</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Kisan Suvidha:</strong> Weather, market prices, dealers info</li>
                            <li><strong>mKisan Portal:</strong> SMS/mobile advisories</li>
                            <li><strong>IMD Weather:</strong> Official weather forecasts</li>
                            <li><strong>Soil Health Card Portal:</strong> Digital soil reports</li>
                            <li><strong>Kisan Call Centre:</strong> Dial 1800-180-1551 (Toll Free)</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>‚ö†Ô∏è Common Mistakes to Avoid</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li>‚ùå Don't guess soil nutrient values - always test</li>
                            <li>‚ùå Don't use last year's soil test for this year</li>
                            <li>‚ùå Don't enter rainfall in cm (convert to mm: 1 cm = 10 mm)</li>
                            <li>‚ùå Don't mix up humidity % with rainfall</li>
                            <li>‚úÖ Update soil test every 2-3 years</li>
                            <li>‚úÖ Use current season's weather data</li>
                        </ul>
                    </div>

                    <div class="scheme-card">
                        <h4>üìû Need Help? Contact Support</h4>
                        <ul style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Kisan Call Centre:</strong> 1800-180-1551 (Free)</li>
                            <li><strong>Nearest KVK:</strong> Search on Google Maps</li>
                            <li><strong>District Agriculture Officer:</strong> Visit nearest office</li>
                            <li><strong>Online Help:</strong> mkisan.gov.in</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chatbot Modal -->
<div id="chatbotModal" class="modal">
    <div class="modal-content chatbot-modal-content">
        <div class="chatbot-header">
            <div class="chatbot-header-left">
                <span class="chatbot-avatar">ü§ñ</span>
                <div>
                    <h3>Smart Farming AI Assistant</h3>
                    <p class="chatbot-status">Online ‚Ä¢ Ready to help</p>
                </div>
            </div>
            <span class="close" onclick="closeChatbotModal()">&times;</span>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble bot-bubble">
                    <p>Hello! I'm your Smart Farming AI Assistant. üåæ</p>
                    <p>I can help you with:</p>
                    <ul>
                        <li>Crop recommendations</li>
                        <li>Disease detection</li>
                        <li>Fertilizer advice</li>
                        <li>Weather information</li>
                        <li>Market prices</li>
                        <li>Expense calculator</li>
                        <li>Irrigation tips</li>
                        <li>Government schemes</li>
                    </ul>
                    <p>Ask me anything about farming! üå±</p>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="suggested-questions" id="suggestedQuestions">
                <button class="suggestion-chip" onclick="sendSuggestion('How do I get crop recommendations?')">How do I get crop recommendations?</button>
                <button class="suggestion-chip" onclick="sendSuggestion('What features are available?')">What features are available?</button>
                <button class="suggestion-chip" onclick="sendSuggestion('How does disease detection work?')">How does disease detection work?</button>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type your question here..." onkeypress="handleChatKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">üì§ Send</button>
            </div>
        </div>
    </div>
</div>


<!-- Weather Modal -->
<div id="weatherModal" class="modal weather-modal-container">
    <div class="modal-content weather-modal">
        <div class="modal-header">
            <h2>üå§Ô∏è Weather Information</h2>
            <span class="close-modal" onclick="closeWeatherModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="weather-search">
                <input type="text" id="cityInput" placeholder="Enter city name (e.g., Bangalore, Mumbai)" class="weather-input">
                <button onclick="getWeather()" class="weather-search-btn">üîç Search</button>
                <button onclick="getCurrentLocationWeather()" class="weather-location-btn" title="Use my current location">üìç Current Location</button>
            </div>
            
            <div id="weatherResult" class="weather-result" style="display: none;">
                <div class="weather-main">
                    <div class="weather-icon-large" id="weatherIcon">‚òÄÔ∏è</div>
                    <div class="weather-temp-main">
                        <h1 id="temperature">--¬∞C</h1>
                        <p id="weatherDescription">--</p>
                    </div>
                </div>
                
                <div class="weather-location">
                    <h3 id="cityName">--</h3>
                    <p id="currentDate">--</p>
                </div>
                
                <div class="weather-details-grid">
                    <div class="weather-detail-card">
                        <span class="detail-icon">üíß</span>
                        <span class="detail-label">Humidity</span>
                        <span class="detail-value" id="humidity">--%</span>
                    </div>
                    <div class="weather-detail-card">
                        <span class="detail-icon">üí®</span>
                        <span class="detail-label">Wind Speed</span>
                        <span class="detail-value" id="windSpeed">-- km/h</span>
                    </div>
                    <div class="weather-detail-card">
                        <span class="detail-icon">üå°Ô∏è</span>
                        <span class="detail-label">Feels Like</span>
                        <span class="detail-value" id="feelsLike">--¬∞C</span>
                    </div>
                    <div class="weather-detail-card">
                        <span class="detail-icon">üîΩ</span>
                        <span class="detail-label">Pressure</span>
                        <span class="detail-value" id="pressure">-- hPa</span>
                    </div>
                    <div class="weather-detail-card">
                        <span class="detail-icon">üëÅÔ∏è</span>
                        <span class="detail-label">Visibility</span>
                        <span class="detail-value" id="visibility">-- km</span>
                    </div>
                    <div class="weather-detail-card">
                        <span class="detail-icon">‚òÅÔ∏è</span>
                        <span class="detail-label">Cloud Cover</span>
                        <span class="detail-value" id="clouds">--%</span>
                    </div>
                </div>
                
                <div class="farming-advice">
                    <h4>üåæ Farming Advice</h4>
                    <p id="farmingAdvice">--</p>
                </div>
            </div>
            
            <div id="weatherError" class="weather-error" style="display: none;">
                <p>‚ùå Unable to fetch weather data. Please check the city name and try again.</p>
            </div>
            
            <div class="weather-info-note">
                <p><strong>Note:</strong> Weather data is fetched from OpenWeatherMap API. Enter your city name to get current weather conditions and farming advice.</p>
            </div>
        </div>
    </div>

</div>

<script>
// Tools Dropdown Menu
function toggleToolsMenu(event) {
    event.stopPropagation();
    const toolsMenu = document.getElementById('toolsMenu');
    toolsMenu.classList.toggle('show');
}

// Close tools menu when clicking outside
document.addEventListener('click', function(event) {
    const toolsMenu = document.getElementById('toolsMenu');
    const toolsBtn = event.target.closest('.tools-btn');
    
    if (!toolsBtn && toolsMenu && toolsMenu.classList.contains('show')) {
        toolsMenu.classList.remove('show');
    }
});

function openProfileModal() {
    document.getElementById('profileModal').style.display = 'block';
    closeToolsMenu();
}

function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
}

function closeGovtSchemesModal() {
    document.getElementById('govtSchemesModal').style.display = 'none';
}

function closeToolsMenu() {
    const toolsMenu = document.getElementById('toolsMenu');
    if (toolsMenu) {
        toolsMenu.classList.remove('show');
    }
}

function openCalculatorModal() {
    document.getElementById('calculatorModal').style.display = 'block';
    closeToolsMenu();
    // Initialize calculator on open
    setTimeout(() => {
        if (document.getElementById('entryDate').value === '') {
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
        }
        calculateTotal();
        calculateLoan();
    }, 100);
}

function closeCalculatorModal() {
    document.getElementById('calculatorModal').style.display = 'none';
}

function openManualModal() {
    document.getElementById('manualModal').style.display = 'block';
    closeToolsMenu();
}

function closeManualModal() {
    document.getElementById('manualModal').style.display = 'none';
}

function openWeatherModal() {
    document.getElementById('weatherModal').style.display = 'block';
    closeToolsMenu();
}

function closeWeatherModal() {
    document.getElementById('weatherModal').style.display = 'none';
}

// Expense Calculator Functions
let expenseChart = null;
const expenseHistory = [];

// Benchmark data for different crops (‚Çπ per acre)
const cropBenchmarks = {
    rice: { seed: 2000, fertilizer: 6000, pesticide: 2500, total: 35000 },
    wheat: { seed: 1500, fertilizer: 5000, pesticide: 2000, total: 28000 },
    cotton: { seed: 3000, fertilizer: 7000, pesticide: 4000, total: 42000 },
    sugarcane: { seed: 8000, fertilizer: 10000, pesticide: 3000, total: 60000 },
    vegetables: { seed: 4000, fertilizer: 8000, pesticide: 3500, total: 45000 },
    pulses: { seed: 1800, fertilizer: 4000, pesticide: 1500, total: 22000 },
    oilseeds: { seed: 2200, fertilizer: 5500, pesticide: 2800, total: 30000 }
};

// Set default date to today and initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Set default date for expense calculator
    const entryDateInput = document.getElementById('entryDate');
    if (entryDateInput) {
        entryDateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Allow Enter key to search weather
    const cityInput = document.getElementById('cityInput');
    if (cityInput) {
        cityInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getWeather();
            }
        });
    }
});

function loadBenchmarkData() {
    const cropType = document.getElementById('cropType').value;
    if (!cropType || !cropBenchmarks[cropType]) {
        document.getElementById('seedBenchmark').textContent = '';
        document.getElementById('fertilizerBenchmark').textContent = '';
        document.getElementById('pesticideBenchmark').textContent = '';
        return;
    }
    
    const benchmark = cropBenchmarks[cropType];
    document.getElementById('seedBenchmark').textContent = `Average: ‚Çπ${benchmark.seed.toLocaleString('en-IN')}/acre`;
    document.getElementById('fertilizerBenchmark').textContent = `Average: ‚Çπ${benchmark.fertilizer.toLocaleString('en-IN')}/acre`;
    document.getElementById('pesticideBenchmark').textContent = `Average: ‚Çπ${benchmark.pesticide.toLocaleString('en-IN')}/acre`;
}

function calculateTotal() {
    // Get expense values
    const seed = parseFloat(document.getElementById('seedCost')?.value) || 0;
    const fertilizer = parseFloat(document.getElementById('fertilizerCost')?.value) || 0;
    const pesticide = parseFloat(document.getElementById('pesticideCost')?.value) || 0;
    const irrigation = parseFloat(document.getElementById('irrigationCost')?.value) || 0;
    const labor = parseFloat(document.getElementById('laborCost')?.value) || 0;
    const machinery = parseFloat(document.getElementById('machineryCost')?.value) || 0;
    const other = parseFloat(document.getElementById('otherCost')?.value) || 0;
    
    const total = seed + fertilizer + pesticide + irrigation + labor + machinery + other;
    
    console.log('Calculating totals:', { seed, fertilizer, pesticide, irrigation, labor, machinery, other, total });
    
    // Calculate percentages
    const seedPercent = total > 0 ? ((seed / total) * 100).toFixed(1) : 0;
    const fertilizerPercent = total > 0 ? ((fertilizer / total) * 100).toFixed(1) : 0;
    const pesticidePercent = total > 0 ? ((pesticide / total) * 100).toFixed(1) : 0;
    const irrigationPercent = total > 0 ? ((irrigation / total) * 100).toFixed(1) : 0;
    const laborPercent = total > 0 ? ((labor / total) * 100).toFixed(1) : 0;
    const machineryPercent = total > 0 ? ((machinery / total) * 100).toFixed(1) : 0;
    const otherPercent = total > 0 ? ((other / total) * 100).toFixed(1) : 0;
    
    // Update displays with null checks
    const updateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };
    
    updateElement('totalExpense', '‚Çπ' + total.toLocaleString('en-IN'));
    updateElement('seedDisplay', '‚Çπ' + seed.toLocaleString('en-IN'));
    updateElement('seedPercent', seedPercent + '%');
    updateElement('fertilizerDisplay', '‚Çπ' + fertilizer.toLocaleString('en-IN'));
    updateElement('fertilizerPercent', fertilizerPercent + '%');
    updateElement('pesticideDisplay', '‚Çπ' + pesticide.toLocaleString('en-IN'));
    updateElement('pesticidePercent', pesticidePercent + '%');
    updateElement('irrigationDisplay', '‚Çπ' + irrigation.toLocaleString('en-IN'));
    updateElement('irrigationPercent', irrigationPercent + '%');
    updateElement('laborDisplay', '‚Çπ' + labor.toLocaleString('en-IN'));
    updateElement('laborPercent', laborPercent + '%');
    updateElement('machineryDisplay', '‚Çπ' + machinery.toLocaleString('en-IN'));
    updateElement('machineryPercent', machineryPercent + '%');
    updateElement('otherDisplay', '‚Çπ' + other.toLocaleString('en-IN'));
    updateElement('otherPercent', otherPercent + '%');
    
    // Update chart
    updateExpenseChart([seed, fertilizer, pesticide, irrigation, labor, machinery, other]);
    
    // Calculate cost per acre
    const landArea = parseFloat(document.getElementById('landArea').value) || 0;
    if (landArea > 0) {
        const perAcre = total / landArea;
        document.getElementById('costPerAcre').textContent = '‚Çπ' + perAcre.toLocaleString('en-IN', {maximumFractionDigits: 2}) + ' per acre';
        
        // Benchmark comparison
        const cropType = document.getElementById('cropType').value;
        if (cropType && cropBenchmarks[cropType]) {
            const benchmark = cropBenchmarks[cropType].total;
            const diff = perAcre - benchmark;
            const diffPercent = ((diff / benchmark) * 100).toFixed(1);
            if (diff > 0) {
                document.getElementById('benchmarkComparison').textContent = `‚Çπ${Math.abs(diff).toLocaleString('en-IN', {maximumFractionDigits: 0})} (${diffPercent}%) above average`;
                document.getElementById('benchmarkComparison').style.color = '#d32f2f';
            } else if (diff < 0) {
                document.getElementById('benchmarkComparison').textContent = `‚Çπ${Math.abs(diff).toLocaleString('en-IN', {maximumFractionDigits: 0})} (${Math.abs(diffPercent)}%) below average`;
                document.getElementById('benchmarkComparison').style.color = '#388e3c';
            } else {
                document.getElementById('benchmarkComparison').textContent = 'At average cost';
                document.getElementById('benchmarkComparison').style.color = '#1976d2';
            }
        } else {
            document.getElementById('benchmarkComparison').textContent = '';
        }
    } else {
        document.getElementById('costPerAcre').textContent = '‚Çπ0 per acre';
        document.getElementById('benchmarkComparison').textContent = '';
    }
    
    // Calculate revenue and profit
    const yieldQty = parseFloat(document.getElementById('expectedYield')?.value) || 0;
    const marketPrice = parseFloat(document.getElementById('marketPrice')?.value) || 0;
    const revenue = yieldQty * marketPrice;
    const profit = revenue - total;
    const profitMargin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
    
    console.log('Revenue calculation:', { yieldQty, marketPrice, revenue, profit, profitMargin });
    
    const revenueEl = document.getElementById('totalRevenue');
    const profitEl = document.getElementById('netProfit');
    const marginEl = document.getElementById('profitMargin');
    
    if (revenueEl) revenueEl.textContent = '‚Çπ' + revenue.toLocaleString('en-IN');
    if (profitEl) profitEl.textContent = '‚Çπ' + profit.toLocaleString('en-IN');
    if (marginEl) marginEl.textContent = `Profit Margin: ${profitMargin}%`;
    
    // Update profit card color
    const profitCard = document.getElementById('profitCard');
    if (profitCard) {
        if (profit > 0) {
            profitCard.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
        } else if (profit < 0) {
            profitCard.style.background = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
        } else {
            profitCard.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
        }
    }
    
    // Calculate break-even price
    if (yieldQty > 0) {
        const minPrice = total / yieldQty;
        updateElement('minPrice', '‚Çπ' + minPrice.toLocaleString('en-IN', {maximumFractionDigits: 2}) + ' per quintal');
    } else {
        updateElement('minPrice', '‚Çπ0 per quintal');
    }
    
    // Calculate break-even quantity
    if (marketPrice > 0) {
        const breakEvenQty = total / marketPrice;
        updateElement('breakEvenQty', breakEvenQty.toLocaleString('en-IN', {maximumFractionDigits: 2}) + ' quintals');
    } else {
        updateElement('breakEvenQty', '0 quintals');
    }
}

function updateExpenseChart(data) {
    const ctx = document.getElementById('expenseChart');
    if (!ctx) {
        console.log('Canvas element not found');
        return;
    }
    
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        return;
    }
    
    if (expenseChart) {
        expenseChart.destroy();
    }
    
    try {
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Seeds', 'Fertilizers', 'Pesticides', 'Irrigation', 'Labor', 'Machinery', 'Other'],
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#4caf50', '#2196f3', '#ff9800', '#00bcd4', 
                        '#9c27b0', '#f44336', '#607d8b'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ‚Çπ${value.toLocaleString('en-IN')} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

function calculateLoan() {
    const principal = parseFloat(document.getElementById('loanAmount').value) || 0;
    const annualRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const months = parseFloat(document.getElementById('loanPeriod').value) || 0;
    
    if (principal > 0 && annualRate > 0 && months > 0) {
        const monthlyRate = (annualRate / 12) / 100;
        const emi = (principal * monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
        const totalAmount = emi * months;
        const totalInterest = totalAmount - principal;
        
        document.getElementById('monthlyEMI').textContent = '‚Çπ' + emi.toLocaleString('en-IN', {maximumFractionDigits: 0});
        document.getElementById('totalInterest').textContent = '‚Çπ' + totalInterest.toLocaleString('en-IN', {maximumFractionDigits: 0});
        document.getElementById('totalAmount').textContent = '‚Çπ' + totalAmount.toLocaleString('en-IN', {maximumFractionDigits: 0});
    } else {
        document.getElementById('monthlyEMI').textContent = '‚Çπ0';
        document.getElementById('totalInterest').textContent = '‚Çπ0';
        document.getElementById('totalAmount').textContent = '‚Çπ0';
    }
}

function saveExpenseEntry() {
    const entry = {
        date: document.getElementById('entryDate').value,
        cropType: document.getElementById('cropType').value,
        season: document.getElementById('seasonType').value,
        expenses: {
            seed: parseFloat(document.getElementById('seedCost').value) || 0,
            fertilizer: parseFloat(document.getElementById('fertilizerCost').value) || 0,
            pesticide: parseFloat(document.getElementById('pesticideCost').value) || 0,
            irrigation: parseFloat(document.getElementById('irrigationCost').value) || 0,
            labor: parseFloat(document.getElementById('laborCost').value) || 0,
            machinery: parseFloat(document.getElementById('machineryCost').value) || 0,
            other: parseFloat(document.getElementById('otherCost').value) || 0
        },
        landArea: parseFloat(document.getElementById('landArea').value) || 0,
        expectedYield: parseFloat(document.getElementById('expectedYield').value) || 0,
        marketPrice: parseFloat(document.getElementById('marketPrice').value) || 0
    };
    
    const total = Object.values(entry.expenses).reduce((a, b) => a + b, 0);
    entry.total = total;
    entry.revenue = entry.expectedYield * entry.marketPrice;
    entry.profit = entry.revenue - total;
    
    expenseHistory.push(entry);
    localStorage.setItem('farmExpenseHistory', JSON.stringify(expenseHistory));
    
    alert('‚úÖ Expense entry saved successfully!\n\nYou can view your history anytime.');
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(20);
    doc.setTextColor(45, 106, 79);
    doc.text('Farming Expense Report', 105, 20, { align: 'center' });
    
    // Date
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });
    
    // Crop and Season Info
    const cropType = document.getElementById('cropType').value || 'Not specified';
    const season = document.getElementById('seasonType').value || 'Not specified';
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text(`Crop: ${cropType.charAt(0).toUpperCase() + cropType.slice(1)}`, 20, 40);
    doc.text(`Season: ${season.charAt(0).toUpperCase() + season.slice(1)}`, 20, 47);
    
    // Expenses
    doc.setFontSize(14);
    doc.setTextColor(45, 106, 79);
    doc.text('Expense Breakdown:', 20, 60);
    
    doc.setFontSize(11);
    doc.setTextColor(0);
    let y = 70;
    
    const expenses = [
        ['Seeds & Planting', document.getElementById('seedCost').value || '0'],
        ['Fertilizers', document.getElementById('fertilizerCost').value || '0'],
        ['Pesticides', document.getElementById('pesticideCost').value || '0'],
        ['Irrigation', document.getElementById('irrigationCost').value || '0'],
        ['Labor', document.getElementById('laborCost').value || '0'],
        ['Machinery', document.getElementById('machineryCost').value || '0'],
        ['Other', document.getElementById('otherCost').value || '0']
    ];
    
    expenses.forEach(([label, value]) => {
        doc.text(label + ':', 25, y);
        doc.text('‚Çπ' + parseFloat(value).toLocaleString('en-IN'), 180, y, { align: 'right' });
        y += 8;
    });
    
    // Total
    doc.setDrawColor(45, 106, 79);
    doc.line(20, y, 190, y);
    y += 8;
    doc.setFontSize(13);
    doc.setFont(undefined, 'bold');
    doc.text('Total Expenses:', 25, y);
    doc.text(document.getElementById('totalExpense').textContent, 180, y, { align: 'right' });
    
    // Revenue and Profit
    y += 15;
    doc.setFontSize(14);
    doc.setTextColor(45, 106, 79);
    doc.text('Financial Summary:', 20, y);
    
    y += 10;
    doc.setFontSize(11);
    doc.setTextColor(0);
    doc.setFont(undefined, 'normal');
    
    doc.text('Land Area:', 25, y);
    doc.text((document.getElementById('landArea').value || '0') + ' acres', 180, y, { align: 'right' });
    y += 8;
    
    doc.text('Expected Yield:', 25, y);
    doc.text((document.getElementById('expectedYield').value || '0') + ' quintals', 180, y, { align: 'right' });
    y += 8;
    
    doc.text('Market Price:', 25, y);
    doc.text('‚Çπ' + (parseFloat(document.getElementById('marketPrice').value) || 0).toLocaleString('en-IN') + '/quintal', 180, y, { align: 'right' });
    y += 8;
    
    doc.text('Total Revenue:', 25, y);
    doc.text(document.getElementById('totalRevenue').textContent, 180, y, { align: 'right' });
    y += 8;
    
    doc.setFont(undefined, 'bold');
    doc.text('Net Profit:', 25, y);
    doc.text(document.getElementById('netProfit').textContent, 180, y, { align: 'right' });
    
    // Footer
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.setFont(undefined, 'normal');
    doc.text('Smart Farming Assistant - Your Digital Agriculture Partner', 105, 280, { align: 'center' });
    
    // Save
    doc.save(`farming-expense-report-${new Date().toISOString().split('T')[0]}.pdf`);
    alert('üìÑ PDF report generated successfully!');
}

function resetCalculator() {
    document.getElementById('cropType').value = '';
    document.getElementById('seasonType').value = 'kharif';
    document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('seedCost').value = '';
    document.getElementById('fertilizerCost').value = '';
    document.getElementById('pesticideCost').value = '';
    document.getElementById('irrigationCost').value = '';
    document.getElementById('laborCost').value = '';
    document.getElementById('machineryCost').value = '';
    document.getElementById('otherCost').value = '';
    document.getElementById('landArea').value = '';
    document.getElementById('expectedYield').value = '';
    document.getElementById('marketPrice').value = '';
    document.getElementById('loanAmount').value = '';
    document.getElementById('interestRate').value = '7';
    document.getElementById('loanPeriod').value = '12';
    loadBenchmarkData();
    calculateTotal();
    calculateLoan();
}


async function getCurrentLocationWeather() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }
    
    const weatherResult = document.getElementById('weatherResult');
    const weatherError = document.getElementById('weatherError');
    
    // Show loading state
    weatherError.style.display = 'none';
    weatherResult.style.display = 'none';
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            const apiKey = 'f4f904e64c374434a87104606252811';
            const url = `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${lat},${lon}&aqi=no`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.location) {
                    displayWeatherData(data);
                } else {
                    weatherResult.style.display = 'none';
                    weatherError.style.display = 'block';
                }
            } catch (error) {
                console.error('Weather fetch error:', error);
                weatherResult.style.display = 'none';
                weatherError.style.display = 'block';
            }
        },
        (error) => {
            let errorMsg = 'Unable to get your location. ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg += 'Location access denied. Please enable location permissions.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg += 'Location information unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMsg += 'Location request timed out.';
                    break;
            }
            alert(errorMsg);
        }
    );
}

function displayWeatherData(data) {
    document.getElementById('weatherResult').style.display = 'block';
    document.getElementById('weatherError').style.display = 'none';
    
    // Update weather information
    document.getElementById('temperature').textContent = `${Math.round(data.current.temp_c)}¬∞C`;
    document.getElementById('weatherDescription').textContent = data.current.condition.text;
    document.getElementById('cityName').textContent = `${data.location.name}, ${data.location.country}`;
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    document.getElementById('humidity').textContent = `${data.current.humidity}%`;
    document.getElementById('windSpeed').textContent = `${Math.round(data.current.wind_kph)} km/h`;
    document.getElementById('feelsLike').textContent = `${Math.round(data.current.feelslike_c)}¬∞C`;
    document.getElementById('pressure').textContent = `${data.current.pressure_mb} hPa`;
    document.getElementById('visibility').textContent = `${data.current.vis_km} km`;
    document.getElementById('clouds').textContent = `${data.current.cloud}%`;
    
    // Update weather icon based on condition
    const condition = data.current.condition.text.toLowerCase();
    let weatherEmoji = 'üå§Ô∏è';
    if (condition.includes('sunny') || condition.includes('clear')) {
        weatherEmoji = data.current.is_day ? '‚òÄÔ∏è' : 'üåô';
    } else if (condition.includes('cloud')) {
        weatherEmoji = '‚òÅÔ∏è';
    } else if (condition.includes('rain')) {
        weatherEmoji = 'üåßÔ∏è';
    } else if (condition.includes('thunder') || condition.includes('storm')) {
        weatherEmoji = '‚õàÔ∏è';
    } else if (condition.includes('snow')) {
        weatherEmoji = '‚ùÑÔ∏è';
    } else if (condition.includes('mist') || condition.includes('fog')) {
        weatherEmoji = 'üå´Ô∏è';
    } else if (condition.includes('partly cloudy')) {
        weatherEmoji = '‚õÖ';
    }
    document.getElementById('weatherIcon').textContent = weatherEmoji;
    
    // Generate farming advice
    const temp = data.current.temp_c;
    const humidity = data.current.humidity;
    const rain = condition.includes('rain');
    
    let advice = '';
    if (rain) {
        advice = 'Rainy conditions detected. Avoid irrigation and pesticide spraying. Good time for transplanting rice. Check for waterlogging in fields.';
    } else if (temp > 35) {
        advice = 'High temperature! Ensure adequate irrigation. Monitor crops for heat stress. Best time for summer crops like cucumber, watermelon.';
    } else if (temp < 15) {
        advice = 'Cool weather. Good for winter crops like wheat, mustard, peas. Protect sensitive crops from frost.';
    } else if (humidity > 80) {
        advice = 'High humidity may increase disease risk. Monitor for fungal diseases. Ensure good air circulation. Avoid over-irrigation.';
    } else if (humidity < 40) {
        advice = 'Low humidity detected. Increase irrigation frequency. Mulching recommended to retain soil moisture.';
    } else {
        advice = 'Favorable conditions for most crops. Good time for field operations like sowing, weeding, and spraying.';
    }
    
    document.getElementById('farmingAdvice').textContent = advice;
}

async function getWeather() {
    const city = document.getElementById('cityInput').value.trim();
    if (!city) {
        alert('Please enter a city name');
        return;
    }
    
    const apiKey = 'f4f904e64c374434a87104606252811'; // WeatherAPI key
    const url = `https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${city}&aqi=no`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.location) {
            displayWeatherData(data);
        } else {
            document.getElementById('weatherResult').style.display = 'none';
            document.getElementById('weatherError').style.display = 'block';
        }
    } catch (error) {
        console.error('Weather fetch error:', error);
        document.getElementById('weatherResult').style.display = 'none';
        document.getElementById('weatherError').style.display = 'block';
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const profileModal = document.getElementById('profileModal');
    const schemesModal = document.getElementById('govtSchemesModal');
    const calculatorModal = document.getElementById('calculatorModal');
    const manualModal = document.getElementById('manualModal');
    const weatherModal = document.getElementById('weatherModal');
    if (event.target == profileModal) {
        profileModal.style.display = 'none';
    }
    if (event.target == schemesModal) {
        schemesModal.style.display = 'none';
    }
    if (event.target == calculatorModal) {
        calculatorModal.style.display = 'none';
    }
    if (event.target == manualModal) {
        manualModal.style.display = 'none';
    }
    if (event.target == weatherModal) {
        weatherModal.style.display = 'none';
    }
};

// Delete growing activity
function deleteActivity(activityId) {
    if (confirm('Are you sure you want to delete this growing activity?')) {
        fetch(`/growing/delete/${activityId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the activity element with animation
                const activityElement = document.getElementById(`activity-${activityId}`);
                if (activityElement) {
                    activityElement.style.opacity = '0';
                    activityElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                } else {
                    location.reload();
                }
            } else {
                alert('Failed to delete activity: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Error deleting activity. Please try again.');
        });
    }
}

// Delete fertilizer recommendation
function deleteFertilizer(fertilizerId) {
    if (confirm('Are you sure you want to delete this fertilizer recommendation?')) {
        fetch(`/fertilizer/delete/${fertilizerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the fertilizer element with animation
                const fertElement = document.getElementById(`fertilizer-${fertilizerId}`);
                if (fertElement) {
                    fertElement.style.opacity = '0';
                    fertElement.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                } else {
                    location.reload();
                }
            } else {
                alert('Failed to delete fertilizer: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Error deleting fertilizer. Please try again.');
        });
    }
}
// Chatbot Functions
let chatHistory = [];

function openChatbotModal() {
    document.getElementById('chatbotModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Focus on input
    setTimeout(() => {
        document.getElementById('chatInput').focus();
    }, 300);
}

function closeChatbotModal() {
    document.getElementById('chatbotModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    input.value = '';
    
    // Hide suggestions after first message
    document.getElementById('suggestedQuestions').style.display = 'none';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to Gemini API backend
    fetch('/chat/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: message,
            history: chatHistory
        })
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.success) {
            addMessage(data.response, 'bot');
        } else {
            addMessage('Sorry, I encountered an error. Please try again. üòî', 'bot');
            console.error('Chat error:', data.error);
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('Chat request failed:', error);
        addMessage('Sorry, I could not connect to the server. Please check your internet connection. üîå', 'bot');
    });
}

function sendSuggestion(suggestion) {
    document.getElementById('chatInput').value = suggestion;
    sendMessage();
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
    
    const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-bubble user-bubble">
                <p>${escapeHtml(text)}</p>
                <span class="message-time">${timestamp}</span>
            </div>
            <div class="message-avatar">üë§</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-bubble bot-bubble">
                <p>${formatBotResponse(text)}</p>
                <span class="message-time">${timestamp}</span>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Add to history
    chatHistory.push({ text, sender, timestamp });
}

function showTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'bot-message typing-indicator-message';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

function formatBotResponse(text) {
    // Convert newlines to <br>
    text = text.replace(/\n/g, '<br>');
    
    // Convert bullet points
    text = text.replace(/‚Ä¢/g, '‚ñ∏');
    
    return text;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Close chatbot when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('chatbotModal');
    if (event.target === modal) {
        closeChatbotModal();
    }
});

</script>
{% endblock %}
