{% extends "base.html" %}

{% block title %}Crop Suggestion - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/crop.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <span class="logo-icon">üåæ</span>
                <span class="logo-text">Farming Assistant</span>
            </div>
            <p class="subtitle">Smart Agriculture Platform</p>
        </div>
        
        <div class="welcome-section">
            <p class="welcome-label">Welcome back,</p>
            <h3 class="welcome-name">{{ user_name or "Farmer" }}! üëã</h3>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-item active">
                <span class="nav-icon">üå±</span>
                <span class="nav-text">Crop Suggestion</span>
            </a>
            <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-item">
                <span class="nav-icon">üß™</span>
                <span class="nav-text">Fertilizer Advice</span>
            </a>
            <a href="{{ url_for('market.market_watch') }}" class="nav-item">
                <span class="nav-icon">üìà</span>
                <span class="nav-text">Market Watch</span>
            </a>
        </nav>
    </div>

    <!-- Green Header Section -->
    <div class="dashboard-header">        
        <div class="header-content">
            <div class="header-left">
                <h1>AI-Powered Crop Recommendation</h1>
                <p>Get scientific crop suggestions based on soil nutrients and climate conditions</p>
            </div>
            <div class="header-right">
                <span class="header-date">üìÖ Today, {{ current_date or "2024" }}</span>
                <button class="logout-button" onclick="window.location.href='{{ url_for('auth.logout') }}'">Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Content Panel -->
        <div class="content-panel">
            <!-- Crop Recommendation Form -->
            <div class="crop-form-container">
                <div class="form-header">
                    <div class="icon-wrapper">
                        <span class="filter-icon">üîª</span>
                    </div>
                    <div class="form-title">
                        <h2>Smart Crop Recommendation System</h2>
                        <p>Enter your soil nutrient levels and environmental conditions to get AI-powered crop recommendations</p>
                    </div>
                </div>

                <form method="POST" class="crop-form">
                    <div class="form-sections">
                        <!-- Soil Nutrients Section -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <span class="section-icon">üß™</span>
                                Soil Nutrients (mg/kg)
                            </h3>
                            <div class="input-grid">
                                <div class="input-group">
                                    <label for="nitrogen">Nitrogen (N):</label>
                                    <input type="number" id="nitrogen" name="nitrogen" placeholder="80" step="0.01" required value="{{ input_data.nitrogen if input_data else '' }}">
                                    <small>Range: 0-140 mg/kg (Avg: 80)</small>
                                </div>
                                
                                <div class="input-group">
                                    <label for="phosphorous">Phosphorus (P):</label>
                                    <input type="number" id="phosphorous" name="phosphorous" placeholder="60" step="0.01" required value="{{ input_data.phosphorous if input_data else '' }}">
                                    <small>Range: 5-145 mg/kg (Avg: 60)</small>
                                </div>
                                
                                <div class="input-group">
                                    <label for="potassium">Potassium (K):</label>
                                    <input type="number" id="potassium" name="potassium" placeholder="40" step="0.01" required value="{{ input_data.potassium if input_data else '' }}">
                                    <small>Range: 5-205 mg/kg (Avg: 40)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Environmental Conditions Section -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <span class="section-icon">üå°Ô∏è</span>
                                Environmental Conditions
                            </h3>
                            <div class="input-grid">
                                <div class="input-group">
                                    <label for="temperature">Temperature:</label>
                                    <input type="number" id="temperature" name="temperature" placeholder="25" step="0.01" required value="{{ input_data.temperature if input_data else '' }}">
                                    <small>Range: 8-44¬∞C (Avg: 26¬∞C)</small>
                                </div>
                                
                                <div class="input-group">
                                    <label for="humidity">Humidity:</label>
                                    <input type="number" id="humidity" name="humidity" placeholder="70" step="0.01" min="0" max="100" required value="{{ input_data.humidity if input_data else '' }}">
                                    <small>Range: 14-100% (Avg: 70%)</small>
                                </div>
                                
                                <div class="input-group">
                                    <label for="ph">Soil pH Level:</label>
                                    <input type="number" id="ph" name="ph" placeholder="6.5" step="0.01" min="0" max="14" required value="{{ input_data.ph if input_data else '' }}">
                                    <small>Range: 3.5-9.9 (Avg: 6.5)</small>
                                </div>
                                
                                <div class="input-group">
                                    <label for="rainfall">Annual Rainfall:</label>
                                    <input type="number" id="rainfall" name="rainfall" placeholder="100" step="0.01" required value="{{ input_data.rainfall if input_data else '' }}">
                                    <small>Range: 20-300mm (Avg: 100mm)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-btn">
                            üîª Get AI Crop Recommendations
                        </button>
                    </div>
                </form>
            </div>

            <!-- CONDITIONAL RESULTS SECTION - Only shows after form submission -->
            {% if recommendations %}
            <div class="crop-results-section">
                <div class="results-header">
                    <div class="header-icon">
                        <span class="filter-icon">üîª</span>
                    </div>
                    <div class="header-content">
                        <h2>üéØ AI-Powered Crop Recommendations</h2>
                        <p>Based on your soil analysis: N={{input_data.nitrogen}}, P={{input_data.phosphorous}}, K={{input_data.potassium}}, Temp={{input_data.temperature}}¬∞C, pH={{input_data.ph}}</p>
                    </div>
                </div>

                <div class="crop-cards-grid">
                    {% for crop in recommendations %}
                    <div class="crop-card {{ 'high-priority' if crop.priority == 'High' else 'medium-priority' if crop.priority == 'Medium' else 'low-priority' }}">
                        <div class="crop-header">
                            <h3>{{ crop.name }}</h3>
                            <span class="priority-badge {{ crop.priority.lower() }}">{{ crop.priority }} Priority</span>
                        </div>
                        
                        <div class="crop-details">
                            <div class="detail-item">
                                <span class="icon">üéØ</span>
                                <span class="label">Suitability:</span>
                                <span class="value">{{ "%.1f"|format(crop.confidence_percentage) }}%</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="icon">üå°Ô∏è</span>
                                <span class="label">Temperature:</span>
                                <span class="value">
                                    {% if crop.name.lower() == 'rice' %}20-30¬∞C (Optimum)
                                    {% elif crop.name.lower() == 'wheat' %}15-25¬∞C (Cool Season)
                                    {% elif crop.name.lower() == 'maize' %}20-30¬∞C (Warm Season)
                                    {% elif crop.name.lower() == 'cotton' %}21-27¬∞C (Moderate)
                                    {% elif crop.name.lower() == 'jute' %}24-37¬∞C (Hot & Humid)
                                    {% elif crop.name.lower() == 'banana' %}26-30¬∞C (Tropical)
                                    {% else %}20-30¬∞C (Suitable)
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="icon">üíß</span>
                                <span class="label">Water Need:</span>
                                <span class="value">
                                    {% if crop.name.lower() in ['rice', 'jute'] %}High
                                    {% elif crop.name.lower() in ['wheat', 'maize'] %}Moderate  
                                    {% elif crop.name.lower() == 'cotton' %}Low-Moderate
                                    {% else %}Moderate
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="icon">üåßÔ∏è</span>
                                <span class="label">Rainfall:</span>
                                <span class="value">
                                    {% if crop.name.lower() == 'rice' %}1000-2000mm
                                    {% elif crop.name.lower() == 'wheat' %}500-800mm
                                    {% elif crop.name.lower() == 'maize' %}600-1000mm
                                    {% elif crop.name.lower() == 'cotton' %}500-1000mm
                                    {% elif crop.name.lower() == 'jute' %}1200-1500mm
                                    {% elif crop.name.lower() == 'banana' %}1200-2500mm
                                    {% else %}600-1200mm
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="icon">‚è±Ô∏è</span>
                                <span class="label">Duration:</span>
                                <span class="value">
                                    {% if crop.name.lower() == 'rice' %}120-180 days
                                    {% elif crop.name.lower() == 'wheat' %}120-150 days
                                    {% elif crop.name.lower() == 'maize' %}90-120 days
                                    {% elif crop.name.lower() == 'cotton' %}180-200 days
                                    {% elif crop.name.lower() == 'jute' %}120-150 days
                                    {% elif crop.name.lower() == 'banana' %}9-12 months
                                    {% else %}120-150 days
                                    {% endif %}
                                </span>
                            </div>

                            <div class="detail-item">
                                <span class="icon">üî¨</span>
                                <span class="label">Soil pH:</span>
                                <span class="value">
                                    {% if crop.name.lower() == 'rice' %}6.0-7.5
                                    {% elif crop.name.lower() == 'wheat' %}6.0-7.5
                                    {% elif crop.name.lower() == 'maize' %}6.0-7.0
                                    {% elif crop.name.lower() == 'cotton' %}5.8-8.0
                                    {% elif crop.name.lower() == 'jute' %}6.0-7.5
                                    {% elif crop.name.lower() == 'banana' %}6.5-7.5
                                    {% else %}6.0-7.5
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        {% if crop.priority == 'High' %}
                        <div class="growing-conditions">
                            <h4>‚ú® Why This Crop is Recommended</h4>
                            <ul>
                                <li>üéØ Perfect match for your soil conditions</li>
                                <li>üå°Ô∏è Optimal temperature range for your region</li>
                                <li>üíß Suitable for your humidity levels</li>
                                <li>üåßÔ∏è Rainfall requirements align with your area</li>
                                <li>üî¨ Soil pH is within ideal range</li>
                                <li>üìà High probability of successful yield</li>
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="card-actions">
                            <button class="btn-outline" onclick="viewDetails('{{ crop.name.lower() }}')">üìÑ Details</button>
                            <button class="btn-start" onclick="startGrowing('{{ crop.name }}', {{ crop.probability }})">üå± Start Growing</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Summary Section -->
                <div class="recommendation-summary">
                    <div class="summary-card">
                        <h3>üìä Recommendation Summary</h3>
                        <div class="summary-stats">
                            <div class="stat">
                                <span class="stat-value">{{ recommendations|selectattr('priority', 'equalto', 'High')|list|length }}</span>
                                <span class="stat-label">High Priority Crops</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">{{ recommendations[0].name if recommendations else 'N/A' }}</span>
                                <span class="stat-label">Top Recommendation</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value">{{ "%.0f"|format(recommendations[0].confidence_percentage) if recommendations else '0' }}%</span>
                                <span class="stat-label">Confidence Score</span>
                            </div>
                        </div>
                        <p class="summary-text">
                            üéØ Based on your soil analysis, <strong>{{ recommendations[0].name if recommendations else 'N/A' }}</strong> 
                            shows the highest compatibility with {{ "%.1f"|format(recommendations[0].confidence_percentage) if recommendations else '0' }}% confidence.
                            Consider the soil preparation and seasonal timing for optimal results.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- END CONDITIONAL RESULTS SECTION -->
        </div>
    </div>
</div>

<script>
function startGrowing(cropName, probability) {
    // Redirect to start growing page
    window.location.href = `/growing/start/${cropName.toLowerCase()}`;
}

function viewDetails(cropName) {
    // Create a detailed modal or redirect to details page
    const details = {
        'rice': 'Rice is a staple crop requiring high water availability and warm temperatures. Best grown in flooded fields.',
        'wheat': 'Wheat is a cool season crop that requires moderate rainfall and well-drained soil.',
        'maize': 'Maize (corn) is a warm season crop with moderate water needs and good drought tolerance.',
        'cotton': 'Cotton requires warm temperatures, moderate rainfall, and well-drained soil for optimal fiber production.',
        'jute': 'Jute thrives in hot, humid conditions with high rainfall and clay-loam soil.',
        'banana': 'Banana requires tropical climate with high humidity and consistent water supply.'
    };
    
    alert(`üåæ ${cropName.toUpperCase()} DETAILS:\n\n${details[cropName] || 'Detailed information not available for this crop.'}`);
}

// Form validation
document.querySelector('.crop-form').addEventListener('submit', function(e) {
    const inputs = this.querySelectorAll('input[required]');
    let valid = true;
    
    inputs.forEach(input => {
        if (!input.value || isNaN(input.value)) {
            input.style.borderColor = '#e74c3c';
            valid = false;
        } else {
            input.style.borderColor = '';
        }
    });
    
    if (!valid) {
        e.preventDefault();
        alert('‚ö†Ô∏è Please fill in all required fields with valid numbers.');
    }
});
</script>
{% endblock %}
